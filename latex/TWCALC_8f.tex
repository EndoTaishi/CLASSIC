\hypertarget{TWCALC_8f}{}\section{T\+W\+C\+A\+L\+C.\+f File Reference}
\label{TWCALC_8f}\index{T\+W\+C\+A\+L\+C.\+f@{T\+W\+C\+A\+L\+C.\+f}}


Check for freezing or thawing of liquid or frozen water in the soil layers, and adjust layer temperatures and water stores accordingly.  


\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \hyperlink{TWCALC_8f_a70ccee2822c2cc573ae3aca26942288a}{twcalc} (T\+B\+A\+R, T\+H\+L\+I\+Q, T\+H\+I\+C\+E, H\+C\+P, T\+B\+A\+R\+W, H\+M\+F\+G, H\+T\+C, F\+I, E\+V\+A\+P, T\+H\+P\+O\+R, T\+H\+L\+M\+I\+N, H\+C\+P\+S, D\+E\+L\+Z\+W, D\+E\+L\+Z\+Z, I\+S\+A\+N\+D, I\+G, I\+L\+G, I\+L1, I\+L2, J\+L)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Check for freezing or thawing of liquid or frozen water in the soil layers, and adjust layer temperatures and water stores accordingly. 



\subsection{Function/\+Subroutine Documentation}
\hypertarget{TWCALC_8f_a70ccee2822c2cc573ae3aca26942288a}{}\index{T\+W\+C\+A\+L\+C.\+f@{T\+W\+C\+A\+L\+C.\+f}!twcalc@{twcalc}}
\index{twcalc@{twcalc}!T\+W\+C\+A\+L\+C.\+f@{T\+W\+C\+A\+L\+C.\+f}}
\subsubsection[{twcalc}]{\setlength{\rightskip}{0pt plus 5cm}subroutine twcalc (
\begin{DoxyParamCaption}
\item[{real, dimension  (ilg,ig)}]{T\+B\+A\+R, }
\item[{real, dimension (ilg,ig)}]{T\+H\+L\+I\+Q, }
\item[{real, dimension (ilg,ig)}]{T\+H\+I\+C\+E, }
\item[{real, dimension   (ilg,ig)}]{H\+C\+P, }
\item[{real, dimension (ilg,ig)}]{T\+B\+A\+R\+W, }
\item[{real, dimension  (ilg,ig)}]{H\+M\+F\+G, }
\item[{real, dimension   (ilg,ig)}]{H\+T\+C, }
\item[{real, dimension    (ilg)}]{F\+I, }
\item[{real, dimension  (ilg)}]{E\+V\+A\+P, }
\item[{real, dimension (ilg,ig)}]{T\+H\+P\+O\+R, }
\item[{real, dimension(ilg,ig)}]{T\+H\+L\+M\+I\+N, }
\item[{real, dimension  (ilg,ig)}]{H\+C\+P\+S, }
\item[{real, dimension (ilg,ig)}]{D\+E\+L\+Z\+W, }
\item[{real, dimension (ilg,ig)}]{D\+E\+L\+Z\+Z, }
\item[{integer, dimension (ilg,ig)}]{I\+S\+A\+N\+D, }
\item[{integer}]{I\+G, }
\item[{integer}]{I\+L\+G, }
\item[{integer}]{I\+L1, }
\item[{integer}]{I\+L2, }
\item[{integer}]{J\+L}
\end{DoxyParamCaption}
)}\label{TWCALC_8f_a70ccee2822c2cc573ae3aca26942288a}

\begin{DoxyParams}{Parameters}
{\em tbar} & Temperature of soil layer $[C] (T_g)$\\
\hline
{\em thliq} & Volumetric liquid water content of soil layer $[m^3 m^{-3}] (\theta_l)$\\
\hline
{\em thice} & Volumetric frozen water content of soil layer $[m^3 m^{-3}] (\theta_i)$\\
\hline
{\em hcp} & Heat capacity of soil layer $[J m^{-3} K^{-1}] (C_g)$\\
\hline
{\em tbarw} & Temperature of water in soil layer \mbox{[}C\mbox{]}\\
\hline
{\em hmfg} & Energy associated with freezing or thawing of water in soil layer $[W m^{-2}]$\\
\hline
{\em htc} & Internal energy change of soil layer due to conduction and/or change in mass $[W m^{-2}] (I_g)$\\
\hline
{\em fi} & Fractional coverage of subarea in question on modelled area $[ ] (X_i)$\\
\hline
{\em evap} & Calculated evaporation rate from soil surface $[m s^{-1}]$\\
\hline
{\em thpor} & Pore volume in soil layer $[mm] (\theta_p)$\\
\hline
{\em thlmin} & Residual soil liquid water content remaining after freezing or evaporation $[m^3 m^{-3}] (\theta_r)$\\
\hline
{\em hcps} & Heat capacity of soil material $[J m^{-3} K^{-1}] (C_m)$\\
\hline
{\em delzw} & Permeable thickness of soil layer $[m] (\Delta z_{g,w})$\\
\hline
{\em delzz} & Soil layer thicknesses to bottom of permeable depth for standard three-\/layer configuration, or to bottom of thermal depth for multiple layers $[m] (\Delta z_{g,z})$\\
\hline
{\em isand} & Sand content flag \\
\hline
\end{DoxyParams}
The adjustments of soil layer temperature and water content in this routine are done over the whole soil profile in the case of multiple soil layers (see the section on assignment of background data), but only to the bottom of the permeable depth in the case of the standard three-\/layer configuration (0.\+10, 0.\+25 and 3.\+75 m). This is because if the permeable depth lies within the thick third soil layer, it is recognized as desirable to apply the temperature changes only to that upper part of the layer in which the phase change is occurring, in order to avoid systematic damping of the temperature response of the layer. Thus the local array D\+E\+L\+Z\+Z (set in subroutine W\+P\+R\+E\+P) is used here instead of D\+E\+L\+Z when referring to the total thermal thickness of the soil layer, where D\+E\+L\+Z\+Z=D\+E\+L\+Z\+W for the third soil layer when the three-\/layer configuration is being used, but D\+E\+L\+Z\+Z=D\+E\+L\+Z for all other cases.

The heat capacity $C_g$ of the permeable part $\Delta z_{g,w}$ of the soil layer under consideration is calculated here and in various other places in the subroutine as the weighted average of the heat capacities of the liquid water content $\theta_l$, the frozen water content $\theta_i$, and the soil material (taken to apply to the volume fraction not occupied by the pore volume $\theta_p$). The heat capacity of air in the pores is neglected\+:

$C_g = C_w \theta_l + C_i \theta_i + C_m (1 - \theta_p)$

Over the impermeable portion of the layer, the heat capacity of rock $C_r$ is assumed to apply. Thus an effective heat capacity $C_{g,e}$ (in units of $J m^{-2} K^{-1}$) over the soil layer in question, $\Delta z_{g,z}$, can be calculated as\+:

$C_{g,e} = C_g \Delta z_{g,w} + C_r(\Delta z_{g,z} - \Delta z_{g,w})$

The change of internal energy I in the soil layers as a result of freezing and thawing is calculated as the difference in I between the beginning and end of the subroutine\+:

$\Delta I_j = X_i \Delta (C_{g,e} T_g)/\Delta t$

where $T_g$ is the temperature of the layer, $\Delta t$ the length of the time step, and $X_i$ the fractional coverage of the subarea under consideration relative to the modelled area.

If the soil layer temperature is less than 0 C and the volumetric liquid water content $\theta_l$ of the layer is greater than the residual water content $\theta_f$, the water content T\+H\+F\+R\+E\+Z that can be frozen by the available energy sink is calculated from $C_e$ and $T_g$. The volumetric water content T\+H\+E\+V\+A\+P of the first layer that is required to satisfy the surface evaporative flux is determined. For each layer, if T\+H\+L\+I\+Q is found to exceed T\+H\+L\+M\+I\+N + T\+H\+E\+V\+A\+P, T\+H\+F\+R\+E\+Z is compared to the available water. If T\+H\+F\+R\+E\+Z $\leq$ T\+H\+L\+I\+Q – T\+H\+L\+M\+I\+N – T\+H\+E\+V\+A\+P, all of the available energy sink is used to freeze part of the liquid water content in the permeable part of the soil layer, the amount of energy involved is subtracted from H\+T\+C and added to H\+M\+F\+G, $C_g$ is recalculated and the layer temperature is set to 0 C. Otherwise, all of the liquid water content of the layer above T\+H\+L\+M\+I\+N + T\+H\+E\+V\+A\+P is converted to frozen water, and H\+M\+F\+G and H\+T\+C are recalculated to reflect this. Then $C_g$ is recomputed, and the remaining energy sink is applied to decreasing the temperature of the soil layer (both the permeable and impermeable portions) using $C_e$.

If the soil layer temperature is greater than 0 C and the volumetric ice content $\theta_i$ of the layer is greater than zero, the ice content T\+H\+M\+E\+L\+T that can be melted by the available energy is calculated from $C_e$ and $T_g$. For each layer, if T\+H\+M\+E\+L\+T $\leq$ T\+H\+I\+C\+E, all of the available energy is used to melt part of the frozen water content of the permeable part of the layer, the amount of energy involved is subtracted from H\+T\+C and added to H\+M\+F\+G, $C_g$ is recalculated and the layer temperature is set to 0 C. Otherwise, all of the frozen water content of the layer is converted to liquid water, and H\+M\+F\+G and H\+T\+C are recalculated to reflect this. Then $C_g$ is recomputed, and the remaining energy is applied to increasing the temperature of the soil layer (both the permeable and impermeable portions) using $C_e$.

In the final cleanup, the internal energy calculations for this subroutine are completed, and the first half of a new set of internal energy calculations is done to span the subroutines treating ground water movement, which will be completed in subroutine T\+M\+C\+A\+L\+C. Lastly, T\+B\+A\+R\+W, the liquid water temperature of each soil layer, is assigned using T\+B\+A\+R.

Here is the caller graph for this function\+:
% FIG 0


