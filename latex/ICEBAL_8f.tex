\hypertarget{ICEBAL_8f}{}\section{I\+C\+E\+B\+A\+L.\+f File Reference}
\label{ICEBAL_8f}\index{I\+C\+E\+B\+A\+L.\+f@{I\+C\+E\+B\+A\+L.\+f}}


Purpose\+: Perform temperature stepping and surface runoff calculations over ice sheets.  


\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \hyperlink{ICEBAL_8f_abefb862d3860a7222b2eaa981efb2701}{icebal} (T\+B\+A\+R, T\+P\+O\+N\+D, Z\+P\+O\+N\+D, T\+S\+N\+O\+W, R\+H\+O\+S\+N\+O, Z\+S\+N\+O\+W, H\+C\+P\+S\+N\+O, A\+L\+B\+S\+N\+O, H\+M\+F\+G, H\+T\+C\+S, H\+T\+C, W\+T\+R\+S, W\+T\+R\+G, G\+F\+L\+U\+X, R\+U\+N\+O\+F\+F, T\+R\+U\+N\+O\+F, O\+V\+R\+F\+L\+W, T\+O\+V\+R\+F\+L, Z\+P\+L\+I\+M, G\+G\+E\+O, F\+I, E\+V\+A\+P, R, T\+R, G\+Z\+E\+R\+O, G12, G23, H\+C\+P, Q\+M\+E\+L\+T, W\+S\+N\+O\+W, Z\+M\+A\+T, T\+M\+O\+V\+E, W\+M\+O\+V\+E, Z\+R\+M\+D\+R, T\+A\+D\+D, Z\+M\+O\+V\+E, T\+B\+O\+T, D\+E\+L\+Z, I\+S\+A\+N\+D, I\+C\+O\+N\+T, I\+W\+F, I\+G, I\+G\+P1, I\+G\+P2, I\+L\+G, I\+L1, I\+L2, J\+L, N)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Purpose\+: Perform temperature stepping and surface runoff calculations over ice sheets. 



\subsection{Function/\+Subroutine Documentation}
\hypertarget{ICEBAL_8f_abefb862d3860a7222b2eaa981efb2701}{}\index{I\+C\+E\+B\+A\+L.\+f@{I\+C\+E\+B\+A\+L.\+f}!icebal@{icebal}}
\index{icebal@{icebal}!I\+C\+E\+B\+A\+L.\+f@{I\+C\+E\+B\+A\+L.\+f}}
\subsubsection[{icebal}]{\setlength{\rightskip}{0pt plus 5cm}subroutine icebal (
\begin{DoxyParamCaption}
\item[{real, dimension  (ilg,ig)}]{T\+B\+A\+R, }
\item[{real, dimension (ilg)}]{T\+P\+O\+N\+D, }
\item[{real, dimension (ilg)}]{Z\+P\+O\+N\+D, }
\item[{real, dimension (ilg)}]{T\+S\+N\+O\+W, }
\item[{real, dimension(ilg)}]{R\+H\+O\+S\+N\+O, }
\item[{real, dimension (ilg)}]{Z\+S\+N\+O\+W, }
\item[{real, dimension(ilg)}]{H\+C\+P\+S\+N\+O, }
\item[{real, dimension(ilg)}]{A\+L\+B\+S\+N\+O, }
\item[{real, dimension  (ilg,ig)}]{H\+M\+F\+G, }
\item[{real, dimension  (ilg)}]{H\+T\+C\+S, }
\item[{real, dimension   (ilg,ig)}]{H\+T\+C, }
\item[{real, dimension  (ilg)}]{W\+T\+R\+S, }
\item[{real, dimension  (ilg)}]{W\+T\+R\+G, }
\item[{real, dimension (ilg,ig)}]{G\+F\+L\+U\+X, }
\item[{real, dimension(ilg)}]{R\+U\+N\+O\+F\+F, }
\item[{real, dimension(ilg)}]{T\+R\+U\+N\+O\+F, }
\item[{real, dimension(ilg)}]{O\+V\+R\+F\+L\+W, }
\item[{real, dimension(ilg)}]{T\+O\+V\+R\+F\+L, }
\item[{real, dimension (ilg)}]{Z\+P\+L\+I\+M, }
\item[{real, dimension  (ilg)}]{G\+G\+E\+O, }
\item[{real, dimension    (ilg)}]{F\+I, }
\item[{real, dimension  (ilg)}]{E\+V\+A\+P, }
\item[{real, dimension     (ilg)}]{R, }
\item[{real, dimension    (ilg)}]{T\+R, }
\item[{real, dimension (ilg)}]{G\+Z\+E\+R\+O, }
\item[{real, dimension   (ilg)}]{G12, }
\item[{real, dimension   (ilg)}]{G23, }
\item[{real, dimension   (ilg,ig)}]{H\+C\+P, }
\item[{real, dimension (ilg)}]{Q\+M\+E\+L\+T, }
\item[{real, dimension (ilg)}]{W\+S\+N\+O\+W, }
\item[{real, dimension  (ilg,igp2,igp1)}]{Z\+M\+A\+T, }
\item[{real, dimension (ilg,igp2)}]{T\+M\+O\+V\+E, }
\item[{real, dimension (ilg,igp2)}]{W\+M\+O\+V\+E, }
\item[{real, dimension (ilg,igp1)}]{Z\+R\+M\+D\+R, }
\item[{real, dimension  (ilg)}]{T\+A\+D\+D, }
\item[{real, dimension (ilg)}]{Z\+M\+O\+V\+E, }
\item[{real, dimension  (ilg)}]{T\+B\+O\+T, }
\item[{real, dimension  (ig)}]{D\+E\+L\+Z, }
\item[{integer, dimension (ilg,ig)}]{I\+S\+A\+N\+D, }
\item[{integer, dimension (ilg)}]{I\+C\+O\+N\+T, }
\item[{integer}]{I\+W\+F, }
\item[{integer}]{I\+G, }
\item[{integer}]{I\+G\+P1, }
\item[{integer}]{I\+G\+P2, }
\item[{integer}]{I\+L\+G, }
\item[{integer}]{I\+L1, }
\item[{integer}]{I\+L2, }
\item[{integer}]{J\+L, }
\item[{integer}]{N}
\end{DoxyParamCaption}
)}\label{ICEBAL_8f_abefb862d3860a7222b2eaa981efb2701}

\begin{DoxyParams}{Parameters}
{\em tbar} & Temperature of ice layer $[C] (T_{av}( \Delta z))$\\
\hline
{\em hmfg} & Energy associated with freezing or thawing of water in ice layer $[W m^{-2}]$\\
\hline
{\em htc} & Internal energy change of ice layer due to conduction and/or change in mass $[W m^{-2}]$ (Ij)\\
\hline
{\em gflux} & Heat flow between ice layers $[W m^{-2}] (G(\Delta z))$\\
\hline
{\em tpond} & Temperature of ponded water \mbox{[}C\mbox{]}\\
\hline
{\em zpond} & Depth of ponded water \mbox{[}m\mbox{]}\\
\hline
{\em tsnow} & Temperature of the snow pack \mbox{[}C\mbox{]}\\
\hline
{\em rhosno} & Density of snow pack $[kg m^{-3}]$\\
\hline
{\em zsnow} & Depth of snow pack \mbox{[}m\mbox{]}\\
\hline
{\em hcpsno} & Heat capacity of snow pack $[J m^{-3} K^{-1}]$\\
\hline
{\em albsno} & Albedo of snow \mbox{[} \mbox{]}\\
\hline
{\em htcs} & Internal energy change of ice layer due to conduction and/or change in mass $[W m^{-2}] (I_j) $\\
\hline
{\em wtrs} & Water transferred into or out of the snow pack $[kg m^{-2} s^{-1}]$\\
\hline
{\em wtrg} & Water transferred into or out of the ice $[kg m^{-2} s^{-1}]$\\
\hline
{\em runoff} & Total runoff from ice column \mbox{[}m\mbox{]}\\
\hline
{\em trunof} & Temperature of total runoff from ice column \mbox{[}K\mbox{]}\\
\hline
{\em ovrflw} & Overland flow from top of ice column \mbox{[}m\mbox{]}\\
\hline
{\em tovrfl} & Temperature of overland flow from top of ice column \mbox{[}K\mbox{]}\\
\hline
{\em fi} & Fractional coverage of subarea in question on modelled area $[ ] (X)$\\
\hline
{\em evap} & Evaporation rate from ice surface $[m s^{-1}]$\\
\hline
{\em r} & Rainfall rate at ice surface $[m s^{-1}]$\\
\hline
{\em tr} & Temperature of rainfall \mbox{[}C\mbox{]}\\
\hline
{\em gzero} & Heat flow into ice surface $[W m^{-2}] (G(0))$\\
\hline
{\em g12} & Heat flow between first and second ice layers $[W m^{-2}] (G(\Delta z1))$\\
\hline
{\em g23} & Heat flow between second and third ice layers $[W m^{-2}] (G(\Delta z2))$\\
\hline
{\em qmelt} & Energy available for melting of ice $[W m^{-2}]$\\
\hline
{\em wsnow} & Liquid water content of snow pack $[kg m^{-2}]$\\
\hline
{\em zplim} & Limiting depth of ponded water \mbox{[}m\mbox{]}\\
\hline
{\em ggeo} & Geothermal heat flux at bottom of modelled ice profile $[W m^{-2}]$\\
\hline
{\em hcp} & Heat capacity of ice layer $[J m^{-3} K^{-1}]$\\
\hline
{\em isand} & Sand content flag\\
\hline
{\em delz} & Overall thickness of ice layer $[m] (\Delta z)$ \\
\hline
\end{DoxyParams}
In the 100 loop, any rainfall or snowmelt R reaching the ice surface is added to the ponded water on the surface. The ponded water temperature is calculated as the weighted average of the existing pond and the rainfall or snowmelt added, and the change in internal energy H\+T\+C of the first ice layer is updated using the temperature of the added water.

If a full-\/scale hydrological modelling application is not being run, that is, if only vertical fluxes of energy and moisture are being modelled, the flag I\+W\+F will have been pre-\/set to zero. In this case, overland flow of water is treated using a simple approach\+: if the ponded depth of water on the soil surface Z\+P\+O\+N\+D exceeds a pre-\/determined limiting value Z\+P\+L\+I\+M, the excess is assigned to overland flow. The total runoff from the ice sheet, R\+U\+N\+O\+F\+F, is incremented by the excess of the ponded water, and the overland flow for the whole grid cell O\+V\+R\+F\+L\+W is incremented by the product of the excess ponded water and the fractional area of the grid cell. The temperature of the overall runoff from the modelled area T\+R\+U\+N\+O\+F, and the temperature of the overland flow for the grid cell T\+O\+V\+R\+F\+L, are calculated as weighted averages over their previous values and the ponded water temperature T\+P\+O\+N\+D. The internal energy change H\+T\+C of the first soil layer is adjusted for the amount of water lost, and Z\+P\+O\+N\+D is set to Z\+P\+L\+I\+M.

If the temperature of the remaining ponded water is greater than 0 C, the sink of energy required to cool it to 0 C, H\+C\+O\+O\+L, is calculated and compared with the amount of energy required to warm the first ice layer to 0 C, H\+W\+A\+R\+M. If H\+W\+A\+R\+M $>$ H\+C\+O\+O\+L, the energy sink of the first layer is used to cool the ponded water to 0 C, and the layer temperature is updated accordingly. Otherwise, the ponded water temperature and the temperature of the first ice layer are both set to 0 C, and the excess energy source given by H\+C\+O\+O\+L-\/\+H\+W\+A\+R\+M is added to the heat available for melting ice, Q\+M\+E\+L\+T.

In loop 125, if the temperature of the first ice layer is less than -\/2 C after the above operations (i.\+e. if it is not very close to 0 C), and if the ponded water depth is not vanishingly small, freezing of the ponded water can take place. The energy sink required to freeze all of the ponded water, H\+F\+R\+E\+Z, is calculated and compared with H\+W\+A\+R\+M, the amount of energy required to raise the temperature of the first ice layer to 0 C. If H\+W\+A\+R\+M $>$ H\+F\+R\+E\+Z, then H\+F\+R\+E\+Z is converted into an equivalent temperature change using the heat capacity of ice, and added to the temperature of the first ice layer. H\+F\+R\+E\+Z is also used to update H\+M\+F\+G, the diagnosed energy used for phase changes of water in the first ice layer. The internal energy of the first soil layer, H\+T\+C, is adjusted to account for the loss of the ponded water, which is assumed to be added to the snow pack. The ponded water is converted into a frozen depth Z\+F\+R\+E\+Z, which is used to update the internal energy of the snow pack, H\+T\+C\+S. If there is not a pre-\/existing snow pack, the snow albedo is set to the limiting low value of 0.\+50. The temperature and density of the snow pack are recalculated as weighted averages over the original values and the frozen amount that has been added. Z\+F\+R\+E\+Z is added to the snow depth Z\+S\+N\+O\+W. The snow heat capacity is recalculated using the new value of the snow density. Finally, the diagnostic amounts of water transferred to the snow pack, W\+T\+R\+S, and from the ice, W\+T\+R\+G, are updated using Z\+F\+R\+E\+Z.

In the 150 loop the heat fluxes between the ice layers are calculated for the optional multiple-\/layer configuration, in which the standard third layer, normally with a thickness of 3.\+75 m, can be subdivided into smaller layers and extended to a greater depth if desired. (The heat fluxes at the ice surface, and between the first and second and the second and third layers, were already calculated in the C\+L\+A\+S\+S\+T subroutines.) The remaining fluxes are calculated by using a simple linearization of the soil temperature profile. The expression for the ground heat flux at a depth z, G(z), which depends on the thermal conductivity $\lambda(z)$ and the temperature gradient, is written as\+:

$G(z) = \lambda(z) dT(z)/dz$

The linearized form is thus\+:

$G_j = 2 \lambda_i (T_{j-1} – T_j) / (\Delta z_{j-1} + \Delta z_j)$

where $G_j$ is the heat flux at the top of layer j, $T_j$ and $\Delta z_j$ refer to the temperature and thickness of the layer, and $\lambda_i$ is the thermal conductivity of ice.

In the 200 loop a value is assigned to the temperature at the bottom of the ice profile, T\+B\+O\+T, and the temperatures for the first three ice layers are stepped ahead. If the standard three-\/layer configuration is being used, T\+B\+O\+T is obtained by making use of the assumption (see documentation for subroutine T\+N\+P\+R\+E\+P) that the variation of temperature T with depth z within each soil layer can be modelled using a quadratic equation\+:

$T(z) = 1/2 a z^2 + b z +c$

It can be shown that the temperature at the bottom of a given soil layer, $T(\Delta z)$, is related to the temperature at the top of the layer T(0) and the heat fluxes at the top and bottom of the layer, G(0) and $G(\Delta z)$, as follows\+:

$T(\Delta z) = T(0) - (\Delta z/ 2 \lambda_i)[G(0) + G(\Delta z)]$

Making use of the continuity requirement that the heat flux and temperature at the bottom of a given layer must be equal to the heat flux and temperature at the top of the layer beneath it, an expression for the temperature at the bottom of the third ice layer can be obtained as a function of the temperature at the surface and the fluxes between the ice layers\+:

$T(\Delta z_3) = T(0) – {G(\Delta z_2) [\Delta z_3 + \Delta z_2] + G(\Delta z_1) [\Delta z_2 + \Delta z_1] + G(0) \Delta z_{21}} / 2 \lambda_i$

The surface temperature T(0) is obtained by integrating the equation for T(z) to obtain an expression for the average layer temperature $T_{av}(\Delta z)$, and then inverting this to solve for T(0)\+:

$T(0) = T_{av}(\Delta z_1) + (\Delta z_1/ 3\lambda_i) [G(0) + 1/2 G(\Delta z_1)]$

The third layer temperature is then updated using the geothermal flux G\+G\+E\+O. If the optional multiple-\/ layer configuration is used, T\+B\+O\+T is simply set to the temperature of the lowest layer. In either the standard or the multiple-\/layer case, the first three layer temperatures are updated using the heat fluxes at the surface, between the first and second layers and between the second and third layers, which were determined in the C\+L\+A\+S\+S\+T subroutines. Finally, the latter fluxes are assigned to the appropriate levels in the diagnostic G\+F\+L\+U\+X vector.

In the 250 loop, the G\+F\+L\+U\+X values determined in the 150 loop are used to update the temperatures in the third and lower ice layers for the multiple-\/layer configuration. The calculations are bracketed by a determination of the change of internal energy $I_j$ of the ice layers as a result of the heat fluxes, obtained as the difference in $I_j$ between the beginning and end of the calculations\+:

$\Delta I_j = X_i \Delta[C_i \Delta z_j T_{av}(\Delta z_j)]/ \Delta t$

where $C_i$ is the heat capacity of ice, $Delta t$ is the length of the time step, and $X_i$ is the fractional coverage of the subarea under consideration relative to the modelled area.

In the 300 loop, checks are carried out to determine whether any of the ice layer temperatures has overshot 0 C as a result of the calculations in the previous loop. If so, the excess energy is assigned to a temporary variable Q\+A\+D\+D and is also added to the total heat available for melting of the ice, Q\+M\+E\+L\+T. Q\+A\+D\+D is subtracted from the internal energy of the layer in questions and is added to the internal energy of the first layer, since melting is assumed to proceed from the top downwards. The temperature of the layer is reset to 0 C. Finally, the first half of a calculation of the change of internal energy of each ice layer is performed, to be completed at the end of the subroutine.

In the next three loops, the ice layers are adjusted downward to account for the removal of mass at the surface by melting or sublimation. First, the temperature T\+M\+O\+V\+E of the ice into which the layer is moving is set to the temperature of the layer below it. T\+M\+O\+V\+E for the bottom layer is set to T\+B\+O\+T. A depth of ice Z\+M\+E\+L\+T is calculated as the amount of ice for which Q\+M\+E\+L\+T is sufficient to both raise its temperature to 0 C (if necessary) and melt it. The temperature of the overall runoff and the overland flow are updated as averages of the original temperature and the meltwater temperature (assumed to be at the freezing point), weighted according to their respective amounts, and the overall runoff and overland flow are incremented by Z\+M\+E\+L\+T (with Z\+M\+E\+L\+T converted to an equivalent water depth). The energy used for the melting of ice is calculated from Z\+M\+E\+L\+T and added to H\+M\+F\+G for the first layer, and the amount of energy used to raise the layer temperature to 0 C is added to H\+T\+C for the first layer. The total depth of downward adjustment of the ice layers, Z\+M\+O\+V\+E, is obtained as the sum of Z\+M\+E\+L\+T and the sublimation depth, calculated from E\+V\+A\+P. This amount is added to the diagnostic variable W\+T\+R\+G. Finally, the new temperature of each ice layer is calculated over the layer thickness D\+E\+L\+Z as the average of the original temperature weighted by D\+E\+L\+Z-\/\+Z\+M\+O\+V\+E and T\+M\+O\+V\+E weighted by Z\+M\+O\+V\+E.

In the next loops, the ice layers are adjusted upward to account for addition of mass at the surface by conversion of snow to ice. Snow is converted to ice if the mass of the snow pack exceeds $100 kg m^{-2}$, or if the density exceeds $900 kg m^{-3}$ (approaching that of ice). In the first case the excess over and above $100 kg m^{-2}$ is converted; in the second, the whole snow pack is converted. These calculations are performed in the 500 loop, bracketed by a calculation of the change in internal energy of the snow pack, H\+T\+C\+S. In both cases the first level of the ice level movement matrix W\+M\+O\+V\+E is set to the amount of snow that is converted, expressed as a depth of ice, and the first level of the temperature matrix T\+M\+O\+V\+E is set to the snow temperature. The amount of converted snow is added to the diagnostic variables W\+T\+R\+S and W\+T\+R\+G. The depth, density and heat capacity of the snow are recalculated. If the entire snow pack is being converted and the water content W\+S\+N\+O\+W was non-\/zero, W\+S\+N\+O\+W is subtracted from W\+T\+R\+S and added to W\+T\+R\+G, and is also added to the total runoff and the overland flow. The runoff and overland flow temperatures are updated accordingly. The snow temperature and water content are reset to zero. The amount of ice that is lost to the bottom of the profile is added to the total runoff, and the runoff temperature is updated accordingly.

In the remaining parts of the code, the actual adjustment of ice layer positions is performed. First the levels of the available depth matrix Z\+R\+M\+D\+R are set to the ice layer thicknesses; the matrix Z\+M\+A\+T is initialized to zero; and each level J of W\+M\+O\+V\+E and T\+M\+O\+V\+E from 2 to the bottom of the ice profile is set to the value of D\+E\+L\+Z and T\+B\+A\+R respectively of the J-\/1 ice level. The Z\+M\+A\+T matrix represents the depth of each ice layer J that is occupied by ice from level K in the layer movement matrix W\+M\+O\+V\+E after the layer adjustments are complete. In the 700 loop, starting at the top of the ice profile, an attempt is made to assign each layer of W\+M\+O\+V\+E in turn to the K,J level of Z\+M\+A\+T. If the calculated value of Z\+M\+A\+T is greater than the available depth Z\+R\+M\+D\+R of the layer, Z\+M\+A\+T is set to Z\+R\+M\+D\+R, W\+M\+O\+V\+E is decremented by Z\+R\+M\+D\+R, and Z\+R\+M\+D\+R is set to zero. Otherwise the calculated value of Z\+M\+A\+T is accepted, Z\+R\+M\+D\+R is decremented by Z\+M\+A\+T, and W\+M\+O\+V\+E is set to zero.

Finally, the 900 loop is performed over each ice layer J to determine the new layer temperature. The temperature adjustment variable T\+A\+D\+D is initialized to zero, and then incremented by the temperature T\+M\+O\+V\+E of each level K weighted by the corresponding K,J level of Z\+M\+A\+T, and finally by the original layer temperature weighted by the corresponding level of Z\+R\+M\+D\+R. The layer temperature is reset to T\+A\+D\+D normalized by D\+E\+L\+Z, and the updating of H\+T\+C, begun at the end of the 300 loop, is completed.

Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=206pt]{ICEBAL_8f_abefb862d3860a7222b2eaa981efb2701_icgraph}
\end{center}
\end{figure}


