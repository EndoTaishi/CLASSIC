\hypertarget{GRDRAN_8f}{}\section{G\+R\+D\+R\+A\+N.\+f File Reference}
\label{GRDRAN_8f}\index{G\+R\+D\+R\+A\+N.\+f@{G\+R\+D\+R\+A\+N.\+f}}


Purpose\+: Quantify movement of liquid water between soil layers under non-\/infiltrating conditions, in response to gravity and tension forces.  


\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \hyperlink{GRDRAN_8f_a9d02aa9115635af052981eec146b1042}{grdran} (I\+V\+E\+G, T\+H\+L\+I\+Q, T\+H\+I\+C\+E, T\+B\+A\+R\+W, F\+D\+T, T\+F\+D\+T, B\+A\+S\+F\+L\+W, T\+B\+A\+S\+F\+L, R\+U\+N\+O\+F\+F, T\+R\+U\+N\+O\+F, Q\+F\+G, W\+L\+O\+S\+T, F\+I, E\+V\+A\+P, R, Z\+P\+O\+N\+D, D\+T, W\+E\+X\+C\+E\+S, T\+H\+L\+M\+A\+X, T\+H\+T\+E\+S\+T, T\+H\+P\+O\+R, T\+H\+L\+R\+E\+T, T\+H\+L\+M\+I\+N, B\+I, P\+S\+I\+S\+A\+T, G\+R\+K\+S\+A\+T, T\+H\+F\+C, D\+E\+L\+Z\+W, X\+D\+R\+A\+I\+N, I\+S\+A\+N\+D, L\+Z\+F, I\+G\+R\+N, I\+G\+R\+D, I\+G\+D\+R, I\+G, I\+G\+P1, I\+G\+P2, I\+L\+G, I\+L1, I\+L2, J\+L, N)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Purpose\+: Quantify movement of liquid water between soil layers under non-\/infiltrating conditions, in response to gravity and tension forces. 



\subsection{Function/\+Subroutine Documentation}
\hypertarget{GRDRAN_8f_a9d02aa9115635af052981eec146b1042}{}\index{G\+R\+D\+R\+A\+N.\+f@{G\+R\+D\+R\+A\+N.\+f}!grdran@{grdran}}
\index{grdran@{grdran}!G\+R\+D\+R\+A\+N.\+f@{G\+R\+D\+R\+A\+N.\+f}}
\subsubsection[{grdran}]{\setlength{\rightskip}{0pt plus 5cm}subroutine grdran (
\begin{DoxyParamCaption}
\item[{integer}]{I\+V\+E\+G, }
\item[{real, dimension (ilg,ig)}]{T\+H\+L\+I\+Q, }
\item[{real, dimension (ilg,ig)}]{T\+H\+I\+C\+E, }
\item[{real, dimension (ilg,ig)}]{T\+B\+A\+R\+W, }
\item[{real, dimension  (ilg,igp1)}]{F\+D\+T, }
\item[{real, dimension  (ilg,igp1)}]{T\+F\+D\+T, }
\item[{real, dimension(ilg)}]{B\+A\+S\+F\+L\+W, }
\item[{real, dimension (ilg)}]{T\+B\+A\+S\+F\+L, }
\item[{real, dimension(ilg)}]{R\+U\+N\+O\+F\+F, }
\item[{real, dimension (ilg)}]{T\+R\+U\+N\+O\+F, }
\item[{real, dimension    (ilg)}]{Q\+F\+G, }
\item[{real, dimension (ilg)}]{W\+L\+O\+S\+T, }
\item[{real, dimension    (ilg)}]{F\+I, }
\item[{real, dimension  (ilg)}]{E\+V\+A\+P, }
\item[{real, dimension     (ilg)}]{R, }
\item[{real, dimension (ilg)}]{Z\+P\+O\+N\+D, }
\item[{real, dimension    (ilg)}]{D\+T, }
\item[{real, dimension(ilg)}]{W\+E\+X\+C\+E\+S, }
\item[{real, dimension(ilg,ig)}]{T\+H\+L\+M\+A\+X, }
\item[{real, dimension(ilg,ig)}]{T\+H\+T\+E\+S\+T, }
\item[{real, dimension (ilg,ig)}]{T\+H\+P\+O\+R, }
\item[{real, dimension(ilg,ig)}]{T\+H\+L\+R\+E\+T, }
\item[{real, dimension(ilg,ig)}]{T\+H\+L\+M\+I\+N, }
\item[{real, dimension    (ilg,ig)}]{B\+I, }
\item[{real, dimension(ilg,ig)}]{P\+S\+I\+S\+A\+T, }
\item[{real, dimension(ilg,ig)}]{G\+R\+K\+S\+A\+T, }
\item[{real, dimension  (ilg,ig)}]{T\+H\+F\+C, }
\item[{real, dimension (ilg,ig)}]{D\+E\+L\+Z\+W, }
\item[{real, dimension(ilg)}]{X\+D\+R\+A\+I\+N, }
\item[{integer, dimension (ilg,ig)}]{I\+S\+A\+N\+D, }
\item[{integer, dimension   (ilg)}]{L\+Z\+F, }
\item[{integer, dimension  (ilg)}]{I\+G\+R\+N, }
\item[{integer, dimension  (ilg)}]{I\+G\+R\+D, }
\item[{integer, dimension  (ilg)}]{I\+G\+D\+R, }
\item[{integer}]{I\+G, }
\item[{integer}]{I\+G\+P1, }
\item[{integer}]{I\+G\+P2, }
\item[{integer}]{I\+L\+G, }
\item[{integer}]{I\+L1, }
\item[{integer}]{I\+L2, }
\item[{integer}]{J\+L, }
\item[{integer}]{N}
\end{DoxyParamCaption}
)}\label{GRDRAN_8f_a9d02aa9115635af052981eec146b1042}

\begin{DoxyParams}{Parameters}
{\em iveg} & Subarea type flag\\
\hline
{\em thliq} & Volumetric liquid water content of soil layer $[m^3 m^{-3}] (\theta_l)$\\
\hline
{\em thice} & Volumetric frozen water content of soil layer $[m^3 m^{-3}] (\theta_i)$\\
\hline
{\em tbarw} & Temperature of water in soil layer \mbox{[}C\mbox{]}\\
\hline
{\em fdt} & Water flow at soil layer interfaces during current time step \mbox{[}m\mbox{]}\\
\hline
{\em tfdt} & Temperature of water flowing between soil layers \mbox{[}C\mbox{]}\\
\hline
{\em basflw} & Base flow from bottom of soil column \mbox{[}m\mbox{]}\\
\hline
{\em tbasfl} & Temperature of base flow from bottom of soil column \mbox{[}K\mbox{]}\\
\hline
{\em runoff} & Total runoff from soil column \mbox{[}m\mbox{]}\\
\hline
{\em trunof} & Temperature of total runoff from soil column \mbox{[}K\mbox{]}\\
\hline
{\em qfg} & Evaporation from soil surface (diagnostic) $[kg m^{-2} s^{-1}]$\\
\hline
{\em wlost} & Residual amount of water that cannot be supplied by surface stores $[kg m^{-2}]$\\
\hline
{\em fi} & Fractional coverage of subarea in question on modelled area \mbox{[} \mbox{]} $(X_i)$\\
\hline
{\em evap} & Evaporation rate from ground surface $[m s^{-1}]$\\
\hline
{\em r} & Rainfall rate at ground surface $[m s^{-1}]$\\
\hline
{\em zpond} & Depth of ponded water on soil surface \mbox{[}m\mbox{]}\\
\hline
{\em dt} & Time period over which water movement takes place \mbox{[}s\mbox{]}\\
\hline
{\em igrn} & Flag to indicate whether calculations in subroutine G\+R\+I\+N\+F\+L are done\\
\hline
{\em lzf} & Index of soil layer in which wetting front is located\\
\hline
{\em igrd} & Flag to indicate whether calculations in this subroutine are to be done\\
\hline
{\em igdr} & Index of soil layer in which bedrock is encountered\\
\hline
{\em thpor} & Pore volume in soil layer $[m^3 m^{-3}] (\theta_p)$\\
\hline
{\em thlret} & Liquid water retention capacity for organic soil $[m^3 m^{-3} ] (\theta_{l,ret})$\\
\hline
{\em thlmin} & Residual soil liquid water content remaining after freezing or evaporation $[m^3 m^{-3}] (\theta_{l,min})$\\
\hline
{\em bi} & Clapp and Hornberger empirical \char`\"{}b\char`\"{} parameter \mbox{[} \mbox{]} (b)\\
\hline
{\em psisat} & Soil moisture suction at saturation $[m] (\Psi_{sat})$\\
\hline
{\em grksat} & Hydraulic conductivity of soil at saturation $[m s^{-1}] (K_{sat})$\\
\hline
{\em thfc} & Field capacity $[m^3 m^{-3}]$\\
\hline
{\em delzw} & Permeable depth of soil layer $[m] (\Delta_{zg,w})$\\
\hline
{\em xdrain} & Drainage index for water flow at bottom of soil profile \mbox{[} \mbox{]}\\
\hline
{\em isand} & Sand content flag \\
\hline
\end{DoxyParams}
In loop 50, the flag I\+G\+R\+D is first set to 1 for all grid cells where the calculations in this subroutine are to be performed. The necessary conditions are\+: that the surface being modelled is not a glacier or ice sheet (I\+S\+A\+N\+D $>$ -\/4); that the time period D\+T is greater than zero; that the infiltration calculations in subroutine G\+R\+I\+N\+F\+L are not simultaneously being performed (I\+G\+R\+N = 0); and that the rainfall rate and the depth of ponded water are both vanishingly small. If any of these conditions is not met, I\+G\+R\+D is set to zero.

In loop 100, if the surface being modelled is not an ice sheet (I\+S\+A\+N\+D = -\/4) and if the soil layer in question is not completely rock (I\+S\+A\+N\+D = -\/3), the maximum possible water content of each soil layer, T\+H\+L\+M\+A\+X, is calculated as the maximum of the available pore volume T\+H\+P\+O\+R – T\+H\+I\+C\+E (where T\+H\+P\+O\+R is the total pore volume and T\+H\+I\+C\+E is the ice content of the layer), the actual liquid water content T\+H\+L\+I\+Q, and the minimum residual liquid water content T\+H\+L\+M\+I\+N. The last two conditions are required because in the case of a saturated soil undergoing freezing, since water expands when frozen, the sum of the liquid and frozen volumetric water contents may be greater than the pore volume, and thus T\+H\+L\+I\+Q or T\+H\+L\+M\+I\+N may be greater than T\+H\+P\+O\+R – T\+H\+I\+C\+E. An effective saturated hydraulic conductivity G\+R\+K\+S\+A\+T\+F of the soil layer is also defined, applying an empirical correction for the presence of ice. This ice content factor, fice, is calculated from Zhao and Gray (1997) as\+:

$f_{ice} = [1.0 – min((\theta_p - \theta_{l,min} )/\theta_p , \theta_i / \theta_p )]^2$

The pore volume of the soil layer is corrected for the presence of ice by defining the effective porevolume T\+H\+P\+O\+R\+F as equivalent to T\+H\+L\+M\+A\+X.

In loops 150 and 200, the theoretical amounts of water F\+D\+T flowing across the soil layer boundaries are calculated. F\+D\+T is evaluated as the product of the flow rate F(z) at the given depth z, and the period of time (D\+T) over which the flow is occurring. At z=0, the water flux is simply equal to the soil surface evaporation rate. Within the soil, the flow rate F at a given depth z is obtained using equation 21 from Verseghy (1991)\+:

$F(z) = K(z) [-b \Psi(z)/\theta_l(z) \bullet d\theta_l / dz + 1]$

where K(z) is the hydraulic conductivity and psi(z) is the soil moisture suction at depth z, and b is an empirical parameter developed by Clapp and Hornberger (1978). K(z) and $\Psi(z)$ are calculated following Clapp and Hornberger as

$K(z) = K_{sat} (\theta_l/\theta_p)^{(2b + 3)}$ $\Psi(z) = \Psi_{sat} (\theta_l/\theta_p)^{(-b )}$

where $K_{sat}$ and $\Psi_{sat}$ are the values of $K$ and $\Psi$ respectively at saturation.

At the bottom of the permeable soil depth, in layer I\+G\+D\+R, if the liquid water content of the soil is greater than the field capacity, the vertical flow out of the bottom of the soil profile is calculated using a relation derived from Soulis et al. (2010)\+:

Between soil layers, values of $K(z)$ and $\Psi(z)$ must be determined. This requires the estimation of soil properties at the layer interfaces. For $\theta_l$, $\theta_p$ and $d(\theta_l)/dz$, slightly different approaches are followed if the permeable soil layer thickness D\+E\+L\+Z\+W increases with depth (the normal case), or if it decreases between one soil layer and the next (indicating the presence of an impermeable barrier at some depth in the second layer). In the first case, the pore volume T\+H\+P\+B\+N\+D, liquid water content T\+H\+L\+B\+N\+D, and liquid water gradient D\+T\+H\+L\+D\+Z are simply calculated as arithmetic averages of the values above and below the interface. This has the effect of weighting the interface values towards the upper layer values, roughly emulating a surfaceward exponential decay curve of liquid water content. In the second case, in order to avoid a spurious weighting towards the lower layer, the gradients of liquid water content and pore volume between the upper and lower layers are calculated as linear relations, and then solved for the values at the interface.

The Clapp and Hornberger b parameter at the interface is calculated as a simple average of the values in the upper and lower soil layers. The saturated hydraulic conductivity $K_{sat,bnd}$ is calculated as a harmonic mean, and the saturated soil moisture suction $\Psi_{sat,bnd}$ as a geometric mean, of the top and bottom layer values\+:

$ K_{sat,bnd} = K_{sat,t} K_{sat,b} ( \Delta z_{g,w,,t} + \Delta z_{g,w,,b} ) / ( K_{sat,t} \Delta z_{g,w,b} + K_{sat,b} \Delta z_{g,w,t} ) $

$ \Psi_{sat,bnd} = \Psi_{sat,t}^{\Delta zg,w,t/(\Delta zg,w,t + \Delta zg,w,b)} \Psi_{sat,b}^{\Delta zg,w,b/(\Delta zg,w,t + \Delta zg,w,b)} $

Finally, K(z), $\Psi(z)$ and F(z) at the interface are calculated from the equations given above. At the end of the loop, if set to zero behind the soil layer L\+Z\+F containing the wetting front, and the flow rate at the bottom of L\+Z\+F is constrained to be $\geq$ 0.

In the next several loops, checks are carried out to ascertain whether the theoretically determined flow rates at the soil layer interfaces can be supported by the water contents in the layers. At the beginning of loop 250, the soil surface evaporation rate is addressed. A trial liquid water content T\+H\+T\+E\+S\+T is calculated for the first soil layer, reflecting the removal of the evaporated water. If T\+H\+T\+E\+S\+T is less than the minimum soil water content, F(0) is set to zero and $\theta_l$ is set to $\theta_{l,min}$. The excess surface flux that was not met by the removed liquid water is converted to a frozen water content, and an attempt is made to remove it from the frozen water in the layer. (The energy involved in converting the required frozen water mass to liquid water is obtained by decreasing the water temperature of the layer.) The frozen water content of the layer is adjusted to reflect the removal of the required amount. If the demand exceeds the supply of frozen water available, the frozen water content is set to zero, the diagnostic evaporative flux Q\+F\+G at the soil surface is adjusted, and the remaining water flux not able to be met by the first soil layer is assigned to the variable W\+L\+O\+S\+T.

In the remainder of the 250 loop, checks are carried out for soil layers with liquid water contents already effectively equal to $\theta_{l,min}$. If the flux at the top of the layer is upward and that at the bottom of the layer is downward, both are set to zero. If both are downward, only the flux at the bottom is set to zero; if both are upward, only the flux at the top is set to zero. If the soil layer is an organic one and the liquid water content is less than the layer retention capacity T\+H\+L\+R\+E\+T and the flux at the bottom of the layer is downward, it is set to zero.

In the 300 loop, checks are carried out for soil layers with liquid water contents already effectively equal to T\+H\+L\+M\+A\+X. If the flux at the top of the layer is downward and that at the bottom of the layer is upward, both are set to zero. If both are downward, then if the top flux is greater than the bottom flux, it is set equal to the bottom flux. If both are upward, then if magnitude of the bottom flux is greater than that of the top flux, it is set equal to the top flux.

In the 400 loop, for each soil layer T\+H\+T\+E\+S\+T is recalculated as the liquid water content resulting from the updated boundary fluxes, and is compared with a residual value T\+H\+L\+T\+H\+R. For organic soil layers deeper than the first layer, T\+H\+L\+T\+H\+R is set to the minimum of $\theta_{l,ret}$ and $\theta_l$, since only evapotranspiration can cause the soil moisture to fall below the retention capacity. (The first layer is excepted because surface evaporation can drive its moisture content below $\theta_{l,ret}$.) For mineral soils, $\theta_{l,min}$ is set to T\+H\+L\+M\+I\+N. If T\+H\+T\+E\+S\+T $<$ T\+H\+L\+T\+H\+R, then if the flow at the bottom of the soil layer is downward, it is recalculated as the sum of the flow at the top of the layer plus the amount of water that must be removed to make the liquid water content of the layer equal to T\+H\+L\+T\+H\+R. If the flow at the bottom of the layer is upward, the flow at the top of the layer is recalculated as the sum of the flow at the bottom of the layer minus the amount of water that must be removed to make the liquid water content of the layer equal to T\+H\+L\+T\+H\+R. T\+H\+T\+E\+S\+T of the current layer is then reset to T\+H\+L\+T\+H\+R, and T\+H\+T\+E\+S\+T of the overlying and underlying layers (if any) are recalculated using the new interface fluxes.

In the 500 loop, for each soil layer T\+H\+T\+E\+S\+T is compared with T\+H\+L\+M\+A\+X. If T\+H\+T\+E\+S\+T $>$ T\+H\+L\+M\+A\+X, two temporary variables are defined\+: W\+L\+I\+M\+I\+T as the amount of water required to raise the liquid water content of the soil layer to T\+H\+L\+M\+A\+X, and W\+E\+X\+C\+E\+S as the amount of water representing the excess of T\+H\+T\+E\+S\+T over T\+H\+L\+M\+A\+X. If the flux at the top of the layer is downward and the flux at the bottom of the layer is upward, then if the negative of the flux at the bottom of the layer is greater than W\+L\+I\+M\+I\+T, it is set equal to -\/\+W\+L\+I\+M\+I\+T and the flux at the top is set to zero; otherwise W\+E\+X\+C\+E\+S is subtracted from the flux at the top. If both the flux at the top and the flux at the bottom are downward, then W\+E\+X\+C\+E\+S is subtracted from the flux at the top. If both are upward, then W\+E\+X\+C\+E\+S is added to the flux at the bottom, and a correction is applied to the flux at the bottom of the underlying layer. Finally, T\+H\+T\+E\+S\+T is recalculated for all the soil layers using the new interface fluxes.

In the first part of the 600 loop, a correction is performed in the unlikely event that as a result of the above adjustments, the flux at the bottom of the last permeable soil layer has become upward. If this occurs, all of the fluxes above are corrected by the inverse of this same amount. However, this will result in a small spurious upward water flux at the surface. Since the liquid water flows are now accounted for, an attempt is made, as in loop 250, to remove the required water from the frozen water store in the first layer. The excess that cannot be supplied from this source is assigned to W\+L\+O\+S\+T.

In the second part of the 600 loop, the temperatures T\+F\+D\+T of the water fluxes at the top and bottom of the layers in the permeable soil profile are set equal to the temperatures of the water in the first and last layers respectively. The flow at the bottom of the profile and the temperature of the flow are used to update B\+A\+S\+F\+L\+W and T\+B\+A\+S\+F\+L, the baseflow from the current subarea and its temperature, and R\+U\+N\+O\+F\+F and T\+R\+U\+N\+O\+F, the total runoff from the grid cell in question and its temperature.

In the 700 loop, for each successive soil layer the temperature of the water flux at the bottom of the layer is first assigned. If the flux is downward, T\+F\+D\+T is set to the temperature of the water in the current layer; if it is upward, T\+F\+D\+T is set to the temperature of the water in the layer below. The temperature of the water in the current layer is then updated using the F\+D\+T and T\+F\+D\+T values at the top and bottom of the layer, and the liquid water content of the layer is set to T\+H\+T\+E\+S\+T.

Here is the call graph for this function\+:
% FIG 0




Here is the caller graph for this function\+:
% FIG 1


