\hypertarget{ctem_8f90}{}\section{ctem.\+f90 File Reference}
\label{ctem_8f90}\index{ctem.\+f90@{ctem.\+f90}}


The basic model structure of C\+T\+E\+M includes three live vegetation components (leaf (L), stem (S) and root (R)) and two dead carbon pools (litter or detritus (D) and soil carbon (H)). The amount of carbon in these pools ( $C_\mathrm{L}$, $C_\mathrm{S}$, $C_\mathrm{R}$, $C_\mathrm{D}$, $C_\mathrm{H}$, $kgC m^{-2}$) is tracked prognostically through the fluxes in and out of them. The rate change equations for carbon in these pools are summarized in Sect. rate\+\_\+change\+\_\+eqns\} after the processes leading to the calculation of fluxes in and out of these pools are introduced in the following sections.  


\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \hyperlink{ctem_8f90_ace1598599f37c24cac37dd963f23b497}{ctem} (fcancmx,fsnow,sand,clay,il1,il2,iday,radj,tcano,tcans,tbarc,tbarcs,tbarg,tbargs,ta,delzw,ancsveg,ancgveg, rmlcsveg,rmlcgveg,zbotw,thliqc,thliqg,deltat,uwind,vwind,lightng,prbfrhuc,extnprob,stdaln,tbar,popdon,nol2pfts, pfcancmx, nfcancmx,lnduseon,thicec, soildpth, spinfast,todfrac,compete,netrad,precip,psisat, grclarea,popdin, dofire,dowetlands, obswetf, isand,faregat, onetile\+\_\+per\+P\+F\+T, wetfrac, slopefrac,bi,thpor,thiceg, currlat,ch4conc,G\+R\+A\+V,R\+H\+O\+W,R\+H\+O\+I\+C\+E,leapnow,
\end{DoxyCompactItemize}


\subsection{Detailed Description}
The basic model structure of C\+T\+E\+M includes three live vegetation components (leaf (L), stem (S) and root (R)) and two dead carbon pools (litter or detritus (D) and soil carbon (H)). The amount of carbon in these pools ( $C_\mathrm{L}$, $C_\mathrm{S}$, $C_\mathrm{R}$, $C_\mathrm{D}$, $C_\mathrm{H}$, $kgC m^{-2}$) is tracked prognostically through the fluxes in and out of them. The rate change equations for carbon in these pools are summarized in Sect. rate\+\_\+change\+\_\+eqns\} after the processes leading to the calculation of fluxes in and out of these pools are introduced in the following sections. 



\subsection{Function/\+Subroutine Documentation}
\hypertarget{ctem_8f90_ace1598599f37c24cac37dd963f23b497}{}\index{ctem.\+f90@{ctem.\+f90}!ctem@{ctem}}
\index{ctem@{ctem}!ctem.\+f90@{ctem.\+f90}}
\subsubsection[{ctem}]{\setlength{\rightskip}{0pt plus 5cm}subroutine ctem (
\begin{DoxyParamCaption}
\item[{real, dimension(ilg,icc), intent(inout)}]{fcancmx, }
\item[{real, dimension(ilg), intent(in)}]{fsnow, }
\item[{real, dimension(ilg,ignd), intent(in)}]{sand, }
\item[{real, dimension(ilg,ignd), intent(in)}]{clay, }
\item[{integer, intent(in)}]{il1, }
\item[{integer, intent(in)}]{il2, }
\item[{integer, intent(in)}]{iday, }
\item[{real, dimension(ilg), intent(in)}]{radj, }
\item[{real, dimension(ilg), intent(in)}]{tcano, }
\item[{real, dimension(ilg), intent(in)}]{tcans, }
\item[{real, dimension(ilg,ignd), intent(in)}]{tbarc, }
\item[{real, dimension(ilg,ignd), intent(in)}]{tbarcs, }
\item[{real, dimension(ilg,ignd), intent(in)}]{tbarg, }
\item[{real, dimension(ilg,ignd), intent(in)}]{tbargs, }
\item[{real, dimension(ilg), intent(in)}]{ta, }
\item[{real, dimension(ilg,ignd), intent(in)}]{delzw, }
\item[{real, dimension(ilg,icc), intent(inout)}]{ancsveg, }
\item[{real, dimension(ilg,icc), intent(inout)}]{ancgveg, }
\item[{real, dimension(ilg,icc), intent(inout)}]{rmlcsveg, }
\item[{real, dimension(ilg,icc), intent(inout)}]{rmlcgveg, }
\item[{real, dimension(ilg,ignd), intent(in)}]{zbotw, }
\item[{real, dimension(ilg,ignd), intent(in)}]{thliqc, }
\item[{real, dimension(ilg,ignd), intent(in)}]{thliqg, }
\item[{real, intent(in)}]{deltat, }
\item[{real, dimension(ilg), intent(in)}]{uwind, }
\item[{real, dimension(ilg), intent(in)}]{vwind, }
\item[{real, dimension(ilg), intent(in)}]{lightng, }
\item[{real, dimension(ilg), intent(in)}]{prbfrhuc, }
\item[{real, dimension(ilg), intent(inout)}]{extnprob, }
\item[{integer, dimension(ilg), intent(in)}]{stdaln, }
\item[{real, dimension(ilg,ignd), intent(in)}]{tbar, }
\item[{logical, intent(inout)}]{popdon, }
\item[{integer, dimension(ican)}]{nol2pfts, }
\item[{real, dimension(ilg,icc), intent(in)}]{pfcancmx, }
\item[{real, dimension(ilg,icc), intent(in)}]{nfcancmx, }
\item[{logical, intent(in)}]{lnduseon, }
\item[{real, dimension(ilg,ignd), intent(in)}]{thicec, }
\item[{real, dimension(ilg), intent(in)}]{soildpth, }
\item[{integer, intent(in)}]{spinfast, }
\item[{real, dimension(ilg,icc), intent(in)}]{todfrac, }
\item[{logical, intent(in)}]{compete, }
\item[{real, dimension(ilg), intent(in)}]{netrad, }
\item[{real, dimension(ilg), intent(in)}]{precip, }
\item[{real, dimension(ilg,ignd), intent(in)}]{psisat, }
\item[{real, dimension(ilg), intent(in)}]{grclarea, }
\item[{real, dimension(ilg), intent(inout)}]{popdin, }
\item[{logical, intent(in)}]{dofire, }
\item[{logical, intent(in)}]{dowetlands, }
\item[{logical, intent(in)}]{obswetf, }
\item[{integer, dimension(ilg,ignd), intent(in)}]{isand, }
\item[{real, dimension(ilg), intent(in)}]{faregat, }
\item[{logical, intent(in)}]{onetile\+\_\+per\+P\+F\+T, }
\item[{real, dimension(ilg), intent(in)}]{wetfrac, }
\item[{real, dimension(ilg,8), intent(in)}]{slopefrac, }
\item[{real, dimension(ilg,ignd), intent(in)}]{bi, }
\item[{real, dimension(ilg,ignd), intent(in)}]{thpor, }
\item[{real, dimension(ilg,ignd), intent(in)}]{thiceg, }
\item[{real, dimension(ilg), intent(in)}]{currlat, }
\item[{real, dimension(ilg), intent(in)}]{ch4conc, }
\item[{real, intent(in)}]{G\+R\+A\+V, }
\item[{real, intent(in)}]{R\+H\+O\+W, }
\item[{real, intent(in)}]{R\+H\+O\+I\+C\+E, }
\item[{logical, intent(in)}]{leapnow}
\end{DoxyParamCaption}
)}\label{ctem_8f90_ace1598599f37c24cac37dd963f23b497}

\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em lnduseon} & logical switch to run the land use change subroutine or not.\\
\hline
\mbox{\tt in}  & {\em compete} & logical boolean telling if competition between pfts is on or not\\
\hline
\mbox{\tt in}  & {\em dofire} & boolean, if true allow fire, if false no fire.\\
\hline
\mbox{\tt in}  & {\em dowetlands} & if true allow wetland methane emission\\
\hline
\mbox{\tt in}  & {\em obswetf} & if true, use read-\/in observed wetland fraction\\
\hline
\mbox{\tt in}  & {\em onetile\+\_\+perpft} & if you are running with one tile per P\+F\+T in mosaic mode, set to true. Changes how competition is run. Specifically it allows competition between tiles. This is not recommended for any case where you don\textquotesingle{}t have one P\+F\+T in each tile as it has not been tested for that.\\
\hline
\mbox{\tt in}  & {\em leapnow} & true if this year is a leap year. Only used if the switch \textquotesingle{}leap\textquotesingle{} is true.\\
\hline
\mbox{\tt in}  & {\em iday} & day of year\\
\hline
\mbox{\tt in}  & {\em spinfast} & spinup factor for soil carbon whose default value is 1. as this factor increases the soil c pool will come into equilibrium faster. reasonable value for spinfast is between 5 and 10. when spinfast.\+ne.\+1 then the balcar subroutine is not run.\\
\hline
\mbox{\tt in}  & {\em il1} & il1=1\\
\hline
\mbox{\tt in}  & {\em il2} & il2=ilg (no. of grid cells in latitude circle)\\
\hline
\mbox{\tt in}  & {\em fsnow} & fraction of snow simulated by class\\
\hline
\mbox{\tt in}  & {\em sand} & percentage sand\\
\hline
\mbox{\tt in}  & {\em clay} & percentage clay\\
\hline
\mbox{\tt in}  & {\em radj} & latitude in radians\\
\hline
\mbox{\tt in}  & {\em tcano} & canopy temperature for canopy over ground subarea, K\\
\hline
\mbox{\tt in}  & {\em tcans} & canopy temperature for canopy over snow subarea, K\\
\hline
\mbox{\tt in}  & {\em tbar} & soil temperature, k\\
\hline
\mbox{\tt in}  & {\em tbarc} & soil temperature for canopy over ground subarea, K\\
\hline
\mbox{\tt in}  & {\em tbarcs} & soil temperature for canopy over snow subarea\\
\hline
\mbox{\tt in}  & {\em tbarg} & soil temperature for ground subarea\\
\hline
\mbox{\tt in}  & {\em tbargs} & soil temperature for snow over ground subarea\\
\hline
\mbox{\tt in}  & {\em psisat} & saturated soil matric potential (m)\\
\hline
\mbox{\tt in}  & {\em bi} & Brooks and Corey b term\\
\hline
\mbox{\tt in}  & {\em thpor} & Soil porosity\\
\hline
\mbox{\tt in}  & {\em ta} & air temp, K\\
\hline
\mbox{\tt in}  & {\em delzw} & thicknesses of the 3 soil layers\\
\hline
\mbox{\tt in}  & {\em zbotw} & bottom of soil layers\\
\hline
\mbox{\tt in}  & {\em soildpth} & soil depth (m)\\
\hline
\mbox{\tt in}  & {\em thliqc} & liquid mois. content of 3 soil layers, for canopy over snow and canopy over ground subareas\\
\hline
\mbox{\tt in}  & {\em thliqg} & liquid mois. content of 3 soil layers, for ground and snow over ground subareas\\
\hline
\mbox{\tt in}  & {\em thicec} & Frozen soil moisture content for canopy over snow and canopy over ground subareas\\
\hline
\mbox{\tt in}  & {\em thiceg} & Frozen soil moisture content for ground and snow over ground subareas\\
\hline
\mbox{\tt in}  & {\em deltat} & C\+T\+E\+M timestep in days\\
\hline
\mbox{\tt in}  & {\em grclarea} & area of the grid cell, $km^2$\\
\hline
\mbox{\tt in}  & {\em currlat} & centre latitude of grid cells in degrees\\
\hline
\mbox{\tt in}  & {\em uwind} & u wind speed, m/s\\
\hline
\mbox{\tt in}  & {\em vwind} & v wind speed, m/s\\
\hline
\mbox{\tt in}  & {\em precip} & daily precipitation (mm/day)\\
\hline
\mbox{\tt in}  & {\em netrad} & daily net radiation (w/m2)\\
\hline
\mbox{\tt in}  & {\em lightng} & total lightning frequency, flashes/km2.\+year\\
\hline
\mbox{\tt in}  & {\em prbfrhuc} & probability of fire due to human causes\\
\hline
\mbox{\tt in}  & {\em pfcancmx} & previous year\textquotesingle{}s fractional coverages of pfts\\
\hline
\mbox{\tt in}  & {\em nfcancmx} & next year\textquotesingle{}s fractional coverages of pfts\\
\hline
\mbox{\tt in}  & {\em todfrac} & max. fractional coverage of ctem\textquotesingle{}s 9 pfts by the end of the day, for use by land use subroutine\\
\hline
\mbox{\tt in}  & {\em ch4conc} & Atmospheric $CH_4$ concentration at the soil surface (ppmv)\\
\hline
\mbox{\tt in}  & {\em stdaln} & an integer telling if ctem is operated within gcm (=0) or in stand alone mode (=1). this is used for fire purposes. see comments just above where disturb subroutine is called.\\
\hline
\mbox{\tt in}  & {\em grav} & Acceleration due to gravity (\$m s$^\wedge$\{-\/1\} ), (C\+L\+A\+S\+S param) passed in to avoid the common block structure.\\
\hline
\mbox{\tt in}  & {\em rhow} & Density of water (\$kg m$^\wedge$\{-\/3\}), (C\+L\+A\+S\+S param) passed in to avoid the common block structure.\\
\hline
\mbox{\tt in}  & {\em rhoice} & Density of ice (\$kg m$^\wedge$\{-\/3\}), (C\+L\+A\+S\+S param) passed in to avoid the common block structure.\\
\hline
\mbox{\tt in,out}  & {\em popdon} & if set true use population density data to calculate fire extinguishing probability and probability of fire due to human causes, or if false, read directly from .ctm file\\
\hline
\mbox{\tt in,out}  & {\em ancsveg} & net photosynthetic rate for ctems 9 pfts for canopy over snow subarea\\
\hline
\mbox{\tt in,out}  & {\em ancgveg} & net photosynthetic rate for ctems 9 pfts for canopy over ground subarea\\
\hline
\mbox{\tt in,out}  & {\em rmlcsveg} & leaf respiration rate for ctems 9 pfts forcanopy over snow subarea\\
\hline
\mbox{\tt in,out}  & {\em rmlcgveg} & leaf respiration rate for ctems 9 pfts forcanopy over ground subarea\\
\hline
\mbox{\tt in,out}  & {\em extnprob} & fire extingusinging probability\\
\hline
\mbox{\tt in,out}  & {\em fcancmx} & max. fractional coverage of ctem\textquotesingle{}s 9 pfts, but this can be modified by land-\/use change, and competition between pfts\\
\hline
\mbox{\tt in,out}  & {\em popdin} & population density $(people / km^2)$\\
\hline
 & {\em nol2pfts} & number of level 2 ctem pfts \\
\hline
\end{DoxyParams}


 \subsubsection*{Constants and parameters are located in \hyperlink{ctem__params_8f90}{ctem\+\_\+params.\+f90} }

Begin calculations

Generate the sort index for correspondence between 9 pfts and the 12 values in the parameter vectors

If you intend to have competition and L\+U\+C between tiles then set onetile\+\_\+per\+P\+F\+T to true. N\+O\+T\+E\+: Turning onetile\+\_\+per\+P\+F\+T to true is usually not the behaviour desired unless you are running with one P\+F\+T on each tile and want them to compete for space across tiles. So in general keep this as False. J\+M Jan 2016.

this is composite/mosaic mode (in mosaic competition only occurs W\+I\+T\+H\+I\+N a tile)

Calculate bioclimatic parameters for estimating pfts existence

If first day of year then based on updated bioclimatic parameters find if pfts can exist or not. If .not. inibioclim then it is the first year of a run that you do not have the climatological means already in the C\+T\+M file. After one year inibioclim is set to true and the climatological means are used from the first year.

Call competition subroutine which on the basis of previous day\textquotesingle{}s npp estimates changes in fractional coverage of pfts

If landuse is on, then implelement luc, change fractional coverages, move biomasses around, and estimate luc related combustion emission losses.

Land use change and competition for mosaics needs mapping and unmapping of the pfts. Composite does not require these extra steps.

Check if number of mosaics is equal to the number of pfts plus one bare, e.\+g., nmos=iccp1

check for fcancmx(i,j). this should be either 0 or 1 for competition to work.

competition\+\_\+map scatters and maps the array with indices of (ilg,icc) to (nlat,icc) for preparation for competition

Calculate bioclimatic parameters for estimating pfts existence

If first day of year then based on updated bioclimatic parameters find if pfts can exist or not. If .not. inibioclim then it is the first year of a run that you do not have the climatological means already in the C\+T\+M file. After one year inibioclim is set to true and the climatological means are used from the first year.

call competition subroutine which on the basis of previous day\textquotesingle{}s npp estimates changes in fractional coverage of pfts

Competition\+\_\+unmap unmaps and gathers the array with indices (nlat,icc) back to (ilg,icc) after competition is done

initialize required arrays to zero

Store green and brown leaf, stem, and root biomass, and litter and soil c pool mass in arrays. knowing initial sizes of all pools and final sizes at the end of this subroutine, we check for conservation of mass.

Initialization ends

Find fc and fcs based on fcancmx

Autotrophic respiration

Leaf respiration is calculated in phtsyn subroutine, while stem and root maintenance respiration are calculated here.

We treat canopy over ground and canopy over snow subareas separately because stem temperature (for which we use canopy temperature as a surrogate) can be different for these two subareas.

Find maintenance respiration for canopy over snow sub-\/area in umol co2/m2/sec

Find maintenance respiration for canopy over ground sub-\/area

If ailcg/gleafmas is zero, i.\+e. real leaves are not on, then make maintenance respiration and gpp from storage/imaginary lai equal to zero so that we don\textquotesingle{}t use these numbers in carbon budget.

Find vegetation averaged leaf, stem, and root respiration, and gpp using values from canopy over ground and canopy over snow subareas

Now that we know maintenance respiration from leaf, stem, and root and gpp, we can find growth respiration for each vegetation

Calculate grid-\/averaged rates of rm, rg, npp, and gpp

\begin{DoxyVerb} Heterotrophic respiration part starts \end{DoxyVerb}


Find heterotrophic respiration rates for canopy over ground subarea

Find heterotrophic respiration rates from bare ground subarea

Find heterotrophic respiration rates from snow over ground subarea

Find vegetation averaged litter and soil c respiration rates using values from canopy over ground and canopy over snow subareas

Find litter and soil c respiration rates averaged over the bare fraction of the grid cell using values from ground and snow over ground sub-\/areas.

Find grid averaged litter and soil c respiration rates

Update the litter and soil c pools based on litter and soil c respiration rates found above. also transfer humidified litter to the soil c pool.

Convert u mol co2/m2.\+sec -\/$>$ $kg c/m^2$ respired over the model time step

Update litter and soil c pools

Estimate soil respiration. this is sum of heterotrophic respiratio and root maintenance respiration.

But over the bare fraction there is no live root.

Find grid averaged humification and soil respiration rates

Find C\+H4 wetland area (if not prescribed) and emissions\+:

Calculate the methane that is oxidized by the soil sink

Estimate allocation fractions for leaf, stem, and root components.

Note\+: fieldsm and wiltsm are calculated in allocate. They are called T\+H\+F\+C and P\+S\+I\+W\+L\+T in the C\+L\+A\+S\+S part of the model. They are recalculated here in C\+T\+E\+M to avoid passing them through the coupler in the coupled model. The C\+T\+E\+M calculated versions of fieldsm and wiltsm are also used in disturb and phenolgy. J\+M. Jan 14 2015.

Estimate fraction of npp that is to be used for horizontal expansion (lambda) during the next day (i.\+e. this will be determining the colonization rate in competition).

We use the following new function to smooth the transition for lambda as an abrupt linear increase does not give good results. J\+M Jun 2014

If tree and leaves still coming out, or if npp is negative, then do not expand

Maintenance respiration also reduces leaf, stem, and root biomass. when npp for a given pft is positive then this is taken care by allocating +ve npp amongst the leaves, stem, and root component. when npp for a given pft is negative then maintenance respiration loss is explicitly deducted from each component.

Convert npp and maintenance respiration from different components from units of u mol co2/m2.\+sec -\/$>$ $kg c/m^2$ sequestered or respired over the model time step (deltat)

Remove the cost of making reproductive tissues. This cost can only be removed when N\+P\+P is positive.

i.\+e. if lfstatus.\+eq.\+4 and since we do not have any real leaves on then we do not take into account co2 uptake by imaginary leaves in carbon budget. rmlvgstp(i,j) should be zero because we set maintenance respiration from storage/imaginary leaves equal to zero. in loop 180

since no real leaves are on, make allocation fractions equal to zero.

convert net change in leaf, stem, and root biomass into u-\/mol co2/m2.\+sec for use in balcar subroutine

to avoid over/underflow problems set gleafmas, stemmass, and rootmass to zero if they get too small

calculate grid averaged value of C related to spatial expansion

Phenology part starts

the phenology subroutine determines leaf status for each pft and calculates leaf litter. the phenology subroutine uses soil temperature (tbar) and root temperature. however, since ctem doesn\textquotesingle{}t make the distinction between canopy over ground, and canopy over snow sub-\/areas for phenology purposes (for example, leaf onset is not assumed to occur at different times over these sub-\/areas) we use average soil and root temperature in the phenology subroutine.

calculate average soil temperature and root temperature using values for canopy over ground and canopy over snow sub-\/areas, for each vegetation type.

Call the phenology subroutine, which determines the leaf growth status, calculates leaf litter, and converts green grass into brown.

while leaf litter is calculated in the phenology subroutine, stem and root turnover is calculated in the turnover subroutine.

Update green leaf biomass for trees and crops and brown leaf biomass for grasses

Update stem and root biomass for litter deductions

Update litter pool with leaf litter calculated in the phenology subroutine and stem and root litter calculated in the turnover subroutine. Also add the reproduction carbon directly to the litter pool

Call the mortaliy subroutine which calculates mortality due to reduced growth and aging. exogenous mortality due to fire and other disturbances and the subsequent litter that is generated is calculated in the disturb subroutine.

set maxage $>$0 in \hyperlink{ctem__params_8f90}{ctem\+\_\+params.\+f90} to switch on mortality due to age and reduced growth. Mortality is linked to the competition parameterization and generates bare fraction.

Update leaf, stem, and root biomass pools to take into loss due to mortality, and put the litter into the litter pool. the mortality for green grasses doesn\textquotesingle{}t generate litter, instead they turn brown.

call the disturbance subroutine which calculates mortality due to fire and other disturbances. the primary output from from disturbance subroutine is litter generated, c emissions due to fire and area burned, which may be used to estimate change in fractional coverages.

disturbance is spatial and requires area of gcm grid cell and areas of different pfts present in a given grid cell. however, when ctem is operated at a point scale then it is assumed that the spatial scale is 1 hectare = 10,000 m2. the disturbance subroutine may be stopped from simulating any fire by specifying fire extingushing probability equal to 1.

Calculate nbp (net biome production) for each pft by taking into account C emission losses. The disturbance routine produces emissions due to fire and it also calculates emissions due to L\+U\+C. These L\+U\+C carbon emissions due to combustion associated with L\+U\+C are first estimated in L\+U\+C. This flux is spread out over the whole year and is therefore subtracted to get N\+B\+P of each pft as well as the grid averaged value of N\+B\+P. Also L\+U\+C related combustion flux is assumed to be spread uniformly over the grid cell and thus reduces N\+B\+P of each P\+F\+T

Calculate grid. averaged rate of carbon emissions due to fire in u-\/mol co2/m2.\+sec. convert all emission losses from $kg c/m^2$ emitted in 1 day to u-\/mol co2/m2.\+sec. calculate grid averaged carbon emission losses from litter.

calculate total litter fall from each component (leaves, stem, and root) from all causes (normal turnover, drought and cold stress for leaves, mortality, and disturbance) for use in balcar subroutine

units here are $kg c/m^2 .day$

convert units to u-\/mol co2/m2.\+sec

calculate grid-\/average vegetation biomass, litter mass, and soil carbon mass, and litter fall rate

At this stage we have all required fluxes in u-\/mol co2/m2.\+sec and initial (loop 140 and 145) and updated sizes of all pools (in $kg c/m^2$). Now we call the balcar subroutine and make sure that C in leaves, stem, root, litter and soil C pool balances within a certain tolerance.

Finally find vegetation structural attributes which can be passed to the land surface scheme using leaf, stem, and root biomass.

Calculation of gavglai is moved from loop 1100 to here since ailcg is updated by bio2str