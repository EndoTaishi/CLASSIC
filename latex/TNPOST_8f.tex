\hypertarget{TNPOST_8f}{}\section{T\+N\+P\+O\+S\+T.\+f File Reference}
\label{TNPOST_8f}\index{T\+N\+P\+O\+S\+T.\+f@{T\+N\+P\+O\+S\+T.\+f}}


Purpose\+: Soil heat flux calculations and cleanup after surface energy budget calculations.  


\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \hyperlink{TNPOST_8f_a1d7de0e4ebe964e4c638efcb49b3c740}{tnpost} (T\+B\+A\+R\+P\+R, G12, G23, T\+P\+O\+N\+D, G\+Z\+E\+R\+O, Q\+F\+R\+E\+Z\+G, G\+C\+O\+N\+S\+T, G\+C\+O\+E\+F\+F, T\+B\+A\+R, T\+C\+T\+O\+P, T\+C\+B\+O\+T, H\+C\+P, Z\+P\+O\+N\+D, T\+S\+U\+R\+F, T\+B\+A\+S\+E, T\+B\+A\+R1\+P, A1, A2, B1, B2, C2, F\+I, I\+W\+A\+T\+E\+R, I\+S\+A\+N\+D, D\+E\+L\+Z, D\+E\+L\+Z\+W, I\+L\+G, I\+L1, I\+L2, J\+L, I\+G)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Purpose\+: Soil heat flux calculations and cleanup after surface energy budget calculations. 



\subsection{Function/\+Subroutine Documentation}
\hypertarget{TNPOST_8f_a1d7de0e4ebe964e4c638efcb49b3c740}{}\index{T\+N\+P\+O\+S\+T.\+f@{T\+N\+P\+O\+S\+T.\+f}!tnpost@{tnpost}}
\index{tnpost@{tnpost}!T\+N\+P\+O\+S\+T.\+f@{T\+N\+P\+O\+S\+T.\+f}}
\subsubsection[{tnpost}]{\setlength{\rightskip}{0pt plus 5cm}subroutine tnpost (
\begin{DoxyParamCaption}
\item[{real, dimension(ilg,ig)}]{T\+B\+A\+R\+P\+R, }
\item[{real, dimension   (ilg)}]{G12, }
\item[{real, dimension   (ilg)}]{G23, }
\item[{real, dimension (ilg)}]{T\+P\+O\+N\+D, }
\item[{real, dimension (ilg)}]{G\+Z\+E\+R\+O, }
\item[{real, dimension(ilg)}]{Q\+F\+R\+E\+Z\+G, }
\item[{real, dimension(ilg)}]{G\+C\+O\+N\+S\+T, }
\item[{real, dimension(ilg)}]{G\+C\+O\+E\+F\+F, }
\item[{real, dimension  (ilg,ig)}]{T\+B\+A\+R, }
\item[{real, dimension (ilg,ig)}]{T\+C\+T\+O\+P, }
\item[{real, dimension (ilg,ig)}]{T\+C\+B\+O\+T, }
\item[{real, dimension   (ilg,ig)}]{H\+C\+P, }
\item[{real, dimension (ilg)}]{Z\+P\+O\+N\+D, }
\item[{real, dimension (ilg)}]{T\+S\+U\+R\+F, }
\item[{real, dimension (ilg)}]{T\+B\+A\+S\+E, }
\item[{real, dimension(ilg)}]{T\+B\+A\+R1\+P, }
\item[{real, dimension    (ilg)}]{A1, }
\item[{real, dimension    (ilg)}]{A2, }
\item[{real, dimension    (ilg)}]{B1, }
\item[{real, dimension    (ilg)}]{B2, }
\item[{real, dimension    (ilg)}]{C2, }
\item[{real, dimension    (ilg)}]{F\+I, }
\item[{integer, dimension(ilg)}]{I\+W\+A\+T\+E\+R, }
\item[{integer, dimension (ilg,ig)}]{I\+S\+A\+N\+D, }
\item[{real, dimension  (ig)}]{D\+E\+L\+Z, }
\item[{real, dimension (ilg,ig)}]{D\+E\+L\+Z\+W, }
\item[{integer}]{I\+L\+G, }
\item[{integer}]{I\+L1, }
\item[{integer}]{I\+L2, }
\item[{integer}]{J\+L, }
\item[{integer}]{I\+G}
\end{DoxyParamCaption}
)}\label{TNPOST_8f_a1d7de0e4ebe964e4c638efcb49b3c740}

\begin{DoxyParams}{Parameters}
{\em tbarpr} & Temperatures of soil layers for subarea \mbox{[}C\mbox{]}\\
\hline
{\em g12} & Heat conduction between first and second soil layers $[W m^{-2}] (G(\Delta z))$\\
\hline
{\em g23} & Heat conduction between second and third soil layers $[W m^{-2}]$\\
\hline
{\em tpond} & Temperature of ponded water $[C] (T_p)$\\
\hline
{\em gzero} & Heat conduction into soil surface $[W m^{-2}] (G(0))$\\
\hline
{\em qfrezg} & Energy sink to be applied to freezing of ponded water $[W m^{-2}]$\\
\hline
{\em tbar} & Temperatures of soil layers, averaged over modelled area \mbox{[}K\mbox{]}\\
\hline
{\em tctop} & Thermal conductivity of soil at top of layer $[W m^{-1} K^{-1}] (\lambda)$\\
\hline
{\em tcbot} & Thermal conductivity of soil at bottom of layer $[W m^{-1} K^{-1}] (\lambda)$\\
\hline
{\em hcp} & Heat capacity of soil layer $[J m^{-3} K^{-1}]$\\
\hline
{\em delzw} & Permeable thickness of soil layer \mbox{[}m\mbox{]}\\
\hline
{\em zpond} & Depth of ponded water on surface $[m] (\Delta z_p)$\\
\hline
{\em tsurf} & Ground surface temperature \mbox{[}K\mbox{]}\\
\hline
{\em tbase} & Temperature of bedrock in third soil layer \mbox{[}K\mbox{]}\\
\hline
{\em tbar1p} & Lumped temperature of ponded water and first soil layer $[K] (T_{1p})$\\
\hline
{\em a1} & Work array used in calculation of G\+C\+O\+N\+S\+T and G\+C\+O\+E\+F\+F\\
\hline
{\em a2} & Work array used in calculation of G\+C\+O\+N\+S\+T and G\+C\+O\+E\+F\+F\\
\hline
{\em b1} & Work array used in calculation of G\+C\+O\+N\+S\+T and G\+C\+O\+E\+F\+F\\
\hline
{\em b2} & Work array used in calculation of G\+C\+O\+N\+S\+T and G\+C\+O\+E\+F\+F\\
\hline
{\em c2} & Work array used in calculation of G\+C\+O\+N\+S\+T and G\+C\+O\+E\+F\+F\\
\hline
{\em fi} & Fractional coverage of subarea in question on modelled area \mbox{[} \mbox{]}\\
\hline
{\em gconst} & Intercept used in equation relating ground surface heat flux to surface temperature $[W m^{-2}]$\\
\hline
{\em gcoeff} & Multiplier used in equation relating ground surface heat flux to surface temperature $[W m^{-2} K^{-1}]$\\
\hline
{\em iwater} & Flag indicating condition of surface (dry, water-\/covered or snow-\/covered)\\
\hline
{\em isand} & Sand content flag\\
\hline
{\em delz} & Overall thickness of soil layer $[m] (\Delta z)$ \\
\hline
\end{DoxyParams}
In the 100 loop, the heat flux into the ground (without adjustments that may have been applied owing to phase changes of water at the surface or partitioning the residual of the surface energy balance among the surface flux terms) is calculated from the ground surface temperature T\+S\+U\+R\+F, using the G\+C\+O\+E\+F\+F and G\+C\+O\+N\+S\+T terms (see documentation of subroutine T\+N\+P\+R\+E\+P). This flux is then used to back-\/calculate the heat conduction between the first and second, and the second and third soil layers.

If the depth of water ponded on the surface is greater than zero, the total thickness of the lumped layer consisting of the first soil layer and the ponded water, $\Delta z_{1p}$, is calculated as the sum of the two depths. The temperature of the ponded water over the subarea in question is disaggregated from the temperature of the lumped layer, $T_{1p}$, by making use of the calculated heat fluxes at the top and bottom of the layer, and the assumption (discussed in the documentation of subroutine T\+N\+P\+R\+E\+P) that that the variation of temperature T with depth z within a soil layer can be modelled using a quadratic equation\+:

$T(z) = 1/2 T''(0)z^2 + T'(0)z +T(0)$

Integrating this equation separately over the ponded water depth $\Delta z_p$ and over the thickness of the lumped layer produces expressions for the ponded water temperature $T_p$ and the temperature of the lumped layer. Making use of the fact that

$T''(0) = [T'(\Delta z) - T'(0)]/\Delta z$

where $\Delta z$ is a depth interval, and

$G(z) = - \lambda(z)T'(z)$ where $\lambda$ represents the thermal conductivity, an expression for $T_p$ can be derived\+:

$T_p = [G(0)/ \lambda(0) – G(\Delta z_{1p})/ \lambda(\Delta z_{1p})] [\Delta z_p^2 - \Delta z_{1p}^2]/ 6 \Delta z_{1p} – G(0) [\Delta z_p - \Delta z_{1p}]/ 2 \lambda(0) – T_{1P}$

The temperature T\+B\+A\+R\+P\+R of the first soil layer over the subarea in question can then be obtained by disaggregating the ponded water temperature from the lumped layer temperature using the respective heat capacities of the ponded water and the soil layer. (The heat capacity of the soil is determined as the weighted average of H\+C\+P over the permeable thickness D\+E\+L\+Z\+W, and the heat capacity of rock, H\+C\+P\+S\+N\+D, over the impermeable thickness, D\+E\+L\+Z-\/\+D\+E\+L\+Z\+W.) Both the ponded water temperature and the soil layer temperature are converted to C. Lastly, if there is ponded water on the surface (I\+W\+A\+T\+E\+R = 1) and Q\+F\+R\+E\+Z\+G, the surface energy available for phase change of water, is positive (indicating an energy source), or if there is snow on the ground (I\+W\+A\+T\+E\+R = 2) and Q\+F\+R\+E\+Z\+G is negative (indicating an energy sink), or if there is no liquid or frozen water on the surface (I\+W\+A\+T\+E\+R = 0), Q\+F\+R\+E\+Z\+G is added to the heat flux into the ground, G\+Z\+E\+R\+O, and then reset to zero.

In loop 200, the subarea soil layer temperatures T\+B\+A\+R\+P\+R are set for the remaining soil layers. In all cases the temperature of the layer is set to that for the modelled area, T\+B\+A\+R, converted to C, except in the case of the third soil layer if the standard three-\/layer configuration is being modelled (with a very thick third soil layer of 3.\+75 m). In this case T\+B\+A\+R\+P\+R and the layer heat capacity H\+C\+P are considered to apply to the permeable depth D\+E\+L\+Z\+W of the layer, and the bedrock temperature T\+B\+A\+S\+E and the rock heat capacity H\+C\+P\+S\+N\+D apply to the remainder, D\+E\+L\+Z-\/\+D\+E\+L\+Z\+W. The disaggregation of T\+B\+A\+R\+P\+R from T\+B\+A\+R and T\+B\+A\+S\+E is carried out on this basis. T\+B\+A\+R\+P\+R for this layer is also converted to C.