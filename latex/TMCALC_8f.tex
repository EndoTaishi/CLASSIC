\hypertarget{TMCALC_8f}{}\section{T\+M\+C\+A\+L\+C.\+f File Reference}
\label{TMCALC_8f}\index{T\+M\+C\+A\+L\+C.\+f@{T\+M\+C\+A\+L\+C.\+f}}


Purpose\+: Calculate overland flow; step ahead pond and soil layer temperatures, and check for freezing of the pond and freezing or thawing of liquid or frozen water in the soil layers. Adjust pond temperature, soil layer temperatures and water stores accordingly.  


\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \hyperlink{TMCALC_8f_a5ad5bd585e1ef7d89e9862d0bacd3c51}{tmcalc} (T\+B\+A\+R, T\+H\+L\+I\+Q, T\+H\+I\+C\+E, H\+C\+P, T\+P\+O\+N\+D, Z\+P\+O\+N\+D, T\+S\+N\+O\+W, Z\+S\+N\+O\+W, A\+L\+B\+S\+N\+O, R\+H\+O\+S\+N\+O, H\+C\+P\+S\+N\+O, T\+B\+A\+S\+E, O\+V\+R\+F\+L\+W, T\+O\+V\+R\+F\+L, R\+U\+N\+O\+F\+F, T\+R\+U\+N\+O\+F, H\+M\+F\+G, H\+T\+C, H\+T\+C\+S, W\+T\+R\+S, W\+T\+R\+G, F\+I, T\+B\+A\+R\+W, G\+Z\+E\+R\+O, G12, G23, G\+G\+E\+O, T\+A, W\+S\+N\+O\+W, T\+C\+T\+O\+P, T\+C\+B\+O\+T, G\+F\+L\+U\+X, Z\+P\+L\+I\+M, T\+H\+P\+O\+R, T\+H\+L\+M\+I\+N, H\+C\+P\+S, D\+E\+L\+Z\+W, D\+E\+L\+Z\+Z, D\+E\+L\+Z, I\+S\+A\+N\+D, I\+W\+F, I\+G, I\+L\+G, I\+L1, I\+L2, J\+L, N)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Purpose\+: Calculate overland flow; step ahead pond and soil layer temperatures, and check for freezing of the pond and freezing or thawing of liquid or frozen water in the soil layers. Adjust pond temperature, soil layer temperatures and water stores accordingly. 



\subsection{Function/\+Subroutine Documentation}
\hypertarget{TMCALC_8f_a5ad5bd585e1ef7d89e9862d0bacd3c51}{}\index{T\+M\+C\+A\+L\+C.\+f@{T\+M\+C\+A\+L\+C.\+f}!tmcalc@{tmcalc}}
\index{tmcalc@{tmcalc}!T\+M\+C\+A\+L\+C.\+f@{T\+M\+C\+A\+L\+C.\+f}}
\subsubsection[{tmcalc}]{\setlength{\rightskip}{0pt plus 5cm}subroutine tmcalc (
\begin{DoxyParamCaption}
\item[{real, dimension  (ilg,ig)}]{T\+B\+A\+R, }
\item[{real, dimension (ilg,ig)}]{T\+H\+L\+I\+Q, }
\item[{real, dimension (ilg,ig)}]{T\+H\+I\+C\+E, }
\item[{real, dimension   (ilg,ig)}]{H\+C\+P, }
\item[{real, dimension (ilg)}]{T\+P\+O\+N\+D, }
\item[{real, dimension (ilg)}]{Z\+P\+O\+N\+D, }
\item[{real, dimension (ilg)}]{T\+S\+N\+O\+W, }
\item[{real, dimension (ilg)}]{Z\+S\+N\+O\+W, }
\item[{real, dimension(ilg)}]{A\+L\+B\+S\+N\+O, }
\item[{real, dimension(ilg)}]{R\+H\+O\+S\+N\+O, }
\item[{real, dimension(ilg)}]{H\+C\+P\+S\+N\+O, }
\item[{real, dimension (ilg)}]{T\+B\+A\+S\+E, }
\item[{real, dimension(ilg)}]{O\+V\+R\+F\+L\+W, }
\item[{real, dimension(ilg)}]{T\+O\+V\+R\+F\+L, }
\item[{real, dimension(ilg)}]{R\+U\+N\+O\+F\+F, }
\item[{real, dimension(ilg)}]{T\+R\+U\+N\+O\+F, }
\item[{real, dimension  (ilg,ig)}]{H\+M\+F\+G, }
\item[{real, dimension   (ilg,ig)}]{H\+T\+C, }
\item[{real, dimension  (ilg)}]{H\+T\+C\+S, }
\item[{real, dimension  (ilg)}]{W\+T\+R\+S, }
\item[{real, dimension  (ilg)}]{W\+T\+R\+G, }
\item[{real, dimension    (ilg)}]{F\+I, }
\item[{real, dimension (ilg,ig)}]{T\+B\+A\+R\+W, }
\item[{real, dimension (ilg)}]{G\+Z\+E\+R\+O, }
\item[{real, dimension   (ilg)}]{G12, }
\item[{real, dimension   (ilg)}]{G23, }
\item[{real, dimension  (ilg)}]{G\+G\+E\+O, }
\item[{real, dimension    (ilg)}]{T\+A, }
\item[{real, dimension (ilg)}]{W\+S\+N\+O\+W, }
\item[{real, dimension (ilg,ig)}]{T\+C\+T\+O\+P, }
\item[{real, dimension (ilg,ig)}]{T\+C\+B\+O\+T, }
\item[{real, dimension (ilg,ig)}]{G\+F\+L\+U\+X, }
\item[{real, dimension (ilg)}]{Z\+P\+L\+I\+M, }
\item[{real, dimension (ilg,ig)}]{T\+H\+P\+O\+R, }
\item[{real, dimension(ilg,ig)}]{T\+H\+L\+M\+I\+N, }
\item[{real, dimension  (ilg,ig)}]{H\+C\+P\+S, }
\item[{real, dimension (ilg,ig)}]{D\+E\+L\+Z\+W, }
\item[{real, dimension (ilg,ig)}]{D\+E\+L\+Z\+Z, }
\item[{real, dimension  (ig)}]{D\+E\+L\+Z, }
\item[{integer, dimension (ilg,ig)}]{I\+S\+A\+N\+D, }
\item[{integer}]{I\+W\+F, }
\item[{integer}]{I\+G, }
\item[{integer}]{I\+L\+G, }
\item[{integer}]{I\+L1, }
\item[{integer}]{I\+L2, }
\item[{integer}]{J\+L, }
\item[{integer}]{N}
\end{DoxyParamCaption}
)}\label{TMCALC_8f_a5ad5bd585e1ef7d89e9862d0bacd3c51}

\begin{DoxyParams}{Parameters}
{\em tbar} & Temperature of soil layer $[C] (T_g)$\\
\hline
{\em thliq} & Volumetric liquid water content of soil layer $(\theta_l) [m^3 m^{-3}]$\\
\hline
{\em thice} & Volumetric frozen water content of soil layer $(\theta_i) [m^3 m^{-3}]$\\
\hline
{\em hcp} & Heat capacity of soil layer $[J m^{-3} K^{-1}] (C_g)$\\
\hline
{\em hmfg} & Energy associated with freezing or thawing of water in soil layer $[W m^{-2}]$\\
\hline
{\em htc} & Internal energy change of soil layer due to conduction and/or change in mass $[W m^{-2}] (I_g)$\\
\hline
{\em tpond} & Temperature of ponded water $[C] (T_p)$\\
\hline
{\em zpond} & Depth of ponded water $[m] (z_p)$\\
\hline
{\em tsnow} & Temperature of the snow pack $[C] (T_s)$\\
\hline
{\em zsnow} & Depth of snow pack $[m] (z_g)$\\
\hline
{\em albsno} & Albedo of snow \mbox{[} \mbox{]}\\
\hline
{\em rhosno} & Density of snow pack $(\rho_s) [kg m^{-3}]$\\
\hline
{\em hcpsno} & Heat capacity of snow pack $[J m^{-3} K^{-1}] (C_s)$\\
\hline
{\em tbase} & Temperature of bedrock in third soil layer, if only three layers are being modelled \mbox{[}K\mbox{]}\\
\hline
{\em ovrflw} & Overland flow from top of soil column \mbox{[}m\mbox{]}\\
\hline
{\em tovrfl} & Temperature of overland flow from top of soil column \mbox{[}K\mbox{]}\\
\hline
{\em runoff} & Total runoff from soil column \mbox{[}m\mbox{]}\\
\hline
{\em trunof} & Temperature of total runoff from soil column \mbox{[}K\mbox{]}\\
\hline
{\em htcs} & Internal energy change of snow pack due to conduction and/or change in mass $[W m^{-2}] (I_s)$\\
\hline
{\em wtrs} & Water transferred into or out of the snow pack $[kg m^{-2} s^{-1}]$\\
\hline
{\em wtrg} & Water transferred into or out of the soil $[kg m^{-2} s^{-1}]$\\
\hline
{\em fi} & Fractional coverage of subarea in question on modelled area $[ ] (X_i)$\\
\hline
{\em tbarw} & Temperature of water in soil layer \mbox{[}C\mbox{]}\\
\hline
{\em gzero} & Heat flow into soil surface $[W m^{-2}]$\\
\hline
{\em g12} & Heat flow between first and second soil layers $[W m^{-2}]$\\
\hline
{\em g23} & Heat flow between second and third soil layers $[W m^{-2}]$\\
\hline
{\em ggeo} & Geothermal heat flux at bottom of soil profile $[W m^{-2}]$\\
\hline
{\em ta} & Air temperature \mbox{[}K\mbox{]}\\
\hline
{\em wsnow} & Liquid water content of snow pack $[kg m^{-2}] (w_s)$\\
\hline
{\em tctop} & Thermal conductivity of soil at top of soil layer $[W m^{-1} K^{-1}]$\\
\hline
{\em tcbot} & Thermal conductivity of soil at bottom of soil layer $[W m^{-1} K^{-1}]$\\
\hline
{\em zplim} & Limiting depth of ponded water \mbox{[}m\mbox{]}\\
\hline
{\em thpor} & Pore volume in soil layer $(\theta_p) [m^3 m^{-3}]$\\
\hline
{\em thlmin} & Residual soil liquid water content remaining after freezing or evaporation $(\theta_r) [m^3 m^{-3}]$\\
\hline
{\em hcps} & Heat capacity of soil material $[J m^{-3} K^{-1}] (C_m)$\\
\hline
{\em delzw} & Permeable thickness of soil layer $(\Delta z_{g,w}) [m]$\\
\hline
{\em delzz} & Soil layer thicknesses to bottom of permeable depth for standard three-\/layer configuration, or to bottom of thermal depth for multiple layers $(\Delta z_{g,z}) [m]$\\
\hline
{\em delz} & Overall thickness of soil layer \mbox{[}m\mbox{]}\\
\hline
{\em isand} & Sand content flag\\
\hline
{\em gflux} & Heat flow between soil layers $[W m^{-2}]$ \\
\hline
\end{DoxyParams}
If a full-\/scale hydrological modelling application is not being run, that is, if only vertical fluxes of energy and moisture are being modelled, the flag I\+W\+F is pre-\/set to zero. In this case, overland flow of water is treated using a simple approach\+: if the ponded depth of water on the soil surface Z\+P\+O\+N\+D exceeds a limiting value Z\+P\+L\+I\+M (which varies by land surface type), the excess is assigned to overland flow. These calculations are carried out in loop 100, for all modelled areas except ice sheets (which are handled in subroutine I\+C\+E\+B\+A\+L). The overall runoff from the modelled area in question, R\+U\+N\+O\+F\+F, is incremented by the excess ponded water, and the overland flow for the whole grid cell O\+V\+R\+F\+L\+W is incremented by the product of the excess ponded water and the fractional area of the grid cell. The temperature of the overall runoff from the modelled area T\+R\+U\+N\+O\+F, and the temperature of the overland flow for the grid cell T\+O\+V\+R\+F\+L, are calculated as weighted averages over their previous values and the ponded water temperature T\+P\+O\+N\+D. Finally, Z\+P\+O\+N\+D is set to Z\+P\+L\+I\+M.

In loop 200, the calculation of the change in internal energy H\+T\+C within the soil layers due to movement of soil water (addressed in the preceding subroutines G\+R\+I\+N\+F\+L and G\+R\+D\+R\+A\+N) is completed. (The initial step was performed at the end of subroutine T\+W\+C\+A\+L\+C.) The volumetric heat capacity of the soil layers H\+C\+P is recalculated as a weighted average over the volumetric contents of liquid water, frozen water and soil particles. The temperature T\+B\+A\+R of each soil layer is recalculated as a weighted average of the liquid water temperature T\+B\+A\+R\+W resulting from soil water movement, and the previous soil layer temperature. As noted in the documentation for subroutine T\+W\+C\+A\+L\+C., T\+B\+A\+R\+W and H\+C\+P apply only over the permeable depth of the soil layer, D\+E\+L\+Z\+W, whereas T\+B\+A\+R applies over the whole depth, D\+E\+L\+Z\+Z, and is associated with H\+C\+P\+S\+N\+D, the volumetric heat capacity assigned to rock, in the interval D\+E\+L\+Z\+Z-\/ D\+E\+L\+Z\+W. (For the default three-\/layer version of C\+L\+A\+S\+S, D\+E\+L\+Z\+Z=D\+E\+L\+Z\+W in the third soil layer; see the documentation of loop 550 below.)

In loop 300 the calculation of the change of internal energy within the first soil layer due to changes in the surface ponded water is completed (for diagnostic purposes, the first level of H\+T\+C includes the internal energy of both the ponded water and the first soil layer). (The initial step of this calculation was performed at the end of subroutine T\+F\+R\+E\+E\+Z.) The flow of heat between the bottom of the ponded water and the top of the first soil layer, G\+P1, is calculated by assuming a linear variation with depth of the heat flux between the top of the pond, G\+Z\+E\+R\+O, and between the first and second soil layers, G12. Since the heat flux G(z) varies directly with the temperature gradient d\+T(z)/dz, it can be seen that this approach is consistent with the assumption made in the C\+L\+A\+S\+S\+T subroutines that T(z) is a quadratic function of depth (and therefore that its first derivative is a linear function of depth). The temperature of the ponded water is stepped ahead using G\+Z\+E\+R\+O and G\+P1, and G\+Z\+E\+R\+O is reset to G\+P1 for use in the later soil temperature calculations.

In the 400 loop, a check is performed to ascertain whether the ponded water temperature has fallen below 0 C as a result of the above temperature change. If so, calculations are carried out analogous to those done in T\+F\+R\+E\+E\+Z. A recalculation of the available energy in the snow pack, H\+T\+C\+S, is initiated. The available energy sink H\+A\+D\+D is calculated from T\+P\+O\+N\+D and Z\+P\+O\+N\+D, and T\+P\+O\+N\+D is set to 0 C. The amount of energy required to freeze the whole depth of ponded water is calculated as H\+C\+O\+N\+V. An update of the first level value of H\+T\+C, reflecting the freezing of ponded water, is initiated. If H\+A\+D\+D $<$ H\+C\+O\+N\+V, the available energy sink is sufficient to freeze only part of the ponded water. This depth Z\+F\+R\+E\+Z is calculated from H\+A\+D\+D, and subtracted from Z\+P\+O\+N\+D. Z\+F\+R\+E\+Z is then converted from a depth of water to a depth of ice, and is reassigned as part of the snow pack. The snow temperature, density, heat capacity and depth are recalculated as weighted averages of the pre-\/existing snow properties and those of the frozen water. If there was no snow on the ground to begin with, the snow albedo is initialized to its minimum background value of 0.\+50.

If H\+A\+D\+D $>$ H\+C\+O\+N\+V, the available energy sink is sufficient to freeze the whole depth of ponded water and then to decrease the frozen water temperature to below 0 C. Z\+F\+R\+E\+Z is evaluated as Z\+P\+O\+N\+D converted to a depth of ice, and the remaining energy sink H\+A\+D\+D-\/\+H\+C\+O\+N\+V is used to calculated a test temperature T\+T\+E\+S\+T of the newly formed ice. In order to avoid unphysical overshoots of the frozen water temperature, a limiting temperature T\+L\+I\+M is determined as the minimum of the snow temperature and the first level soil temperature if there is pre-\/existing snow, and as the minimum of the air temperature and the first level soil temperature if not. If T\+T\+E\+S\+T $<$ T\+L\+I\+M, the excess energy sink required to decrease the frozen water temperature from T\+L\+I\+M to T\+T\+E\+S\+T is calculated and added to G\+Z\+E\+R\+O, and the new frozen water temperature is assigned as T\+L\+I\+M; otherwise it is assigned as T\+T\+E\+S\+T. The energy sink used to cool the frozen water from 0 C to T\+L\+I\+M or T\+T\+E\+S\+T is decremented from the first level of H\+T\+C, and the snow temperature is recalculated as the weighted average of the pre-\/existing snow temperature and the frozen water temperature. If there was no pre-\/existing snow, the snow albedo is initialized to the background value of 0.\+50. The density, heat capacity and depth of the snow are recalculated as above. Finally, the recalculations of the internal energy diagnostic variables H\+T\+C and H\+T\+C\+S are completed; and Z\+F\+R\+E\+Z is used to update the diagnostic variable H\+M\+F\+G describing the energy associated with phase changes of water in soil layers, and the diagnostic variables W\+T\+R\+S and W\+T\+R\+G describing transfers of water into or out of the snow and soil respectively.

In the 500, 550 and 600 loops, the heat fluxes between soil layers and the updated temperatures for the soil layers are calculated according to the discretization approach that has been selected for the model run. It is assumed that the first two layer thicknesses are always set to 0.\+10 and 0.\+25 m respectively, but two possible options exist for the treatment of deeper layers. In the operational, \char`\"{}three-\/layer\char`\"{} configuration, a single third soil layer is modelled of thickness 3.\+75 m, with a user-\/specified permeable thickness D\+E\+L\+Z\+W. T\+B\+A\+R of the third layer is taken to apply to this permeable thickness, whereas a separate bedrock temperature, T\+B\+A\+S\+E, is carried for the impermeable thickness, represented by D\+E\+L\+Z-\/\+D\+E\+L\+Z\+W. This strategy is adopted so that temperature variations caused by melting and freezing of water are confined to the permeable thickness. In the \char`\"{}multi-\/layer\char`\"{} configuration, there can be any number of deeper layers, of thicknesses specified by the user (with the proviso that the thicknesses not be small enough to lead to numerical instability in the forward explicit time-\/stepping scheme). In this configuration it is deemed unnecessary to carry a separate calculation of T\+B\+A\+S\+E.

In the C\+L\+A\+S\+S\+T subroutines, the heat fluxes at the top of the first soil layer, and between the first and second and the second and third soil layers, were determined. In loop 500, the fluxes between the remaining soil layers are calculated for the multi-\/layer configuration, and assigned to the heat flux vector G\+F\+L\+U\+X. Since the temperature variation is increasingly damped with depth, a simple linearization of the temperature profile is used. The expression for the ground heat flux at depth z, G(z), which depends on the thermal conductivity $\lambda (z)$ and the temperature gradient, is given as\+: $G(z) = \lambda (z) dT(z)/dz$ The linearized form is written as\+: $G_j = (\lambda_{j-1} + \lambda_j ) (T_{j-1} - T_j ) / (\Delta z_{j-1} - \Delta z_j )$ where G j is the heat flux at the top of layer j, and $\lambda_j$ , $T_j$ and $\Delta z_j$ refer to the thermal conductivity, temperature and heat capacity of the layer.

In the 550 loop, the first and second soil layer temperatures are stepped ahead using G\+Z\+E\+R\+O, G12 and G23. (Recall that the calculated heat capacity H\+C\+P applies to the permeable thickness D\+E\+L\+Z\+W, and the heat capacity of rock H\+C\+P\+S\+N\+D applies to the rest of the layer thickness, D\+E\+L\+Z\+Z-\/\+D\+E\+L\+Z\+W.) If the three-\/ layer configuration is being used, then a check is carried out to ascertain whether the permeable thickness D\+E\+L\+Z\+Z of the third layer is greater than zero. If so, and if D\+E\+L\+Z\+Z is not effectively equal to D\+E\+L\+Z, the heat flow G3\+B at the interface between the permeable thickness and the underlying bedrock is calculated using the linearized heat flow equation given above; T\+B\+A\+R is updated using the difference between G23 and G3\+B, and T\+B\+A\+S\+E is updated using the difference between G3\+B and G\+G\+E\+O, the geothermal heat flux at the bottom of the soil profile. If D\+E\+L\+Z\+Z is equal to D\+E\+L\+Z, the whole layer is permeable and T\+B\+A\+R is updated using the difference between G23 and G\+G\+E\+O. If D\+E\+L\+Z\+Z is zero, the whole layer is impermeable, and T\+B\+A\+S\+E is updated using the difference between G23 and G\+G\+E\+O. H\+T\+C for the third layer is updated with the G\+G\+E\+O value. Finally, if the multi-\/layer configuration is being used, T\+B\+A\+R of the third layer is updated using G23, the flux at the top of the layer. For diagnostic purposes, the first three levels of the G\+F\+L\+U\+X vector are assigned as G\+Z\+E\+R\+O, G12 and G23 respectively.

In the 600 loop, the remaining soil layer temperature calculations are done for layers 3 and deeper, for the multi-\/layer configuration. At the beginning and end of the loop an updated calculation of H\+T\+C for the layer in question is initiated and completed respectively. For the third layer, T\+B\+A\+R is updated using the heat flux at the bottom of the layer; for the last layer, T\+B\+A\+R is updated using the difference between G\+F\+L\+U\+X at the top of the layer and G\+G\+E\+O at the bottom. For the intermediate layers, T\+B\+A\+R is calculated using the difference between the G\+F\+L\+U\+X values at the top and bottom of the layer.

In the 700 loop, checks are carried out to determine whether, as a result of the forward stepping of the temperature, T\+B\+A\+R has fallen below 0 C while liquid water still exists in the layer, or risen above 0 C while frozen water still exists in the layer. If either occurs, adjustments to the water content are performed analogous to those done in subroutine T\+W\+C\+A\+L\+C. Again, at the beginning and end of the loop an updated calculation of H\+T\+C for each layer in turn is initiated and completed respectively.

If the soil layer temperature is less than 0 C and the volumetric liquid water content T\+H\+L\+I\+Q of the layer is greater than the residual water content T\+H\+L\+M\+I\+N, the water content T\+H\+F\+R\+E\+Z that can be frozen by the available energy sink is calculated from T\+B\+A\+R and the weighted average of H\+C\+P and H\+C\+P\+S\+N\+D. If T\+H\+F\+R\+E\+Z $\leq$ T\+H\+L\+I\+Q -\/ T\+H\+L\+M\+I\+N, all of the available energy sink is used to freeze part of the liquid water content in the permeable part of the soil layer. The amount of energy involved is subtracted from H\+T\+C and added to H\+M\+F\+G. T\+H\+F\+R\+E\+Z is subtracted from T\+H\+L\+I\+Q, converted to an ice volume and added to T\+H\+I\+C\+E. H\+C\+P is recalculated, and the layer temperature is set to 0 C. Otherwise, all of the liquid water content of the layer above T\+H\+L\+M\+I\+N is converted to frozen water, and H\+M\+F\+G and H\+T\+C are recalculated to reflect this. H\+C\+P is recomputed, and the remaining energy sink H\+A\+D\+D is applied to decreasing the temperature of the soil layer.

If the soil layer temperature is greater than 0 C and the volumetric ice content T\+H\+I\+C\+E of the layer is greater than zero, the ice content T\+H\+M\+E\+L\+T that can be melted by the available energy is calculated from T\+B\+A\+R and the weighted average of H\+C\+P and H\+C\+P\+S\+N\+D. If T\+H\+M\+E\+L\+T $\leq$ T\+H\+I\+C\+E, all of the available energy is used to melt part of the frozen water content of the permeable part of the layer. The amount of energy involved is subtracted from H\+T\+C and added to H\+M\+F\+G. T\+H\+M\+E\+L\+T is subtracted from T\+H\+I\+C\+E, converted to a liquid water volume and added to T\+H\+L\+I\+Q; H\+C\+P is recalculated and the layer temperature is set to 0 C. Otherwise, all of the frozen water content of the layer is converted to liquid water, and H\+M\+F\+G and H\+T\+C are recalculated to reflect this. H\+C\+P is recomputed, and the remaining energy H\+A\+D\+D is applied to increasing the temperature of the soil layer.

Here is the caller graph for this function\+:
% FIG 0


