\hypertarget{TNPREP_8f}{}\section{T\+N\+P\+R\+E\+P.\+f File Reference}
\label{TNPREP_8f}\index{T\+N\+P\+R\+E\+P.\+f@{T\+N\+P\+R\+E\+P.\+f}}


Purpose\+: Calculate coefficients for solution of heat conduction into soil.  


\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \hyperlink{TNPREP_8f_ab5cfd35272325655f17bcc52acb00535}{tnprep} (A1, A2, B1, B2, C2, G\+D\+E\+N\+O\+M, G\+C\+O\+E\+F\+F, G\+C\+O\+N\+S\+T, C\+P\+H\+C\+H\+G, I\+W\+A\+T\+E\+R, T\+B\+A\+R, T\+C\+T\+O\+P, T\+C\+B\+O\+T, F\+I, Z\+P\+O\+N\+D, T\+B\+A\+R1\+P, D\+E\+L\+Z, T\+C\+S\+N\+O\+W, Z\+S\+N\+O\+W, I\+S\+A\+N\+D, I\+L\+G, I\+L1, I\+L2, J\+L, I\+G)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Purpose\+: Calculate coefficients for solution of heat conduction into soil. 



\subsection{Function/\+Subroutine Documentation}
\hypertarget{TNPREP_8f_ab5cfd35272325655f17bcc52acb00535}{}\index{T\+N\+P\+R\+E\+P.\+f@{T\+N\+P\+R\+E\+P.\+f}!tnprep@{tnprep}}
\index{tnprep@{tnprep}!T\+N\+P\+R\+E\+P.\+f@{T\+N\+P\+R\+E\+P.\+f}}
\subsubsection[{tnprep}]{\setlength{\rightskip}{0pt plus 5cm}subroutine tnprep (
\begin{DoxyParamCaption}
\item[{real, dimension    (ilg)}]{A1, }
\item[{real, dimension    (ilg)}]{A2, }
\item[{real, dimension    (ilg)}]{B1, }
\item[{real, dimension    (ilg)}]{B2, }
\item[{real, dimension    (ilg)}]{C2, }
\item[{real, dimension(ilg)}]{G\+D\+E\+N\+O\+M, }
\item[{real, dimension(ilg)}]{G\+C\+O\+E\+F\+F, }
\item[{real, dimension(ilg)}]{G\+C\+O\+N\+S\+T, }
\item[{real, dimension(ilg)}]{C\+P\+H\+C\+H\+G, }
\item[{integer, dimension(ilg)}]{I\+W\+A\+T\+E\+R, }
\item[{real, dimension  (ilg,ig)}]{T\+B\+A\+R, }
\item[{real, dimension (ilg,ig)}]{T\+C\+T\+O\+P, }
\item[{real, dimension (ilg,ig)}]{T\+C\+B\+O\+T, }
\item[{real, dimension    (ilg)}]{F\+I, }
\item[{real, dimension (ilg)}]{Z\+P\+O\+N\+D, }
\item[{real, dimension(ilg)}]{T\+B\+A\+R1\+P, }
\item[{real, dimension  (ig)}]{D\+E\+L\+Z, }
\item[{real, dimension(ilg)}]{T\+C\+S\+N\+O\+W, }
\item[{real, dimension (ilg)}]{Z\+S\+N\+O\+W, }
\item[{integer, dimension (ilg,ig)}]{I\+S\+A\+N\+D, }
\item[{integer}]{I\+L\+G, }
\item[{integer}]{I\+L1, }
\item[{integer}]{I\+L2, }
\item[{integer}]{J\+L, }
\item[{integer}]{I\+G}
\end{DoxyParamCaption}
)}\label{TNPREP_8f_ab5cfd35272325655f17bcc52acb00535}

\begin{DoxyParams}{Parameters}
{\em gdenom} & Work array used in calculation of G\+C\+O\+N\+S\+T and G\+C\+O\+E\+F\+F\\
\hline
{\em gcoeff} & Multiplier used in equation relating ground surface heat flux to surface temperature $[W m^{-2} K^{-1}]$\\
\hline
{\em gconst} & Intercept used in equation relating ground surface heat flux to surface temperature $[W m^{-2}]$\\
\hline
{\em cphchg} & Latent heat of sublimation $[J kg^{-1}]$\\
\hline
{\em iwater} & Flag indicating condition of surface (dry, water-\/covered or snow-\/covered)\\
\hline
{\em tbar} & Temperatures of soil layers, averaged over modelled area \mbox{[}K\mbox{]}\\
\hline
{\em tctop} & Thermal conductivity of soil at top of layer $[W m^{-1} K^{-1}] (\lambda_t)$\\
\hline
{\em tcbot} & Thermal conductivity of soil at bottom of layer $[W m^{-1} K^{-1}] (\lambda_b)$\\
\hline
{\em fi} & Fractional coverage of subarea in question on modelled area \mbox{[} \mbox{]}\\
\hline
{\em zpond} & Depth of ponded water on surface \mbox{[}m\mbox{]}\\
\hline
{\em tbar1p} & Lumped temperature of ponded water and first soil layer \mbox{[}K\mbox{]}\\
\hline
{\em tcsnow} & Thermal conductivity of snow $[W m^{-1} K^{-1}]$\\
\hline
{\em zsnow} & Depth of snow pack \mbox{[}m\mbox{]}\\
\hline
{\em isand} & Sand content flag\\
\hline
{\em delz} & Overall thickness of soil layer $[m] (\Delta_z)$ \\
\hline
\end{DoxyParams}
In this subroutine, coefficients are derived for an equation relating the heat flux at the ground surface to the ground surface temperature, using the average temperatures and the thermal conductivities of the underlying first three soil layers. It is assumed that the variation of temperature T with depth z within each soil layer can be modelled by using a quadratic equation\+:

$T(z) = (1/2) a z^2 + b z + c$

By substituting 0 for z in the above equation and in the expressions for its first and second derivatives, it can be shown that $a = T''(0)$, $b = T'(0)$, and $c = T(0)$. The term $T''(0)$ can be evaluated from the expression for the first derivative evaluated at the bottom of the soil layer, $T(\Delta z)$\+:

$T''(0) = [T'(\Delta z) - T'(0)]/ \Delta z$

The temperature gradient $T'(0)$ at the top of each layer is related to the heat flux G(0) through the thermal conductivity $\lambda_t$; and the temperature gradient and heat flux at the bottom of the layer, $G(\Delta z)$ and $T(\Delta z)$, are similarly related through the bottom thermal conductivity $\lambda_b$\+:

$G(0) = - \lambda_t T'(0)$ $G(\Delta z) = - \lambda_b T'(\Delta z)$

The average soil layer temperature, $T_{av}(\Delta z)$, can be obtained by integrating the resulting equation for T(z) between 0 and $\Delta z$. Making use of all of the above expressions, recognizing that the heat fluxes and temperatures at the bottoms of layers 1 and 2 must equal the heat fluxes and temperatures at the tops of layers 2 and 3 respectively, and neglecting as a first approximation the heat flux at the bottom of the third layer, a linear equation can be derived relating G(0) to T(0) at the soil surface, where the slope and intercept of the equation are functions only of the average temperatures, thicknesses, and top and bottom thermal conductivities of the three soil layers.

In the subroutine loop, first the depth corresponding to T\+B\+A\+R1\+P (the lumped temperature of the first soil layer and the ponded water) is calculated, as the sum of the first soil layer thickness and the ponded water depth. If the ponded water depth is not vanishingly small, the surface water flag I\+W\+A\+T\+E\+R is set to 1; otherwise it is set to 0 for soils and 2 for ice sheets (indicated by I\+S\+A\+N\+D = -\/4). If I\+W\+A\+T\+E\+R = 2, indicating a frozen water surface, the latent heat of vaporization, C\+P\+H\+C\+H\+G, is set to the value for sublimation (by adding the latent heat of melting to the latent heat of vaporization). If there is a snow pack present, the thermal conductivity at the top of the ground surface is calculated as the harmonic mean of the thermal conductivity at the top of the first soil layer and that of the snow pack. Finally, a series of work arrays is evaluated and is used to calculate the slope and intercept, G\+C\+O\+E\+F\+F and G\+C\+O\+N\+S\+T, of the equation relating G(0) to T(0) at the ground surface.