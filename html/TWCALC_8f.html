<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>CLASS-CTEM: TWCALC.f File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CLASS-CTEM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">TWCALC.f File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Check for freezing or thawing of liquid or frozen water in the soil layers, and adjust layer temperatures and water stores accordingly.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a70ccee2822c2cc573ae3aca26942288a"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="TWCALC_8f.html#a70ccee2822c2cc573ae3aca26942288a">twcalc</a> (TBAR, THLIQ, THICE, HCP, TBARW, HMFG, HTC, FI, EVAP, THPOR, THLMIN, HCPS, DELZW, DELZZ, ISAND, IG, ILG, IL1, IL2, JL)</td></tr>
<tr class="separator:a70ccee2822c2cc573ae3aca26942288a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Check for freezing or thawing of liquid or frozen water in the soil layers, and adjust layer temperatures and water stores accordingly. </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a class="anchor" id="a70ccee2822c2cc573ae3aca26942288a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine twcalc </td>
          <td>(</td>
          <td class="paramtype">real, dimension  (ilg,ig)&#160;</td>
          <td class="paramname"><em>TBAR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>THLIQ</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>THICE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg,ig)&#160;</td>
          <td class="paramname"><em>HCP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>TBARW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg,ig)&#160;</td>
          <td class="paramname"><em>HMFG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg,ig)&#160;</td>
          <td class="paramname"><em>HTC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>FI</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>EVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>THPOR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ig)&#160;</td>
          <td class="paramname"><em>THLMIN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg,ig)&#160;</td>
          <td class="paramname"><em>HCPS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>DELZW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>DELZZ</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>ISAND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ILG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IL1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IL2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>JL</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tbar</td><td>Temperature of soil layer <img class="formulaInl" alt="$[C] (T_g)$" src="form_1510.png"/></td></tr>
    <tr><td class="paramname">thliq</td><td>Volumetric liquid water content of soil layer <img class="formulaInl" alt="$[m^3 m^{-3}] (\theta_l)$" src="form_777.png"/></td></tr>
    <tr><td class="paramname">thice</td><td>Volumetric frozen water content of soil layer <img class="formulaInl" alt="$[m^3 m^{-3}] (\theta_i)$" src="form_778.png"/></td></tr>
    <tr><td class="paramname">hcp</td><td>Heat capacity of soil layer <img class="formulaInl" alt="$[J m^{-3} K^{-1}] (C_g)$" src="form_1515.png"/></td></tr>
    <tr><td class="paramname">tbarw</td><td>Temperature of water in soil layer [C]</td></tr>
    <tr><td class="paramname">hmfg</td><td>Energy associated with freezing or thawing of water in soil layer <img class="formulaInl" alt="$[W m^{-2}]$" src="form_809.png"/></td></tr>
    <tr><td class="paramname">htc</td><td>Internal energy change of soil layer due to conduction and/or change in mass <img class="formulaInl" alt="$[W m^{-2}] (I_g)$" src="form_1211.png"/></td></tr>
    <tr><td class="paramname">fi</td><td>Fractional coverage of subarea in question on modelled area <img class="formulaInl" alt="$[ ] (X_i)$" src="form_1178.png"/></td></tr>
    <tr><td class="paramname">evap</td><td>Calculated evaporation rate from soil surface <img class="formulaInl" alt="$[m s^{-1}]$" src="form_782.png"/></td></tr>
    <tr><td class="paramname">thpor</td><td>Pore volume in soil layer <img class="formulaInl" alt="$[mm] (\theta_p)$" src="form_1789.png"/></td></tr>
    <tr><td class="paramname">thlmin</td><td>Residual soil liquid water content remaining after freezing or evaporation <img class="formulaInl" alt="$[m^3 m^{-3}] (\theta_r)$" src="form_1790.png"/></td></tr>
    <tr><td class="paramname">hcps</td><td>Heat capacity of soil material <img class="formulaInl" alt="$[J m^{-3} K^{-1}] (C_m)$" src="form_1519.png"/></td></tr>
    <tr><td class="paramname">delzw</td><td>Permeable thickness of soil layer <img class="formulaInl" alt="$[m] (\Delta z_{g,w})$" src="form_1212.png"/></td></tr>
    <tr><td class="paramname">delzz</td><td>Soil layer thicknesses to bottom of permeable depth for standard three-layer configuration, or to bottom of thermal depth for multiple layers <img class="formulaInl" alt="$[m] (\Delta z_{g,z})$" src="form_1791.png"/></td></tr>
    <tr><td class="paramname">isand</td><td>Sand content flag </td></tr>
  </table>
  </dd>
</dl>
<p>The adjustments of soil layer temperature and water content in this routine are done over the whole soil profile in the case of multiple soil layers (see the section on assignment of background data), but only to the bottom of the permeable depth in the case of the standard three-layer configuration (0.10, 0.25 and 3.75 m). This is because if the permeable depth lies within the thick third soil layer, it is recognized as desirable to apply the temperature changes only to that upper part of the layer in which the phase change is occurring, in order to avoid systematic damping of the temperature response of the layer. Thus the local array DELZZ (set in subroutine WPREP) is used here instead of DELZ when referring to the total thermal thickness of the soil layer, where DELZZ=DELZW for the third soil layer when the three-layer configuration is being used, but DELZZ=DELZ for all other cases.</p>
<p>The heat capacity <img class="formulaInl" alt="$C_g$" src="form_743.png"/> of the permeable part <img class="formulaInl" alt="$\Delta z_{g,w}$" src="form_1792.png"/> of the soil layer under consideration is calculated here and in various other places in the subroutine as the weighted average of the heat capacities of the liquid water content <img class="formulaInl" alt="$\theta_l$" src="form_738.png"/>, the frozen water content <img class="formulaInl" alt="$\theta_i$" src="form_1419.png"/>, and the soil material (taken to apply to the volume fraction not occupied by the pore volume <img class="formulaInl" alt="$\theta_p$" src="form_613.png"/>). The heat capacity of air in the pores is neglected:</p>
<p><img class="formulaInl" alt="$C_g = C_w \theta_l + C_i \theta_i + C_m (1 - \theta_p)$" src="form_1793.png"/></p>
<p>Over the impermeable portion of the layer, the heat capacity of rock <img class="formulaInl" alt="$C_r$" src="form_1794.png"/> is assumed to apply. Thus an effective heat capacity <img class="formulaInl" alt="$C_{g,e}$" src="form_1795.png"/> (in units of <img class="formulaInl" alt="$J m^{-2} K^{-1}$" src="form_567.png"/>) over the soil layer in question, <img class="formulaInl" alt="$\Delta z_{g,z}$" src="form_1796.png"/>, can be calculated as:</p>
<p><img class="formulaInl" alt="$C_{g,e} = C_g \Delta z_{g,w} + C_r(\Delta z_{g,z} - \Delta z_{g,w})$" src="form_1797.png"/></p>
<p>The change of internal energy I in the soil layers as a result of freezing and thawing is calculated as the difference in I between the beginning and end of the subroutine:</p>
<p><img class="formulaInl" alt="$\Delta I_j = X_i \Delta (C_{g,e} T_g)/\Delta t$" src="form_1798.png"/></p>
<p>where <img class="formulaInl" alt="$T_g$" src="form_1799.png"/> is the temperature of the layer, <img class="formulaInl" alt="$\Delta t$" src="form_1192.png"/> the length of the time step, and <img class="formulaInl" alt="$X_i$" src="form_566.png"/> the fractional coverage of the subarea under consideration relative to the modelled area.</p>
<p>If the soil layer temperature is less than 0 C and the volumetric liquid water content <img class="formulaInl" alt="$\theta_l$" src="form_738.png"/> of the layer is greater than the residual water content <img class="formulaInl" alt="$\theta_f$" src="form_1800.png"/>, the water content THFREZ that can be frozen by the available energy sink is calculated from <img class="formulaInl" alt="$C_e$" src="form_1801.png"/> and <img class="formulaInl" alt="$T_g$" src="form_1799.png"/>. The volumetric water content THEVAP of the first layer that is required to satisfy the surface evaporative flux is determined. For each layer, if THLIQ is found to exceed THLMIN + THEVAP, THFREZ is compared to the available water. If THFREZ <img class="formulaInl" alt="$\leq$" src="form_12.png"/> THLIQ – THLMIN – THEVAP, all of the available energy sink is used to freeze part of the liquid water content in the permeable part of the soil layer, the amount of energy involved is subtracted from HTC and added to HMFG, <img class="formulaInl" alt="$C_g$" src="form_743.png"/> is recalculated and the layer temperature is set to 0 C. Otherwise, all of the liquid water content of the layer above THLMIN + THEVAP is converted to frozen water, and HMFG and HTC are recalculated to reflect this. Then <img class="formulaInl" alt="$C_g$" src="form_743.png"/> is recomputed, and the remaining energy sink is applied to decreasing the temperature of the soil layer (both the permeable and impermeable portions) using <img class="formulaInl" alt="$C_e$" src="form_1801.png"/>.</p>
<p>If the soil layer temperature is greater than 0 C and the volumetric ice content <img class="formulaInl" alt="$\theta_i$" src="form_1419.png"/> of the layer is greater than zero, the ice content THMELT that can be melted by the available energy is calculated from <img class="formulaInl" alt="$C_e$" src="form_1801.png"/> and <img class="formulaInl" alt="$T_g$" src="form_1799.png"/>. For each layer, if THMELT <img class="formulaInl" alt="$\leq$" src="form_12.png"/> THICE, all of the available energy is used to melt part of the frozen water content of the permeable part of the layer, the amount of energy involved is subtracted from HTC and added to HMFG, <img class="formulaInl" alt="$C_g$" src="form_743.png"/> is recalculated and the layer temperature is set to 0 C. Otherwise, all of the frozen water content of the layer is converted to liquid water, and HMFG and HTC are recalculated to reflect this. Then <img class="formulaInl" alt="$C_g$" src="form_743.png"/> is recomputed, and the remaining energy is applied to increasing the temperature of the soil layer (both the permeable and impermeable portions) using <img class="formulaInl" alt="$C_e$" src="form_1801.png"/>.</p>
<p>In the final cleanup, the internal energy calculations for this subroutine are completed, and the first half of a new set of internal energy calculations is done to span the subroutines treating ground water movement, which will be completed in subroutine TMCALC. Lastly, TBARW, the liquid water temperature of each soil layer, is assigned using TBAR.</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="TWCALC_8f_a70ccee2822c2cc573ae3aca26942288a_icgraph.png" border="0" usemap="#TWCALC_8f_a70ccee2822c2cc573ae3aca26942288a_icgraph" alt=""/></div>
<!-- MAP 0 -->
</div>
</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Apr 3 2017 15:35:54 for CLASS-CTEM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.9.1
</small></address>
</body>
</html>
