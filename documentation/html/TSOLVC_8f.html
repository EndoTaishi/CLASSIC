<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>CLASSIC: src/TSOLVC.f File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CLASSIC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('TSOLVC_8f.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">TSOLVC.f File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Solves surface energy balance for vegetated subareas.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a824dab26436ace6ad8f0f9e2f6908ce2"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="TSOLVC_8f.html#a824dab26436ace6ad8f0f9e2f6908ce2">tsolvc</a> (ISNOW, FI, QSWNET, QSWNC, QSWNG, QLWOUT, QLWOC, QLWOG, QTRANS, QSENS, QSENSC, QSENSG, QEVAP, QEVAPC, QEVAPG, EVAPC, EVAPG, EVAP, TCAN, QCAN, TZERO, QZERO, GZERO, QMELTC, QMELTG, RAICAN, SNOCAN, CDH, CDM, RIB, TAC, QAC, CFLUX, FTEMP, FVAP, ILMO, UE, H, QFCF, QFCL, HTCC, QSWINV, QSWINI, QLWIN, TPOTA, TA, QA, VA, VAC, PADRY, RHOAIR, ALVISC, ALNIRC, ALVISG, ALNIRG, TRVISC, TRNIRC, FSVF, CRIB, CPHCHC, CPHCHG, CEVAP, TADP, TVIRTA, RC, RBCOEF, ZOSCLH, ZOSCLM, ZRSLFH, ZRSLFM, ZOH, ZOM, FCOR, GCONST, GCOEFF, TGND, TRSNOW, FSNOWC, FRAINC, CHCAP, CMASS, PCPR, FROOT, THLMIN, DELZW, RHOSNO, ZSNOW, IWATER, IEVAP, ITERCT, ISLFD, ITC, ITCG, ILG, IL1, IL2, JL, N, TSTEP, TVIRTC, TVIRTG, EVBETA, XEVAP, EVPWET, Q0SAT, RA, RB, RAGINV, RBINV, RBTINV, RBCINV, TVRTAC, TPOTG, RESID, TCANO, WZERO, XEVAPM, DCFLXM, WC, DRAGIN, CFLUXM, CFLX, IEVAPC, TRTOP, QSTOR, CFSENS, CFEVAP, QSGADD, A, B, LZZ0, LZZ0T, FM, FH, ITER, NITER, KF1, KF2, AILCG, FCANC, CO2CONC, RMATCTEM, THLIQ, THFC, THLW, ISAND, IG, COSZS, PRESSG, XDIFFUS, ICTEM, IC, CO2I1, CO2I2, ctem_on, SLAI, FCANCMX, L2MAX, NOL2PFTS, CFLUXV, ANVEG, RMLVEG, DAYL, DAYL_MAX, ipeatland, Cmossmas, dmoss, anmoss, rmlmoss, iday, pdd)</td></tr>
<tr class="separator:a824dab26436ace6ad8f0f9e2f6908ce2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Solves surface energy balance for vegetated subareas. </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a class="anchor" id="a824dab26436ace6ad8f0f9e2f6908ce2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine tsolvc </td>
          <td>(</td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ISNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>FI</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QSWNET</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QSWNC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QSWNG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QLWOUT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QLWOC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QLWOG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QTRANS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QSENS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QSENSC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QSENSG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QEVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QEVAPC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QEVAPG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>EVAPC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>EVAPG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>EVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>TCAN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>QCAN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TZERO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QZERO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>GZERO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QMELTC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QMELTG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RAICAN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>SNOCAN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>CDH</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>CDM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>RIB</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>TAC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>QAC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>CFLUX</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>FTEMP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>FVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>ILMO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>UE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension     (ilg)&#160;</td>
          <td class="paramname"><em>H</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>QFCF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>QFCL</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>HTCC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QSWINV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QSWINI</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QLWIN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TPOTA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>TA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>QA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>VA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>VAC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>PADRY</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RHOAIR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ALVISC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ALNIRC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ALVISG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ALNIRG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TRVISC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TRNIRC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>FSVF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>CRIB</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>CPHCHC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>CPHCHG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>CEVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>TADP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TVIRTA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>RC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RBCOEF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ZOSCLH</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ZOSCLM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ZRSLFH</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ZRSLFM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>ZOH</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>ZOM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>FCOR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>GCONST</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>GCOEFF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>TGND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TRSNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>FSNOWC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>FRAINC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>CHCAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>CMASS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>PCPR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>FROOT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ig)&#160;</td>
          <td class="paramname"><em>THLMIN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ig)&#160;</td>
          <td class="paramname"><em>DELZW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RHOSNO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ZSNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(ilg)&#160;</td>
          <td class="paramname"><em>IWATER</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension (ilg)&#160;</td>
          <td class="paramname"><em>IEVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(ilg,6,50)&#160;</td>
          <td class="paramname"><em>ITERCT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ISLFD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ITC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ITCG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ILG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IL1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IL2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>JL</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>N</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TSTEP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TVIRTC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TVIRTG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>EVBETA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>XEVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>EVPWET</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>Q0SAT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>RA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>RB</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RAGINV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>RBINV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RBTINV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RBCINV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TVRTAC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TPOTG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>RESID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TCANO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>WZERO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>XEVAPM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>DCFLXM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>WC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>DRAGIN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>CFLUXM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>CFLX</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(ilg)&#160;</td>
          <td class="paramname"><em>IEVAPC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TRTOP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QSTOR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>CFSENS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>CFEVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>QSGADD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension     (ilg)&#160;</td>
          <td class="paramname"><em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension     (ilg)&#160;</td>
          <td class="paramname"><em>B</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>LZZ0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>LZZ0T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>FM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>FH</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>ITER</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension (ilg)&#160;</td>
          <td class="paramname"><em>NITER</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>KF1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>KF2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem)&#160;</td>
          <td class="paramname"><em>AILCG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem)&#160;</td>
          <td class="paramname"><em>FCANC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>CO2CONC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem,ig)&#160;</td>
          <td class="paramname"><em>RMATCTEM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ig)&#160;</td>
          <td class="paramname"><em>THLIQ</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ig)&#160;</td>
          <td class="paramname"><em>THFC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ig)&#160;</td>
          <td class="paramname"><em>THLW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(ilg,ig)&#160;</td>
          <td class="paramname"><em>ISAND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>COSZS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>PRESSG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>XDIFFUS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ICTEM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem)&#160;</td>
          <td class="paramname"><em>CO2I1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem)&#160;</td>
          <td class="paramname"><em>CO2I2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical&#160;</td>
          <td class="paramname"><em>ctem_on</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem)&#160;</td>
          <td class="paramname"><em>SLAI</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem)&#160;</td>
          <td class="paramname"><em>FCANCMX</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>L2MAX</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(ic)&#160;</td>
          <td class="paramname"><em>NOL2PFTS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>CFLUXV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem)&#160;</td>
          <td class="paramname"><em>ANVEG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ictem)&#160;</td>
          <td class="paramname"><em>RMLVEG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>DAYL</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>DAYL_MAX</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ipeatland</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>Cmossmas</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>dmoss</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>anmoss</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>rmlmoss</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>iday</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>pdd</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">isnow</td><td>Flag indicating presence or absence of snow</td></tr>
    <tr><td class="paramname">qswnet</td><td>Total net shortwave radiation of canopy and underlying surface <img class="formulaInl" alt="$[W m^{-2} ]$" src="form_235.png"/></td></tr>
    <tr><td class="paramname">qswnc</td><td>Net shortwave radiation on vegetation canopy <img class="formulaInl" alt="$[W m^{-2} ] (K_{*c} )$" src="form_1247.png"/></td></tr>
    <tr><td class="paramname">qswng</td><td>Net shortwave radiation at underlying surface <img class="formulaInl" alt="$[W m^{-2} ] (K_{*g} )$" src="form_1248.png"/></td></tr>
    <tr><td class="paramname">qlwout</td><td>Upwelling longwave radiation from canopy and underlying surface <img class="formulaInl" alt="$[W m^{-2} ]$" src="form_235.png"/></td></tr>
    <tr><td class="paramname">qlwoc</td><td>Upwelling longwave radiation from vegetation canopy <img class="formulaInl" alt="$[W m^{-2} ] (L \uparrow_c , L \downarrow_c )$" src="form_1249.png"/></td></tr>
    <tr><td class="paramname">qlwog</td><td>Upwelling longwave radiation from underlying surface <img class="formulaInl" alt="$[W m^{-2} ] (L \uparrow_g )$" src="form_1250.png"/></td></tr>
    <tr><td class="paramname">qtrans</td><td>Shortwave radiation transmitted into surface <img class="formulaInl" alt="$[W m^{-2} ] $" src="form_1251.png"/></td></tr>
    <tr><td class="paramname">qsens</td><td>Sensible heat flux from canopy and underlying surface <img class="formulaInl" alt="$[W m^{-2} ] (Q_H )$" src="form_1252.png"/></td></tr>
    <tr><td class="paramname">qsensc</td><td>Sensible heat flux from vegetation canopy <img class="formulaInl" alt="$[W m^{-2} ] (Q_{H,c} )$" src="form_1253.png"/></td></tr>
    <tr><td class="paramname">qsensg</td><td>Sensible heat flux from underlying surface <img class="formulaInl" alt="$[W m^{-2} ] (Q_{H,g} )$" src="form_1254.png"/></td></tr>
    <tr><td class="paramname">qevap</td><td>Latent heat flux from canopy and underlying surface <img class="formulaInl" alt="$[W m^{-2} ] (Q_E )$" src="form_1255.png"/></td></tr>
    <tr><td class="paramname">qevapc</td><td>Latent heat flux from vegetation canopy <img class="formulaInl" alt="$[W m^{-2} ] (Q_{E,c} )$" src="form_1256.png"/></td></tr>
    <tr><td class="paramname">qevapg</td><td>Latent heat flux from underlying surface <img class="formulaInl" alt="$[W m^{-2} ] (Q_{E,g} )$" src="form_1257.png"/></td></tr>
    <tr><td class="paramname">evapc</td><td>Evaporation rate from vegetation <img class="formulaInl" alt="$[kg m^{-2} s^{-1} ] (E_c )$" src="form_1258.png"/></td></tr>
    <tr><td class="paramname">evapg</td><td>Evaporation rate from underlying surface <img class="formulaInl" alt="$[kg m^{-2} s^{-1} ] (E(0))$" src="form_1259.png"/></td></tr>
    <tr><td class="paramname">tcan</td><td>Vegetation canopy temperature <img class="formulaInl" alt="$[K] (T_c )$" src="form_1260.png"/></td></tr>
    <tr><td class="paramname">qcan</td><td>Saturated specific humidity at canopy temperature <img class="formulaInl" alt="$[kg kg^{-1} ] (q_c )$" src="form_1261.png"/></td></tr>
    <tr><td class="paramname">tzero</td><td>Temperature at surface <img class="formulaInl" alt="$[K] (T(0))$" src="form_1262.png"/></td></tr>
    <tr><td class="paramname">qzero</td><td>Specific humidity at surface <img class="formulaInl" alt="$[kg kg^{-1} ] (q(0))$" src="form_1263.png"/></td></tr>
    <tr><td class="paramname">gzero</td><td>Heat flux into surface <img class="formulaInl" alt="$[W m^{-2} ] (G(0))$" src="form_1264.png"/></td></tr>
    <tr><td class="paramname">qmeltc</td><td>Heat available for melting snow or freezing water on the vegetation <img class="formulaInl" alt="$[W m^{-2} ]$" src="form_235.png"/></td></tr>
    <tr><td class="paramname">qmeltg</td><td>Heat available for melting snow or freezing water on the underlying surface <img class="formulaInl" alt="$[W m^{-2} ]$" src="form_235.png"/></td></tr>
    <tr><td class="paramname">raican</td><td>Intercepted liquid water stored on vegetation canopy <img class="formulaInl" alt="$[kg m^{-2} ]$" src="form_232.png"/></td></tr>
    <tr><td class="paramname">snocan</td><td>Intercepted frozen water stored on vegetation canopy <img class="formulaInl" alt="$[kg m^{-2} ]$" src="form_232.png"/></td></tr>
    <tr><td class="paramname">cdh</td><td>Surface drag coefficient for heat [ ]</td></tr>
    <tr><td class="paramname">cdm</td><td>Surface drag coefficient for momentum [ ]</td></tr>
    <tr><td class="paramname">rib</td><td>Bulk Richardson number at surface [ ]</td></tr>
    <tr><td class="paramname">tac</td><td>Temperature of air within vegetation canopy <img class="formulaInl" alt="$[K] (T_{ac} )$" src="form_1265.png"/></td></tr>
    <tr><td class="paramname">qac</td><td>Specific humidity of air within vegetation canopy space <img class="formulaInl" alt="$[kg kg^{-1} ] (q_{ac} )$" src="form_1266.png"/></td></tr>
    <tr><td class="paramname">cflux</td><td>Product of surface drag coefficient and wind speed <img class="formulaInl" alt="$[m s^{-1} ]$" src="form_236.png"/></td></tr>
    <tr><td class="paramname">ftemp</td><td>Product of surface-air temperature gradient, drag coefficient and wind speed <img class="formulaInl" alt="$[K m s^{-1} ]$" src="form_238.png"/></td></tr>
    <tr><td class="paramname">fvap</td><td>Product of surface-air humidity gradient, drag coefficient and wind speed <img class="formulaInl" alt="$[kg kg^{-1} m s^{-1} ]$" src="form_1267.png"/></td></tr>
    <tr><td class="paramname">ilmo</td><td>Inverse of Monin-Obukhov roughness length <img class="formulaInl" alt="$(m^{-1} ]$" src="form_237.png"/></td></tr>
    <tr><td class="paramname">ue</td><td>Friction velocity of air <img class="formulaInl" alt="$[m s^{-1} ]$" src="form_236.png"/></td></tr>
    <tr><td class="paramname">h</td><td>Height of the atmospheric boundary layer [m]</td></tr>
    <tr><td class="paramname">qfcf</td><td>Sublimation from frozen water on vegetation <img class="formulaInl" alt="$[kg m^{-2} s^{-1} ]$" src="form_219.png"/></td></tr>
    <tr><td class="paramname">qfcl</td><td>Evaporation from liquid water on vegetation <img class="formulaInl" alt="$[kg m^{-2} s^{-1} ]$" src="form_219.png"/></td></tr>
    <tr><td class="paramname">htcc</td><td>Internal energy change of canopy due to changes in temperature and/or mass <img class="formulaInl" alt="$[W m^{-2} ]$" src="form_235.png"/></td></tr>
    <tr><td class="paramname">evap</td><td>Diagnosed total surface water vapour flux over modelled area <img class="formulaInl" alt="$[kg m^{-2} s^{-1} ]$" src="form_219.png"/></td></tr>
    <tr><td class="paramname">fi</td><td>Fractional coverage of subarea in question on modelled area [ ]</td></tr>
    <tr><td class="paramname">qswinv</td><td>Visible radiation incident on horizontal surface <img class="formulaInl" alt="$[W m^{-2} ] (K \downarrow )$" src="form_1268.png"/></td></tr>
    <tr><td class="paramname">qswini</td><td>Near-infrared radiation incident on horizontal surface <img class="formulaInl" alt="$[W m^{-2} ] (K \downarrow )$" src="form_1268.png"/></td></tr>
    <tr><td class="paramname">qlwin</td><td>Downwelling longwave radiation at bottom of atmosphere <img class="formulaInl" alt="$[W m^{-2} ] (L \downarrow )$" src="form_1269.png"/></td></tr>
    <tr><td class="paramname">tpota</td><td>Potential temperature of air at reference height <img class="formulaInl" alt="$[K] (T_{a,pot} )$" src="form_1270.png"/></td></tr>
    <tr><td class="paramname">ta</td><td>Air temperature at reference height [K]</td></tr>
    <tr><td class="paramname">qa</td><td>Specific humidity at reference height <img class="formulaInl" alt="$[kg kg^{-1} ] (q_a )$" src="form_1271.png"/></td></tr>
    <tr><td class="paramname">va</td><td>Wind speed at reference height <img class="formulaInl" alt="$[m s^{-1} ]$" src="form_236.png"/></td></tr>
    <tr><td class="paramname">vac</td><td>Wind speed within vegetation canopy space <img class="formulaInl" alt="$[m s^{-1} ] (v_{ac} )$" src="form_1272.png"/></td></tr>
    <tr><td class="paramname">padry</td><td>Partial pressure of dry air <img class="formulaInl" alt="$[Pa] (p_{dry} )$" src="form_312.png"/></td></tr>
    <tr><td class="paramname">rhoair</td><td>Density of air <img class="formulaInl" alt="$[kg m^{-3} ] ( \rho_a )$" src="form_1273.png"/></td></tr>
    <tr><td class="paramname">alvisc</td><td>Visible albedo of vegetation canopy <img class="formulaInl" alt="$[ ] ( \alpha_c )$" src="form_1274.png"/></td></tr>
    <tr><td class="paramname">alnirc</td><td>Near-IR albedo of vegetation canopy <img class="formulaInl" alt="$[ ] ( \alpha_c )$" src="form_1274.png"/></td></tr>
    <tr><td class="paramname">alvisg</td><td>Visible albedo of underlying surface <img class="formulaInl" alt="$[ ] ( \alpha_g )$" src="form_1275.png"/></td></tr>
    <tr><td class="paramname">alnirg</td><td>Near-IR albedo of underlying surface <img class="formulaInl" alt="$[ ] ( \alpha_g )$" src="form_1275.png"/></td></tr>
    <tr><td class="paramname">trvisc</td><td>Visible transmissivity of vegetation canopy <img class="formulaInl" alt="$[ ] ( \tau_c )$" src="form_1276.png"/></td></tr>
    <tr><td class="paramname">trnirc</td><td>Near-IR transmissivity of vegetation canopy <img class="formulaInl" alt="$[ ] ( \tau_c )$" src="form_1276.png"/></td></tr>
    <tr><td class="paramname">fsvf</td><td>Sky view factor of ground underlying canopy <img class="formulaInl" alt="$[ ] ( \chi )$" src="form_1277.png"/></td></tr>
    <tr><td class="paramname">crib</td><td>Richardson number coefficient <img class="formulaInl" alt="$[K^{-1} ]$" src="form_1278.png"/></td></tr>
    <tr><td class="paramname">cphchc</td><td>Latent heat of vaporization on vegetation canopy <img class="formulaInl" alt="$[J kg^{-1} ] (L_v )$" src="form_1279.png"/></td></tr>
    <tr><td class="paramname">cphchg</td><td>Latent heat of vaporization on underlying ground <img class="formulaInl" alt="$[J kg^{-1} ] (L_v )$" src="form_1279.png"/></td></tr>
    <tr><td class="paramname">cevap</td><td>Soil evaporation efficiency coefficient [ ]</td></tr>
    <tr><td class="paramname">tadp</td><td>Dew point of air at reference height [K]</td></tr>
    <tr><td class="paramname">tvirta</td><td>Virtual potential temperature of air at reference height <img class="formulaInl" alt="$[K] (T_{a,v} )$" src="form_1280.png"/></td></tr>
    <tr><td class="paramname">rc</td><td>Stomatal resistance of vegetation <img class="formulaInl" alt="$[s m^{-1}] (r_c )$" src="form_1281.png"/></td></tr>
    <tr><td class="paramname">rbcoef</td><td>Parameter for calculation of leaf boundary resistance</td></tr>
    <tr><td class="paramname">zosclh</td><td>Ratio of roughness length for heat to reference height for temperature and humidity [ ]</td></tr>
    <tr><td class="paramname">zosclm</td><td>Ratio of roughness length for momentum to reference height for wind speed [ ]</td></tr>
    <tr><td class="paramname">zrslfh</td><td>Difference between reference height for temperature and humidity and height at which extrapolated wind speed goes to zero [m]</td></tr>
    <tr><td class="paramname">zrslfm</td><td>Difference between reference height for wind speed and height at which extrapolated wind speed goes to zero [m]</td></tr>
    <tr><td class="paramname">zoh</td><td>Surface roughness length for heat [m]</td></tr>
    <tr><td class="paramname">zom</td><td>Surface roughness length for momentum <img class="formulaInl" alt="$[m] (z_{0,m} )$" src="form_1282.png"/></td></tr>
    <tr><td class="paramname">fcor</td><td>Coriolis parameter <img class="formulaInl" alt="$[s_{-1} ]$" src="form_1283.png"/></td></tr>
    <tr><td class="paramname">gconst</td><td>Intercept used in equation relating surface heat flux to surface temperature <img class="formulaInl" alt="$[W m^{-2} ]$" src="form_235.png"/></td></tr>
    <tr><td class="paramname">gcoeff</td><td>Multiplier used in equation relating surface heat flux to surface temperature <img class="formulaInl" alt="$[W m^{-2} K^{-1} ]$" src="form_1284.png"/></td></tr>
    <tr><td class="paramname">tgnd</td><td>Starting point for surface temperature iteration [K]</td></tr>
    <tr><td class="paramname">trsnow</td><td>Short-wave transmissivity of snow pack [ ]</td></tr>
    <tr><td class="paramname">fsnowc</td><td>Fractional coverage of canopy by frozen water <img class="formulaInl" alt="$[ ] (F_s )$" src="form_1285.png"/></td></tr>
    <tr><td class="paramname">frainc</td><td>Fractional coverage of canopy by liquid water <img class="formulaInl" alt="$[ ] (F_l )$" src="form_1286.png"/></td></tr>
    <tr><td class="paramname">chcap</td><td>Heat capacity of vegetation canopy <img class="formulaInl" alt="$[J m^{-2} K^{-1} ] (C_c )$" src="form_1287.png"/></td></tr>
    <tr><td class="paramname">cmass</td><td>Mass of vegetation canopy <img class="formulaInl" alt="$[kg m^{-2} ]$" src="form_232.png"/></td></tr>
    <tr><td class="paramname">pcpr</td><td>Surface precipitation rate <img class="formulaInl" alt="$[kg m^{-2} s^{-1} ]$" src="form_219.png"/></td></tr>
    <tr><td class="paramname">rhosno</td><td>Density of snow <img class="formulaInl" alt="$[kg m^{-3} ]$" src="form_234.png"/></td></tr>
    <tr><td class="paramname">zsnow</td><td>Depth of snow pack [m] <img class="formulaInl" alt="$(z_s)$" src="form_1288.png"/></td></tr>
    <tr><td class="paramname">froot</td><td>Fraction of total transpiration contributed by soil layer [ ]</td></tr>
    <tr><td class="paramname">thlmin</td><td>Residual soil liquid water content remaining after freezing or evaporation <img class="formulaInl" alt="$[m^{3} m^{-3} ]$" src="form_1289.png"/></td></tr>
    <tr><td class="paramname">thliq</td><td>Volumetric liquid water content of soil layers <img class="formulaInl" alt="$[m^{3} m^{-3} ]$" src="form_1289.png"/></td></tr>
    <tr><td class="paramname">delzw</td><td>Permeable thickness of soil layer [m]</td></tr>
    <tr><td class="paramname">iwater</td><td>Flag indicating condition of surface (dry, water-covered or snow-covered)</td></tr>
    <tr><td class="paramname">ievap</td><td>Flag indicating whether surface evaporation is occurring or not output variable</td></tr>
    <tr><td class="paramname">iterct</td><td>Counter of number of iterations required to solve energy balance for four subareas </td></tr>
  </table>
  </dd>
</dl>
<p>For the subcanopy surface temperature iteration, two alternative schemes are offered: the bisection method (selected if the flag ITCG = 1) and the Newton-Raphson method (selected if ITCG = 2). In the first case, the maximum number of iterations ITERMX is set to 12, and in the second case it is set to 5. An optional windless transfer coefficient EZERO is made available, which can be used, following the recommendations of Brown et al. (2006) <a class="el" href="citelist.html#CITEREF_Brown2006-ec">[18]</a>, to prevent the sensible heat flux over snow packs from becoming vanishingly small under highly stable conditions. If the snow cover flag ISNOW is zero (indicating bare ground), EZERO is set to zero; if ISNOW=1, EZERO is set to <img class="formulaInl" alt="$2.0 W m^{-2} K^{-1}$" src="form_1290.png"/> . The surface transfer coefficient under conditions of free convection, RAGCO, is set to <img class="formulaInl" alt="$1.9 x 10^{-3}$" src="form_1291.png"/> (see the calculation of RAGINV below).</p>
<p>In the 50 loop, some preliminary calculations are done. The shortwave transmissivity at the surface, TRTOP, is set to zero in the absence of a snow pack, and to the transmissivity of snow, TRSNOW, otherwise. The net shortwave radiation at the surface, QSWNG, is calculated as the sum of the net visible and net near-infrared shortwave radiation. Each of these is obtained as: <img class="formulaInl" alt="$K_{*g} = K \downarrow \tau_c [1 - \alpha_g ]$" src="form_1292.png"/> where <img class="formulaInl" alt="$K_{*g} is the net radiation at the surface, $" src="form_1293.png"/>K  <img class="formulaInl" alt="$ is the incoming shortwave radiation above the canopy, $" src="form_1294.png"/>$ is the canopy transmissivity and <img class="formulaInl" alt="$\alpha_g$" src="form_930.png"/> is the surface albedo. This average value is corrected for the amount of radiation transmitted into the surface, QTRANS, obtained using TRTOP. The net shortwave radiation for the vegetation canopy, QSWNC, is calculated as the sum of the net visible and net near-infrared shortwave radiation. Each of these is determined as: <img class="formulaInl" alt="$K_{*c} = K \downarrow [1 - \alpha_c ] - K_{*g}$" src="form_1295.png"/> where <img class="formulaInl" alt="$K_{*c} is the net radiation on the canopy and $" src="form_1296.png"/>$ is the canopy albedo. If the canopy temperature is essentially 0 K, indicating that a canopy was not present in the previous time step but has now appeared, the canopy temperature is initialized to the potential temperature of the air, TPOTA. The outgoing longwave radiation emitted upward <img class="formulaInl" alt="$(L \uparrow_c )$" src="form_1297.png"/> or downward <img class="formulaInl" alt="$(L \downarrow_c )$" src="form_1298.png"/> from the canopy is calculated using the standard Stefan-Boltzmann equation: <img class="formulaInl" alt="$L \uparrow_c = L \downarrow_c = \sigma T_c^4$" src="form_1299.png"/> where <img class="formulaInl" alt="$\sigma$" src="form_358.png"/> is the Stefan-Boltzmann constant and <img class="formulaInl" alt="$T_c$" src="form_144.png"/> is the canopy temperature.</p>
<p>Virtual temperature is defined as temperature adjusted for the reduction in air density due to the presence of water vapour. This is applied in order to enable the use of the equation of state for dry air. The virtual temperature can be approximated by multiplying the actual temperature by a factor [1 + 0.61 q], where q is the specific humidity of the air in question. Thus, the virtual temperature of air at the vegetation canopy temperature, <img class="formulaInl" alt="$T_{c,v}$" src="form_1300.png"/> , is obtained as: <img class="formulaInl" alt="$T_{c,v} = T_c [1 + 0.61 q_c ]$" src="form_1301.png"/> where <img class="formulaInl" alt="$q_c$" src="form_1302.png"/> is the saturated specific humidity at the canopy temperature. This is determined from the saturation mixing ratio at the canopy temperature, <img class="formulaInl" alt="$w_c$" src="form_1303.png"/> : <img class="formulaInl" alt="$q_c = w_c /[1 + w_c ]$" src="form_1304.png"/> The saturation mixing ratio is a function of the saturation vapour pressure <img class="formulaInl" alt="$e_c$" src="form_1305.png"/> at the canopy temperature: <img class="formulaInl" alt="$w_c = 0.622 e_c /(p_{dry} )$" src="form_1306.png"/> where <img class="formulaInl" alt="$p_{dry}$" src="form_298.png"/> is the partial pressure of dry air. A standard empirical equation for the saturation vapour pressure dependence on the temperature T is used:</p>
<p><img class="formulaInl" alt="$e_{sat} = 611.0 exp[17.269(T - T_f )/(T - 35.86)] T \geq T_f$" src="form_1307.png"/> <img class="formulaInl" alt="$e_{sat} = 611.0 exp[21.874(T - T_f )/(T - 7.66)] T < T_f$" src="form_1308.png"/></p>
<p>where <img class="formulaInl" alt="$T_f$" src="form_293.png"/> is the freezing point. The virtual temperature of the air in the canopy space, <img class="formulaInl" alt="$T_{ac,v}$" src="form_1309.png"/> , is likewise calculated from the canopy air temperature <img class="formulaInl" alt="$T_{ac}$" src="form_1310.png"/> and the specific humidity in the canopy air space, <img class="formulaInl" alt="$q_{ac}$" src="form_1311.png"/> , as</p>
<p><img class="formulaInl" alt="$T_{ac,v} = T_{ac} [1 + 0.61 q_{ac} ]$" src="form_1312.png"/></p>
<p>If the Newton-Raphson method is being used for the canopy temperature iteration (pre-selected by setting the flag ITC to 2), the temperature of the air in the canopy space is approximated as the canopy temperature, and the specific humidity in the canopy air space is approximated as the specific humidity of the air above the canopy.</p>
<p>If there is intercepted snow on the vegetation, the latent heat associated with water flux from the canopy, CPHCHC, is set to the latent heat of sublimation (the sum of the heat of vaporization and the heat of melting). Otherwise the latent heat is set to that of vaporization alone. The leaf boundary layer resistance RB, and its inverse RBINV, are calculated using the wind speed in the canopy air space, VAC, and a coefficient RBCOEF evaluated in subroutine APREP. This coefficient is formulated after Bartlett (2004), who developed an expression for the inverse of the leaf boundary resistance, <img class="formulaInl" alt="$1/r_b$" src="form_1313.png"/> , drawing on the analysis of Bonan (1996) <a class="el" href="citelist.html#CITEREF_Bonan1996-as">[17]</a> and McNaughton and van den Hurk (1995), of the form:</p>
<p><img class="formulaInl" alt="$1/r_b = v_{ac}^{1/2} \sigma f_i \gamma_i \Lambda_i^{1/2} /0.75 [1 - exp(-0.75 \Lambda_i^{1/2})]$" src="form_1314.png"/></p>
<p>where <img class="formulaInl" alt="$v_{ac}$" src="form_1315.png"/> is the wind speed in the canopy air space, <img class="formulaInl" alt="$f_i$" src="form_461.png"/> is the fractional coverage of each vegetation type i over the subarea in question, <img class="formulaInl" alt="$\Lambda_i$" src="form_1316.png"/> is its leaf area index, and <img class="formulaInl" alt="$\gamma_i$" src="form_1317.png"/> is a vegetation-dependent parameter which incorporates the effects of leaf dimension and sheltering. The initial value of the surface temperature TZERO is set to TGND, which contains the value of TZERO from the previous time step, and the initial temperature of the canopy, TCANO, is set to the current canopy temperature. The first step in the iteration sequence, TSTEP, is set to 1.0 K. The flag ITER is set to 1 for each element of the set of modelled areas, indicating that its surface temperature has not yet been found. The iteration counter NITER is initialized to 1 for each element. Initial values are assigned to other variables.In particular, the maximum evaporation from the ground surface that can be sustained for the current time step is specified as the total snow mass if snow is present, otherwise as the total available water in the first soil layer.</p>
<p>(At this point in the code, if CLASS is being run in coupled mode with CTEM, the CTEM subroutine PHTSYN3 is called. These lines are commented out for uncoupled runs.)</p>
<p>The 100 continuation line marks the beginning of the surface temperature iteration sequence. First the flag NUMIT (indicating whether there are still locations at the end of the current iteration step for which the surface temperature has not yet been found) is set to zero. Loop 125 is then performed over the vector of modelled areas. If ITER=1, the saturated specific humidity at the ground surface temperature, <img class="formulaInl" alt="$q(0)_{sat}$" src="form_1318.png"/> , is calculated using the same method as that outlined above for the saturated specific humidity at the canopy temperature. If there is a snow cover or ponded water present on the surface (IWATER &gt; 0), the surface evaporation efficiency EVBETA is set to 1 and the surface specific humidity q(0) is set to <img class="formulaInl" alt="$q(0)_{sat}$" src="form_1318.png"/> . Otherwise EVBETA is set to CEVAP, the value obtained in subroutine TPREP on the basis of ambient conditions, and q(0) is calculated from <img class="formulaInl" alt="$q(0)_{sat}$" src="form_1318.png"/> by making use of the definition of the surface evaporation efficiency <img class="formulaInl" alt="$\beta$" src="form_451.png"/>:</p>
<p><img class="formulaInl" alt="$\beta = [q(0) - q_{ac} ]/[q(0)_{sat} - q_{ac} ]$" src="form_1319.png"/></p>
<p>which is inverted to obtain an expression for q(0). If <img class="formulaInl" alt="$q(0) > q_{ac}$" src="form_1320.png"/> and the evaporation flag IEVAP has been set to zero, EVBETA is reset to zero and q(0) is reset to <img class="formulaInl" alt="$q_{ac}$" src="form_1311.png"/>.</p>
<p>Next, the potential temperature of air at the ground surface temperature, <img class="formulaInl" alt="$T(0)_{pot}$" src="form_1321.png"/> , is calculated relative to the sum of the displacement height d and the roughness length for momentum <img class="formulaInl" alt="$z_{0,m}$" src="form_1322.png"/> , the height at which the canopy temperature is assumed to apply. (This is also the height corresponding to the potential temperature of the air at the reference height above the canopy). <img class="formulaInl" alt="$T(0)_{pot}$" src="form_1321.png"/> is found using the dry adiabatic lapse rate, <img class="formulaInl" alt="$dT/dz = -g/c_p$" src="form_321.png"/> , where g is the acceleration due to gravity and <img class="formulaInl" alt="$c_p$" src="form_322.png"/> is the specific heat at constant pressure. Since the displacement height d is assumed to lie at 0.7 of the canopy height, and the roughness length for momentum is assumed to lie at 0.1 of the canopy height, their sum can be obtained as <img class="formulaInl" alt="$8.0 z_{0,m}$" src="form_1323.png"/> . Thus, <img class="formulaInl" alt="$T(0)_{pot} = T(0) - 8.0 z_{0,m} g/c_p$" src="form_1324.png"/></p>
<p>The virtual potential temperature at the surface is obtained using the same expression as above: <img class="formulaInl" alt="$T(0)_v = T(0)_{pot} [1 + 0.61 q(0)]$" src="form_1325.png"/></p>
<p>Since wind speeds under the canopy are expected to be relatively small, it is assumed that under stable or neutral conditions, turbulent fluxes are negligible. If the virtual potential temperature of the surface is more than 1 K greater than that of the canopy air, free convection conditions are assumed. Townsend's (1964) equation for the surface-air transfer coefficient, or the inverse of the surface resistance <img class="formulaInl" alt="$r_{a,,g}$" src="form_1326.png"/> , is used in a form derived from the analysis of Deardorff (1972) <a class="el" href="citelist.html#CITEREF_Deardorff1972-ay">[29]</a> : <img class="formulaInl" alt="$1/r_{a,,g} = 1.9 x 10^{-3} [T(0)_v - T_{ac,v} ]^{1/3}$" src="form_1327.png"/></p>
<p>The first derivative of the transfer coefficient with respect to the surface temperature is calculated for use with the Newton-Raphson iteration scheme: <img class="formulaInl" alt="$d(1/r_{a,,g} )/dT = 1.9 x 10^{-3} [T(0)_v - T_{ac,v} ]^{-2/3} /3$" src="form_1328.png"/></p>
<p>If the virtual potential temperature of the surface is between 0.001 and 1 K greater than that of the canopy air, a simple diffusion relation is assumed: <img class="formulaInl" alt="$1/r_{a,,g} = 1.9 x 10^{-3} [T(0)_v - T_{ac,v} ]$" src="form_1329.png"/> Thus, <img class="formulaInl" alt="$d(1/r_{a,,g} )/dT = 1.9 x 10^{-3}$" src="form_1330.png"/></p>
<p>The remaining terms of the surface energy balance are now evaluated. The energy balance equation is expressed as: <img class="formulaInl" alt="$K_{*g} + L_{*g} - Q_{H,g} - Q_{E,g} - G(0) = 0$" src="form_1331.png"/> where <img class="formulaInl" alt="$K_{*g}$" src="form_1332.png"/> is the net surface shortwave radiation, <img class="formulaInl" alt="$L_{*g}$" src="form_1333.png"/> is the net longwave radiation, <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> is the sensible heat flux, <img class="formulaInl" alt="$Q_{E,g}$" src="form_1335.png"/> is the latent heat flux, and G(0) is the conduction into the surface. <img class="formulaInl" alt="$K_{*g}$" src="form_1332.png"/> was evaluated earlier in loop 50. <img class="formulaInl" alt="$L_{*g}$" src="form_1333.png"/> is calculated as the difference between the downwelling radiation <img class="formulaInl" alt="$L \downarrow_g$" src="form_1336.png"/> at the surface and the upwelling radiation <img class="formulaInl" alt="$L \uparrow_g$" src="form_1337.png"/> . The downwelling radiation incident on the surface is determined from the downwelling sky radiation above the canopy <img class="formulaInl" alt="$L \downarrow$" src="form_1338.png"/> and the downwelling radiation from the canopy itself, <img class="formulaInl" alt="$L \downarrow_c$" src="form_1339.png"/> , weighted according to the sky view factor <img class="formulaInl" alt="$\chi$" src="form_29.png"/>: <img class="formulaInl" alt="$L \downarrow_g = \chi L \downarrow + [1 - \chi] L \downarrow_c$" src="form_1340.png"/> The upwelling radiation is obtained using the Stefan-Boltzmann equation: <img class="formulaInl" alt="$L \uparrow_g = \sigma T(0)^4$" src="form_1341.png"/></p>
<p>The sensible heat flux is given by <img class="formulaInl" alt="$Q_{H,g} = \rho_a c_p [T(0)_{pot} - T_{a,c} ]/r_{a,,g}$" src="form_1342.png"/> where <img class="formulaInl" alt="$\rho_a$" src="form_346.png"/> is the density of the air and <img class="formulaInl" alt="$c_p$" src="form_322.png"/> is its specific heat. (The windless transfer coefficient defined at the beginning of the subroutine is currently not used under vegetation canopies.) The evaporation rate at the surface, E(0), is calculated as <img class="formulaInl" alt="$E(0) = \rho_a [q(0) - q_{a,c} ]/r_{a,,g}$" src="form_1343.png"/></p>
<p>The evaporation rate is constrained to be less than or equal to the maximum rate evaluated earlier in the subroutine. <img class="formulaInl" alt="$Q_E$" src="form_424.png"/> is obtained by multiplying E(0) by the latent heat of vaporization at the surface. The heat flux into the surface G(0) is determined as a linear function of T(0) (see documentation for subroutines TNPREP and TSPREP). It can be seen that each of the terms of the surface energy balance is a function of a single unknown, T(0) or TZERO. The residual RESID of the energy balance is now evaluated on the basis of the current estimation for TZERO. If the absolute value of RESID is less than <img class="formulaInl" alt="$5.0 W m^{-2}$" src="form_1344.png"/> , or if the absolute value of the iteration step TSTEP most recently used is less than 0.01 K, the surface temperature is deemed to have been found and ITER is set to 0. If the iteration counter NITER is equal to the maximum number and ITER is still 1, ITER is set to -1.</p>
<p>In the following section, the iteration sequence is moved ahead a step. If ITCG = 1, the calculations for the bisection method of solution in loop 150 are performed, over each of the modelled areas for which ITER = 1. If NITER = 1 (indicating that this is the first step in the iteration), then if RESID &gt; 0 (indicating that the current value for TZERO had undershot the correct value), TZERO is incremented by 1 K; otherwise it is decremented by 1 K. If this is not the first step in the iteration, then if RESID &gt;0 and TSTEP &lt; 0 (indicating that TZERO has undershot the correct value and the last temperature increment had been a negative one) or if RESID &lt; 0 and TSTEP &gt; 0 (indicating that TZERO has overshot the correct value and the last temperature increment had been a positive one), TSTEP is divided in half and its sign changed. TSTEP is then added to TZERO. The iteration counter NITER and the flag NUMIT are each incremented by one. Finally, if NUMIT &gt; 0, the iteration cycle is repeated from line 100 on.</p>
<p>If ITCG = 2, the calculations for the Newton-Raphson method of iteration in loop 175 are performed, over each of the modelled areas for which ITER = 1. In this approach, the value <img class="formulaInl" alt="$x_{n+1}$" src="form_1345.png"/> used at each iteration step is obtained from the value <img class="formulaInl" alt="$x_n$" src="form_1346.png"/> at the previous step as follows: <img class="formulaInl" alt="$x_{n+1} = x_n - f(x_n )/f'(x_n )$" src="form_1347.png"/></p>
<p>Identifying x n with TZERO and <img class="formulaInl" alt="$f(x_n )$" src="form_1348.png"/> with the surface energy balance equation, it can be seen that the second term on the right-hand side corresponds to TSTEP; the numerator is equal to RESID and the denominator to the first derivative of the energy balance equation evaluated at TZERO, which in turn is equal to the sum of the derivatives of the individual terms: f[ d(L  )/dT = -4  T(0)^3 f]f[ d(Q_{H,g} )/dT =  c_p {1/r_{a,,g} + [T(0)_{pot} - T_{ac} ] d(1/r_{a,,g} )/dT} f]f[ d(Q_{E,g} )/dT = L_v  {1/r_{a,,g} dq(0)/dT+ [q(0) - q_{ac} ] d(1/r_{a,,g} )/dT} f] and dG(0)/dT is equal to the coefficient multiplying TZERO in the equation for G(0). ( <img class="formulaInl" alt="$L_v$" src="form_1155.png"/> is the latent heat of vaporization at the surface.) At the end of the calculations the iteration counter NITER and the flag NUMIT are each incremented by one, and upon exiting the loop, if NUMIT &gt; 0, the iteration cycle is repeated from line 100 on.</p>
<p>After the iteration has been completed, if the Newton-Raphson method has been used, a check is carried out in loop 200 to ascertain whether convergence has not been reached (i.e. whether ITER = -1) for any location. In such cases it is assumed that conditions of near-neutral stability at the surface are the cause of the difficulty in finding a solution. A trial value of TZERO is calculated using the virtual potential temperature of the canopy. If the absolute value of RESID is <img class="formulaInl" alt="$> 15 W m^{-2}$" src="form_1349.png"/> , TZERO is set to this trial value. The values of q(0) and the components of the surface energy balance are recalculated as above, except that <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> and <img class="formulaInl" alt="$Q_{E,g}$" src="form_1335.png"/> are assumed as a first approximation to be zero. RESID is determined on this basis, and is then partitioned between <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> and <img class="formulaInl" alt="$Q_{E,g}$" src="form_1335.png"/> on the basis of the Bowen ratio B, the ratio of <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> over <img class="formulaInl" alt="$Q_{E,g}$" src="form_1335.png"/> . Setting the residual R equal to <img class="formulaInl" alt="$Q_{H,g} + Q_{E,g}$" src="form_1350.png"/> , and substituting for <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> using <img class="formulaInl" alt="$B = Q_{H,g} /Q_{E,g}$" src="form_1351.png"/> , results in: <img class="formulaInl" alt="$Q_{E,g} = R/(1 + B)$" src="form_1352.png"/> <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> is then obtained as <img class="formulaInl" alt="$R - Q_{E,g}$" src="form_1353.png"/> , the residual is reset to zero, and E(0) is recalculated from <img class="formulaInl" alt="$Q_{E,g}$" src="form_1335.png"/> .</p>
<p>At this point a check is performed for unphysical values of the surface temperature, i.e. for values greater than 100 C or less than -100 C. If such values are encountered, an error message is printed and a call to abort is carried out.</p>
<p>Finally, clean-up calculations are performed in loop 250. A check is carried out to ensure that TZERO is not less than 0 C if ponded water is present on the surface (IWATER = 1) or greater than 0 C if snow is present on the surface (IWATER = 2). If either is the case, TZERO is reset to the freezing point, and q(0), <img class="formulaInl" alt="$T(0)_{pot}$" src="form_1321.png"/> and <img class="formulaInl" alt="$T(0)_v$" src="form_1354.png"/> are re-evaluated. The components of the surface energy balance are recalculated using the above equations. The residual of the energy balance equation is assigned to the energy associated with phase change of water at the surface, QMELTG, and RESID is set to zero.</p>
<p>In the last part of the loop, some final adjustments are made to a few other variables. If the evaporation flux is vanishingly small, it is added to RESID and reset to zero. Any remaining RESID is added to <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> . Lastly, the iteration counter ITERCT is updated for the level corresponding to the subarea type and the value of NITER.</p>
<p>In the 300 loop, preliminary calculations are done in preparation for the canopy temperature iteration. The sensible heat flux from the surface is treated differently if ITC = 1 (bisection method of solution) and ITC = 2 (Newton-Raphson method of solution). In the first instance the surface sensible heat flux is applied to heating the air in the canopy space; in the second, the canopy and the air space within it are treated as one aggregated mass, and the sensible heat flux from below is assumed to be added to its energy balance. Thus, if ITC = 1, the sensible heat flux that is added to the canopy, QSGADD, is set to 0. If ITC = 2, it is set to <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> ; and <img class="formulaInl" alt="$T_{ac}$" src="form_1310.png"/> is set to <img class="formulaInl" alt="$T_c$" src="form_144.png"/> , <img class="formulaInl" alt="$q_{ac}$" src="form_1311.png"/> to <img class="formulaInl" alt="$q_c$" src="form_1302.png"/> , and <img class="formulaInl" alt="$T_{ac,v}$" src="form_1309.png"/> to <img class="formulaInl" alt="$T_{c,v}$" src="form_1300.png"/> . The flag ITER is set to 1 for each element of the set of modelled areas, indicating that its surface temperature has not yet been found. The iteration counter NITER is initialized to 1 for each element. The first step in the iteration sequence, TSTEP, is set to 1.0 K. Initial values are assigned to other variables. In the following 350 loop, the water available for transpiration, WAVAIL, is evaluated for each soil layer. Lastly, after exiting the loop, the maximum number of iterations ITERMX is set to 50 if ITC = 1, and to 5 if ITC = 2.</p>
<p>The 400 continuation line marks the beginning of the canopy temperature iteration sequence. First the flags NIT (indicating whether there are still locations at the beginning of the current iteration step for which the surface temperature has not yet been found) and NUMIT (indicating whether there are still locations at the end of the current iteration step for which the surface temperature has not yet been found) are set to zero. Loop 450 is then performed over the set of modelled areas. If ITER=1, NIT is incremented by one; if ITC = 1, the vegetation virtual temperature <img class="formulaInl" alt="$T_{c,v}$" src="form_1300.png"/> is recalculated.</p>
<p>If NIT &gt; 0, a subroutine is called to evaluate the stability-corrected surface drag coefficients for heat and momentum. The subroutine selection is made on the basis of the flag ISLFD. If ISLFD=1, indicating that the calculations are to be consistent with CCCma conventions, subroutine DRCOEF is called; if ISLFD=2, indicating that the calculations are to be consistent with RPN conventions, subroutine FLXSURFZ is called.</p>
<p>Next, canopy parameters and turbulent transfer coefficients are calculated prior to evaluating the terms of the surface energy balance equation. If ITC = 1, the analysis of Garratt (1992) <a class="el" href="citelist.html#CITEREF_Garratt1992-dt">[36]</a> is followed. The sensible and latent heat fluxes from the canopy air to the overlying atmosphere, <img class="formulaInl" alt="$Q_H$" src="form_423.png"/> and <img class="formulaInl" alt="$Q_E$" src="form_424.png"/> , are obtained as the sums of the sensible and latent heat fluxes from the canopy to the canopy air, <img class="formulaInl" alt="$Q_{H,c}$" src="form_1355.png"/> and <img class="formulaInl" alt="$Q_{E,c}$" src="form_1356.png"/> , and from the underlying surface to the canopy air, <img class="formulaInl" alt="$Q_{H,g}$" src="form_1334.png"/> and <img class="formulaInl" alt="$Q_{E,g}$" src="form_1335.png"/> :</p>
<p><img class="formulaInl" alt="$Q_H = Q_{H,c} + Q_{H,g}$" src="form_1357.png"/></p>
<p><img class="formulaInl" alt="$Q_E = Q_{E,c} + Q_{E,g}$" src="form_1358.png"/></p>
<p>where</p>
<p><img class="formulaInl" alt="$Q_H = \rho_a c_p [T_{a,c} - T_{a,pot,} ]/r_a$" src="form_1359.png"/></p>
<p><img class="formulaInl" alt="$Q_{H,c} = \rho_a c_p [T_c - T_{a,c,} ]/r_b$" src="form_1360.png"/></p>
<p>and</p>
<p><img class="formulaInl" alt="$Q_E = L_v \rho_a [q_{a,c} - q_{a,} ]/r_a$" src="form_1361.png"/></p>
<p><img class="formulaInl" alt="$Q_{E,c} = L_v \rho_a [q_{,c} - q_{a,c,} ]/(r_b + r_c )$" src="form_1362.png"/></p>
<p>The equations for the sensible and latent heat fluxes from the surface were presented above. In these expressions, <img class="formulaInl" alt="$T_{a,pot}$" src="form_320.png"/> and <img class="formulaInl" alt="$q_a$" src="form_291.png"/> are the potential temperature and specific humidity of the air overlying the canopy, <img class="formulaInl" alt="$r_a$" src="form_1363.png"/> is the aerodynamic resistance to turbulent transfer between the canopy air and the overlying air, and <img class="formulaInl" alt="$r_c$" src="form_183.png"/> is the stomatal resistance to transpiration. (The term CFLUX that is generated by the subroutines DRCOEF and FLXSURFZ is equivalent to <img class="formulaInl" alt="$1/r_a$" src="form_1364.png"/> .) Thus, <img class="formulaInl" alt="$T_{a,c}$" src="form_1365.png"/> and <img class="formulaInl" alt="$q_{a,c}$" src="form_1366.png"/> can be evaluated as</p>
<p><img class="formulaInl" alt="$T_{a,c} = [T_{a,pot} /r_a + T_c /r_b + T(0)_{pot} /r_{a,,g} ]/[1/r_a + 1/r_b + 1/r_{a,,g} ]$" src="form_1367.png"/> <img class="formulaInl" alt="$q_{a,c} = [q_a /r_a + q_c /(r_b + r_c ) + q(0)/r_{a,,g} ]/[1/r_a + 1/(r_b + r_c ) + 1/r_{a,,g} ]$" src="form_1368.png"/></p>
<p>If the water vapour flux is towards the canopy leaves, or if the canopy is snow-covered or rain-covered, <img class="formulaInl" alt="$r_c$" src="form_183.png"/> is zero. If the water vapour flux is away from the canopy leaves and the fractional snow or water coverage on the canopy, <img class="formulaInl" alt="$F_s$" src="form_1369.png"/> or <img class="formulaInl" alt="$F_l$" src="form_1370.png"/> , is less than 1, the term <img class="formulaInl" alt="$1/(r_b + r_c )$" src="form_1371.png"/> adjusted for the presence of intercepted snow or water, <img class="formulaInl" alt="$X_E$" src="form_1372.png"/> (XEVAP in the code) is calculated as a weighted average, as follows. If <img class="formulaInl" alt="$F_s > 0$" src="form_1373.png"/>, the canopy must be at a temperature of 0 C or less, and so it is deduced that no transpiration can be occurring. Thus, <img class="formulaInl" alt="$X_E = (F_s + F_l )/r_b$" src="form_1374.png"/> .</p>
<p>Otherwise, <img class="formulaInl" alt="$X_E$" src="form_1372.png"/> is calculated on the assumption that the resistance is equal to <img class="formulaInl" alt="$r_b$" src="form_1375.png"/> over the water-covered area and <img class="formulaInl" alt="$r_b + r_c$" src="form_1376.png"/> over the rest: <img class="formulaInl" alt="$X_E = F_l /r_b + [1 - F_l ]/[r_b + r_c ]$" src="form_1377.png"/></p>
<p>In the 450 loop, XEVAP is first set as a trial value to RBINV (neglecting stomatal resistance), and QAC is calculated using this value. If <img class="formulaInl" alt="$q_{a,c} < q_c$" src="form_1378.png"/> , indicating that the vapour flux is away from the canopy leaves, XEVAP is recalculated as above and QAC is re-evaluated. Otherwise, if <img class="formulaInl" alt="$F_s > 0$" src="form_1373.png"/>, XEVAP is scaled by <img class="formulaInl" alt="$F_s$" src="form_1369.png"/> , since it is assumed that snow on the canopy will be at a lower temperature than the canopy itself, and deposition via sublimation will occur preferentially onto it. <img class="formulaInl" alt="$T_{a,c}$" src="form_1365.png"/> and <img class="formulaInl" alt="$T_{ac,v}$" src="form_1309.png"/> are calculated as above, and the canopy-air turbulent transfer coefficients for sensible and latent heat flux, CFSENS and CFEVAP, are set to RBINV and XEVAP respectively.</p>
<p>If ITC = 2, the canopy parameters and turbulent transfer coefficients are calculated, as noted above, on the basis of the assumption that the vegetation canopy and the air space within it can be treated as one aggregated mass, with a single representative temperature. Thus, the resistances <img class="formulaInl" alt="$r_a$" src="form_1363.png"/> and <img class="formulaInl" alt="$r_b$" src="form_1375.png"/> are considered as acting in series upon the sensible and latent heat fluxes between the canopy and the overlying air:</p>
<p><img class="formulaInl" alt="$Q_{H,c} = \rho_a c_p [T_{,c} - T_{a,pot,} ]/(r_a + r_b )$" src="form_1379.png"/></p>
<p><img class="formulaInl" alt="$Q_{E,c} = L_v \rho_a [q_{,c} - q_{a,} ]/(r_a + r_b + r_c )$" src="form_1380.png"/></p>
<p>In loop 500 the term <img class="formulaInl" alt="$1/(r_a + r_b )$" src="form_1381.png"/> is calculated from the variables CFLUX (the inverse of <img class="formulaInl" alt="$r_a$" src="form_1363.png"/> ) and RBINV (the inverse of <img class="formulaInl" alt="$r_b$" src="form_1375.png"/> ), and assigned to the temporary variable CFLX. If the incoming visible shortwave radiation QSWINV is greater than or equal to <img class="formulaInl" alt="$25 W m^{-2}$" src="form_1382.png"/> , the calculated value of CFLX is retained; if QSWINV is zero, it is reset to CFLUX; and between these two limits it varies linearly between the two.</p>
<p>Thus the effect of the calculated leaf boundary resistance is suppressed during conditions of zero or low solar heating. (This is done to avoid unrealistically low calculated turbulent fluxes at night, which can lead to anomalously low canopy temperatures.) The overall aerodynamic resistance <img class="formulaInl" alt="$r_A = r_a + r_b$" src="form_1383.png"/> is obtained as 1/CFLX and assigned to the variable RA. As with ITC = 1, if <img class="formulaInl" alt="$q_a < q_c$" src="form_1384.png"/> , XEVAP is recalculated as above (except that <img class="formulaInl" alt="$r_A$" src="form_1385.png"/> is substituted for <img class="formulaInl" alt="$r_b$" src="form_1375.png"/> ). If <img class="formulaInl" alt="$F_s > 0$" src="form_1373.png"/>, XEVAP is again scaled by <img class="formulaInl" alt="$F_s$" src="form_1369.png"/> .</p>
<p>In the approach used here, the specific humidity of the aggregated canopy <img class="formulaInl" alt="$q_{0,c}$" src="form_1386.png"/> is not assumed to be equal to the saturated specific humidity at the canopy temperature, but is rather determined using <img class="formulaInl" alt="$X_E$" src="form_1372.png"/> . If the two methods of calculating <img class="formulaInl" alt="$Q_{E,c}$" src="form_1356.png"/> are assumed to be analogous:</p>
<p><img class="formulaInl" alt="$Q_{E,c} = L_v \rho_a X_E [q_{,c} - q_{a,} ]$" src="form_1387.png"/></p>
<p><img class="formulaInl" alt="$Q_{E,c} = L_v \rho_a [q_{,0,c} - q_{a,} ]/r_A$" src="form_1388.png"/></p>
<p>then solving for <img class="formulaInl" alt="$q_{0,c}$" src="form_1386.png"/> leads to the expression</p>
<p><img class="formulaInl" alt="$q_{0,c} = r_A X_E q_c + [1 - r_A X_E ]q_a$" src="form_1389.png"/></p>
<p>In the second part of the 500 loop the saturated specific humidity of the canopy is calculated as before and adjusted using the above equation to obtain the specific humidity of the aggregated canopy. This is then used to calculate <img class="formulaInl" alt="$T_{c,v}$" src="form_1300.png"/> . The canopy-air turbulent transfer coefficients for sensible and latent heat flux, CFSENS and CFEVAP, are both set to CFLX, and for calculation purposes in the following loop <img class="formulaInl" alt="$T_{a,c}$" src="form_1365.png"/> is set to the potential temperature of the air above the canopy, and <img class="formulaInl" alt="$q_{a,c}$" src="form_1366.png"/> to the specific humidity of the air above the canopy.</p>
<p>In the 525 loop, the terms of the canopy energy balance are evaluated. The energy balance is expressed as:</p>
<p><img class="formulaInl" alt="$K_{*c} + L_{*c} - Q_{H,c} + Q_{H,g+} - Q_{E,c} - \Delta Q_{S,c} = 0$" src="form_1390.png"/></p>
<p>(The term <img class="formulaInl" alt="$Q_{H,g+}$" src="form_1391.png"/> corresponds to the variable QSGADD discussed above; the term <img class="formulaInl" alt="$\Delta Q_{S,c}$" src="form_1392.png"/> represents the change of energy storage in the canopy.) The net shortwave radiation <img class="formulaInl" alt="$K_{*c}$" src="form_1393.png"/> was evaluated earlier in the 50 loop. The net longwave radiation is obtained as:</p>
<p><img class="formulaInl" alt="$L_{*c} = (1 - \chi) [L \downarrow + L \uparrow_g - 2 L \downarrow_c ]$" src="form_1394.png"/></p>
<p><img class="formulaInl" alt="$Q_{H,c}$" src="form_1355.png"/> is calculated as above. If there is intercepted liquid or frozen water on the canopy, or if the vapour flux is downward, or if the stomatal resistance is less than a limiting high value of <img class="formulaInl" alt="$5000 s m^{-1}$" src="form_1395.png"/> , the canopy vapour flux <img class="formulaInl" alt="$E_c$" src="form_1396.png"/> (that is, <img class="formulaInl" alt="$Q_{E,c} /L_v$" src="form_1397.png"/> ) is calculated as above and the flag IEVAPC is set to 1; otherwise <img class="formulaInl" alt="$E_c$" src="form_1396.png"/> and IEVAPC are both set to zero and <img class="formulaInl" alt="$q_c$" src="form_1302.png"/> is set to <img class="formulaInl" alt="$q_a$" src="form_291.png"/> . If the water vapour flux is towards the canopy and the canopy temperature is greater than the air dew point temperature, the flux is set to zero. In the following IF block, checks are done to ensure that the calculated canopy evapotranspiration flux will not exceed the available water. If intercepted snow is present on the canopy, the maximum evapotranspiration is set to this amount. Otherwise, if the calculated evapotranspiration rate exceeds the liquid water stored on the canopy, the rate is tested to ensure that the additional transpiration does not exhaust the available soil water weighted according to the root distribution. <img class="formulaInl" alt="$Q_{E,c}$" src="form_1356.png"/> is calculated from <img class="formulaInl" alt="$E_c$" src="form_1396.png"/> and <img class="formulaInl" alt="$\Delta Q_{S,c}$" src="form_1392.png"/> is obtained as</p>
<p><img class="formulaInl" alt="$\Delta Q_{S,c} = C_c [T_c - T_{c,o} ]/ \Delta t$" src="form_1398.png"/></p>
<p>where <img class="formulaInl" alt="$C_c$" src="form_143.png"/> is the canopy heat capacity, <img class="formulaInl" alt="$T_{c,o}$" src="form_1399.png"/> is the canopy temperature from the previous time step and <img class="formulaInl" alt="$\Delta t$" src="form_145.png"/> is the length of the time step. The residual RESID of the energy balance is evaluated on the basis of the current estimation for the canopy temperature TCAN. If the absolute value of RESID is less than <img class="formulaInl" alt="$5.0 W m^{-2}$" src="form_1344.png"/> , or if the absolute value of the iteration step TSTEP most recently used is less than 0.01 K, the surface temperature is deemed to have been found and ITER is set to 0. If the iteration counter NITER is equal to the maximum number and ITER is still 1, ITER is set to -1.</p>
<p>In the following section, the iteration sequence is moved ahead a step. If ITC = 1, the calculations for the bisection method of solution in loop 550 are performed, over each of the modelled areas for which ITER = 1. If NITER = 1 (indicating that this is the first step in the iteration), then if RESID &gt; 0 (indicating that the current value for TCAN had undershot the correct value), TCAN is incremented by 1 K; otherwise it is decremented by 1 K. If this is not the first step in the iteration, then if RESID &gt;0 and TSTEP &lt; 0 (indicating that TCAN has undershot the correct value and the last temperature increment had been a negative one) or if RESID &lt; 0 and TSTEP &gt; 0 (indicating that TCAN has overshot the correct value and the last temperature increment had been a positive one), TSTEP is divided in half and its sign changed. TSTEP is then added to TCAN. If TCAN is vanishingly close to 0 C, it is reset to that value. The iteration counter NITER and the flag NUMIT are each incremented by one. Finally, if NUMIT &gt; 0, the iteration cycle is repeated from line 400 on.</p>
<p>If ITC = 2, the calculations for the Newton-Raphson method of iteration in loop 575 are performed, over each of the modelled areas for which ITER = 1. As outlined above, in this approach the value <img class="formulaInl" alt="$x_{n+1}$" src="form_1345.png"/> used at each iteration step is obtained from the value <img class="formulaInl" alt="$x_n$" src="form_1346.png"/> at the previous step as follows:</p>
<p><img class="formulaInl" alt="$x_{n+1} = x_n - f(x_n )/f'(x_n )$" src="form_1347.png"/></p>
<p>Identifying <img class="formulaInl" alt="$x_n$" src="form_1346.png"/> with TCAN and <img class="formulaInl" alt="$f(x_n )$" src="form_1348.png"/> with the surface energy balance equation, it can be seen that the second term on the right-hand side corresponds to TSTEP; the numerator is equal to RESID and the denominator to the first derivative of the energy balance equation evaluated at TCAN, which in turn is equal to the sum of the derivatives of the individual terms:</p>
<p><img class="formulaInl" alt="$d(L_{*c} )/dT = -8 \sigma T_c^3 (1 - \chi)$" src="form_1400.png"/></p>
<p><img class="formulaInl" alt="$d(Q_{H,c} )/dT = \rho_a c_p {1/r_A + [T_c - T_{a,pot} ] d(1/r_A )/dT}$" src="form_1401.png"/></p>
<p><img class="formulaInl" alt="$d(Q_{E,c} )/dT = L_v \rho_a {X_E dq_c /dT + [q_c - q_a ] dX_E /dT}$" src="form_1402.png"/></p>
<p><img class="formulaInl" alt="$d \Delta Q_{S,c} /dT = C_c / \Delta t$" src="form_1403.png"/></p>
<p>The term <img class="formulaInl" alt="$d(1/r_A )/dT$" src="form_1404.png"/> is represented by the variable DCFLXM, which is approximated as the difference between CFLX and its value for the previous iteration, CFLUXM, divided by TSTEP. The term <img class="formulaInl" alt="$dX_E /dT$" src="form_1405.png"/> is represented by the variable DXEVAP, which is approximated as the difference between XEVAP and its value for the previous iteration, XEVAPM, divided by TSTEP. The calculated value of TSTEP obtained from the above calculations is constrained to be between -10 and 5 K to dampen any spurious oscillations, and is then added to TCAN. If the resulting value of TCAN is vanishingly close to 0 C, it is reset to that value. At the end of the calculations the iteration counter NITER and the flag NUMIT are each incremented by one. The values of <img class="formulaInl" alt="$T_{a,c}$" src="form_1365.png"/> , <img class="formulaInl" alt="$q_{a,c}$" src="form_1366.png"/> and <img class="formulaInl" alt="$T_{ac,v}$" src="form_1309.png"/> are reset to <img class="formulaInl" alt="$T_c$" src="form_144.png"/> , <img class="formulaInl" alt="$q_c$" src="form_1302.png"/> and <img class="formulaInl" alt="$T_{c,v}$" src="form_1300.png"/> respectively. Upon exiting the loop, if NUMIT &gt; 0, the iteration cycle is repeated from line 400 on.</p>
<p>After the iteration has been completed, if the Newton-Raphson method has been used, a check is carried out in loop 600 to ascertain whether convergence has not been reached (i.e. whether ITER = -1) for any location. In such cases it is assumed that conditions of near-neutral stability at the surface are the cause of the difficulty in finding a solution. The flags NUMIT and IEVAPC are set to zero, and a trial value of TCAN is calculated using the virtual potential temperature of the air and the canopy specific humidity. If the absolute value of RESID is <img class="formulaInl" alt="$> 100 W m^{-2}$" src="form_1406.png"/> , TCAN is set to this trial value. The values of <img class="formulaInl" alt="$q_{0,c}$" src="form_1386.png"/> and the components of the surface energy balance are recalculated as above, except that <img class="formulaInl" alt="$Q_{H,c}$" src="form_1355.png"/> and <img class="formulaInl" alt="$Q_{E,c}$" src="form_1356.png"/> are assumed as a first approximation to be zero. RESID is determined on this basis, and is then assigned to <img class="formulaInl" alt="$Q_{H,c}$" src="form_1355.png"/> and <img class="formulaInl" alt="$Q_{E,c}$" src="form_1356.png"/> . If RESID &gt; 0, <img class="formulaInl" alt="$Q_{E,c}$" src="form_1356.png"/> is set to this value; otherwise it is equally divided between <img class="formulaInl" alt="$Q_{H,c}$" src="form_1355.png"/> and <img class="formulaInl" alt="$Q_{E,c}$" src="form_1356.png"/> . The residual is then reset to zero, and E(0) and <img class="formulaInl" alt="$T_{v,c}$" src="form_1407.png"/> are recalculated. NUMIT is incremented by 1, and the flag IEVAPC for the current location is set to 1.</p>
<p>After loop 600, calls to DRCOEF or FLXSURFZ are performed to re-evaluate the surface turbulent transfer coefficients for any locations for which the fluxes were modified in the previous loop, i.e. for any locations for which IEVAPC was set to 1. After this a check is performed for unphysical values of the canopy temperature, i.e. for values greater than 100 C or less than -100 C. If such values are encountered, an error message is printed and a call to abort is carried out.</p>
<p>Next a check is carried out to determine whether freezing or melting of intercepted water has occurred over the current time step. If this is the case, adjustments are required to the canopy temperature, the intercepted liquid and frozen water amounts and fractional coverages, and to <img class="formulaInl" alt="$C_c$" src="form_143.png"/> and <img class="formulaInl" alt="$\Delta Q_{S,c}$" src="form_1392.png"/> . In loop 650, if there is liquid water stored on the canopy and the canopy temperature is less than 0 C, the first half of the adjustment to <img class="formulaInl" alt="$\Delta Q_{S,c}$" src="form_1392.png"/> is performed, and the flags ITER and NIT are set to 1. The available energy sink HFREZ is calculated from CHCAP and the difference between TCAN and 0 C, and compared with HCONV, calculated as the energy sink required to freeze all of the liquid water on the canopy. If HFREZ <img class="formulaInl" alt="$\leq$" src="form_228.png"/> HCONV, the amount of water that can be frozen is calculated using the latent heat of melting. The fractional coverages of frozen and liquid water FSNOWC and FRAINC and their masses SNOCAN and RAICAN are adjusted accordingly, TCAN is set to 0 C, and the amount of energy involved is stored in the diagnostic variable QMELTC. Otherwise all of the intercepted liquid water is converted to frozen water, and the energy available for cooling the canopy is calculated as HCOOL = HFREZ - HCONV. This available energy is applied to decreasing the temperature of the canopy, using the specific heat of the canopy elements, and the amount of energy that was involved in the phase change is stored in the diagnostic variable QMELTC. In both cases <img class="formulaInl" alt="$q_c$" src="form_1302.png"/> and <img class="formulaInl" alt="$T_{c,v}$" src="form_1300.png"/> are recalculated, and at the end of the loop <img class="formulaInl" alt="$C_c$" src="form_143.png"/> and <img class="formulaInl" alt="$\Delta Q_{S,c}$" src="form_1392.png"/> are re-evaluated.</p>
<p>In loop 675, if there is frozen water stored on the canopy and the canopy temperature is greater than 0 C, the first half of the adjustment to <img class="formulaInl" alt="$\Delta Q_{S,c}$" src="form_1392.png"/> is performed, and the flags ITER and NIT are set to 1. The available energy for melting, HMELT, is calculated from CHCAP and the difference between TCAN and 0 C, and compared with HCONV, calculated as the energy required to melt all of the frozen water on the canopy. If HMELT <img class="formulaInl" alt="$\leq$" src="form_228.png"/> HCONV, the amount of frozen water that can be melted is calculated using the latent heat of melting. The fractional coverages of frozen and liquid water FSNOWC and FRAINC and their masses SNOCAN and RAICAN are adjusted accordingly, TCAN is set to 0 C, and the amount of energy involved is stored in the diagnostic variable QMELTC. Otherwise, all of the intercepted frozen water is converted to liquid water, and the energy available for warming the canopy is calculated as HWARM = HMELT - HCONV. This available energy is applied to increasing the temperature of the canopy, using the specific heats of the canopy elements, and the amount of energy that was involved in the phase change is stored in the diagnostic variable QMELTC. In both cases <img class="formulaInl" alt="$q_c$" src="form_1302.png"/> and <img class="formulaInl" alt="$T_{c,v}$" src="form_1300.png"/> are recalculated, and at the end of the loop <img class="formulaInl" alt="$C_c$" src="form_143.png"/> and <img class="formulaInl" alt="$\Delta Q_{S,c}$" src="form_1392.png"/> are re-evaluated.</p>
<p>For the locations over which melting or freezing of water on the canopy has occurred, the surface fluxes must now be recalculated to reflect the modified canopy temperature and humidity. If NIT &gt; 0, first DRCOEF or FLXSURFZ is called to re-evaluate the surface turbulent transfer coefficients over all locations where ITER has been set to 1. Loops 700 and 750 repeat the calculations done in loops 475 and 500, to obtain the surface transfer coefficients. Loop 800 repeats the calculations of the surface fluxes done in loop 525.</p>
<p>At the end of the subroutine, some final diagnostic and clean-up calculations are performed. If the evaporation rate from the canopy, EVAPC, is very small, it is added to the residual of the canopy energy balance equation, RESID, and then reset to zero. The overall residual is added to the sensible heat flux from the canopy. The energy balance of the surface underlying the canopy is then re-evaluated to take into account the new value of the canopy longwave radiation. If the surface temperature is close to 0 C, the residual of the equation is assigned to QMELTG, representing the energy associated with melting or freezing of water at the surface; otherwise it is assigned to the ground heat flux. If the water vapour flux is towards the canopy, the water sublimated or condensed is assigned to interception storage: to SNOCAN if SNOCAN &gt; 0 (for consistency with the definition of CPHCHC), and to RAICAN otherwise. The diagnostic water vapour flux variables QFCF and QFCL, and the diagnostic change of canopy heat storage HTCC, are updated accordingly, and the canopy heat capacity CHCAP is recalculated; EVAPC is added to the diagnostic variable EVAP and then reset to zero. The net shortwave radiation, outgoing longwave radiation, sensible and latent heat fluxes are calculated for the whole canopy-ground surface ensemble; the evaporation rates are converted to <img class="formulaInl" alt="$m s^{-1}$" src="form_1408.png"/> ; and the iteration counter ITERCT is updated for the level corresponding to the subarea type and the value of NITER. Finally, the fraction of water removed by transpiration from each soil layer is updated according to the fractions determined above on the basis of water availability.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="TSOLVC_8f.html">TSOLVC.f</a></li>
    <li class="footer">Generated on Wed Oct 25 2017 12:11:59 for CLASSIC by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
