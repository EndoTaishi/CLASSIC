<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CLASSIC: src/ICEBAL.f File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CLASSIC
   </div>
   <div id="projectbrief">Canadian Land Surface Scheme including Biogeochemical Cycles</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ICEBAL_8f.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">ICEBAL.f File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Performs temperature stepping and surface runoff calculations over ice sheets.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:abefb862d3860a7222b2eaa981efb2701"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ICEBAL_8f.html#abefb862d3860a7222b2eaa981efb2701">icebal</a> (TBAR, TPOND, ZPOND, TSNOW, RHOSNO, ZSNOW, HCPSNO, ALBSNO, HMFG, HTCS, HTC, WTRS, WTRG, GFLUX, RUNOFF, TRUNOF, OVRFLW, TOVRFL, ZPLIM, GGEO, FI, EVAP, R, TR, GZERO, G12, G23, HCP, QMELT, WSNOW, ZMAT, TMOVE, WMOVE, ZRMDR, TADD, ZMOVE, TBOT, DELZ, ISAND, ICONT, IWF, IG, IGP1, IGP2, ILG, IL1, IL2, JL, N)</td></tr>
<tr class="separator:abefb862d3860a7222b2eaa981efb2701"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Performs temperature stepping and surface runoff calculations over ice sheets. </p>
<dl class="section author"><dt>Author</dt><dd>D. Verseghy, M. Lazare </dd></dl>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="abefb862d3860a7222b2eaa981efb2701"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abefb862d3860a7222b2eaa981efb2701">&#9670;&nbsp;</a></span>icebal()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine icebal </td>
          <td>(</td>
          <td class="paramtype">real, dimension  (ilg,ig)&#160;</td>
          <td class="paramname"><em>TBAR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TPOND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ZPOND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TSNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RHOSNO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ZSNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>HCPSNO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ALBSNO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg,ig)&#160;</td>
          <td class="paramname"><em>HMFG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>HTCS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg,ig)&#160;</td>
          <td class="paramname"><em>HTC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>WTRS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>WTRG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>GFLUX</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RUNOFF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TRUNOF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>OVRFLW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TOVRFL</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ZPLIM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>GGEO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>FI</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>EVAP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension     (ilg)&#160;</td>
          <td class="paramname"><em>R</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>TR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>GZERO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>G12</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>G23</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg,ig)&#160;</td>
          <td class="paramname"><em>HCP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>QMELT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>WSNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg,igp2,igp1)&#160;</td>
          <td class="paramname"><em>ZMAT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,igp2)&#160;</td>
          <td class="paramname"><em>TMOVE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,igp2)&#160;</td>
          <td class="paramname"><em>WMOVE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,igp1)&#160;</td>
          <td class="paramname"><em>ZRMDR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>TADD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ZMOVE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>TBOT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ig)&#160;</td>
          <td class="paramname"><em>DELZ</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>ISAND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ICONT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IWF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IGP1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IGP2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ILG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IL1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IL2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>JL</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>N</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tbar</td><td>Temperature of ice layer <img class="formulaInl" alt="$[C] (T_{av}( \Delta z))$" src="form_805.png"/></td></tr>
    <tr><td class="paramname">hmfg</td><td>Energy associated with freezing or thawing of water in ice layer <img class="formulaInl" alt="$[W m^{-2}]$" src="form_248.png"/></td></tr>
    <tr><td class="paramname">htc</td><td>Internal energy change of ice layer due to conduction and/or change in mass <img class="formulaInl" alt="$[W m^{-2}]$" src="form_248.png"/> (Ij)</td></tr>
    <tr><td class="paramname">gflux</td><td>Heat flow between ice layers <img class="formulaInl" alt="$[W m^{-2}] (G(\Delta z))$" src="form_806.png"/></td></tr>
    <tr><td class="paramname">tpond</td><td>Temperature of ponded water [C]</td></tr>
    <tr><td class="paramname">zpond</td><td>Depth of ponded water [m]</td></tr>
    <tr><td class="paramname">tsnow</td><td>Temperature of the snow pack [C]</td></tr>
    <tr><td class="paramname">rhosno</td><td>Density of snow pack <img class="formulaInl" alt="$[kg m^{-3}]$" src="form_132.png"/></td></tr>
    <tr><td class="paramname">zsnow</td><td>Depth of snow pack [m]</td></tr>
    <tr><td class="paramname">hcpsno</td><td>Heat capacity of snow pack <img class="formulaInl" alt="$[J m^{-3} K^{-1}]$" src="form_361.png"/></td></tr>
    <tr><td class="paramname">albsno</td><td>Albedo of snow [ ]</td></tr>
    <tr><td class="paramname">htcs</td><td>Internal energy change of ice layer due to conduction and/or change in mass <img class="formulaInl" alt="$[W m^{-2}] (I_j) $" src="form_807.png"/></td></tr>
    <tr><td class="paramname">wtrs</td><td>Water transferred into or out of the snow pack <img class="formulaInl" alt="$[kg m^{-2} s^{-1}]$" src="form_128.png"/></td></tr>
    <tr><td class="paramname">wtrg</td><td>Water transferred into or out of the ice <img class="formulaInl" alt="$[kg m^{-2} s^{-1}]$" src="form_128.png"/></td></tr>
    <tr><td class="paramname">runoff</td><td>Total runoff from ice column [m]</td></tr>
    <tr><td class="paramname">trunof</td><td>Temperature of total runoff from ice column [K]</td></tr>
    <tr><td class="paramname">ovrflw</td><td>Overland flow from top of ice column [m]</td></tr>
    <tr><td class="paramname">tovrfl</td><td>Temperature of overland flow from top of ice column [K]</td></tr>
    <tr><td class="paramname">fi</td><td>Fractional coverage of subarea in question on modelled area <img class="formulaInl" alt="$[ ] (X)$" src="form_808.png"/></td></tr>
    <tr><td class="paramname">evap</td><td>Evaporation rate from ice surface <img class="formulaInl" alt="$[m s^{-1}]$" src="form_122.png"/></td></tr>
    <tr><td class="paramname">r</td><td>Rainfall rate at ice surface <img class="formulaInl" alt="$[m s^{-1}]$" src="form_122.png"/></td></tr>
    <tr><td class="paramname">tr</td><td>Temperature of rainfall [C]</td></tr>
    <tr><td class="paramname">gzero</td><td>Heat flow into ice surface <img class="formulaInl" alt="$[W m^{-2}] (G(0))$" src="form_809.png"/></td></tr>
    <tr><td class="paramname">g12</td><td>Heat flow between first and second ice layers <img class="formulaInl" alt="$[W m^{-2}] (G(\Delta z1))$" src="form_810.png"/></td></tr>
    <tr><td class="paramname">g23</td><td>Heat flow between second and third ice layers <img class="formulaInl" alt="$[W m^{-2}] (G(\Delta z2))$" src="form_811.png"/></td></tr>
    <tr><td class="paramname">qmelt</td><td>Energy available for melting of ice <img class="formulaInl" alt="$[W m^{-2}]$" src="form_248.png"/></td></tr>
    <tr><td class="paramname">wsnow</td><td>Liquid water content of snow pack <img class="formulaInl" alt="$[kg m^{-2}]$" src="form_130.png"/></td></tr>
    <tr><td class="paramname">zplim</td><td>Limiting depth of ponded water [m]</td></tr>
    <tr><td class="paramname">ggeo</td><td>Geothermal heat flux at bottom of modelled ice profile <img class="formulaInl" alt="$[W m^{-2}]$" src="form_248.png"/></td></tr>
    <tr><td class="paramname">hcp</td><td>Heat capacity of ice layer <img class="formulaInl" alt="$[J m^{-3} K^{-1}]$" src="form_361.png"/></td></tr>
    <tr><td class="paramname">isand</td><td>Sand content flag</td></tr>
    <tr><td class="paramname">delz</td><td>Overall thickness of ice layer <img class="formulaInl" alt="$[m] (\Delta z)$" src="form_812.png"/> </td></tr>
  </table>
  </dd>
</dl>
<p>In the 100 loop, any rainfall or snowmelt R reaching the ice surface is added to the ponded water on the surface. The ponded water temperature is calculated as the weighted average of the existing pond and the rainfall or snowmelt added, and the change in internal energy HTC of the first ice layer is updated using the temperature of the added water.</p>
<p>If a full-scale hydrological modelling application is not being run, that is, if only vertical fluxes of energy and moisture are being modelled, the flag IWF will have been pre-set to zero. In this case, overland flow of water is treated using a simple approach: if the ponded depth of water on the soil surface ZPOND exceeds a pre-determined limiting value ZPLIM, the excess is assigned to overland flow. The total runoff from the ice sheet, RUNOFF, is incremented by the excess of the ponded water, and the overland flow for the whole grid cell OVRFLW is incremented by the product of the excess ponded water and the fractional area of the grid cell. The temperature of the overall runoff from the modelled area TRUNOF, and the temperature of the overland flow for the grid cell TOVRFL, are calculated as weighted averages over their previous values and the ponded water temperature TPOND. The internal energy change HTC of the first soil layer is adjusted for the amount of water lost, and ZPOND is set to ZPLIM.</p>
<p>If the temperature of the remaining ponded water is greater than 0 C, the sink of energy required to cool it to 0 C, HCOOL, is calculated and compared with the amount of energy required to warm the first ice layer to 0 C, HWARM. If HWARM &gt; HCOOL, the energy sink of the first layer is used to cool the ponded water to 0 C, and the layer temperature is updated accordingly. Otherwise, the ponded water temperature and the temperature of the first ice layer are both set to 0 C, and the excess energy source given by HCOOL-HWARM is added to the heat available for melting ice, QMELT.</p>
<p>In loop 125, if the temperature of the first ice layer is less than -2 C after the above operations (i.e. if it is not very close to 0 C), and if the ponded water depth is not vanishingly small, freezing of the ponded water can take place. The energy sink required to freeze all of the ponded water, HFREZ, is calculated and compared with HWARM, the amount of energy required to raise the temperature of the first ice layer to 0 C. If HWARM &gt; HFREZ, then HFREZ is converted into an equivalent temperature change using the heat capacity of ice, and added to the temperature of the first ice layer. HFREZ is also used to update HMFG, the diagnosed energy used for phase changes of water in the first ice layer. The internal energy of the first soil layer, HTC, is adjusted to account for the loss of the ponded water, which is assumed to be added to the snow pack. The ponded water is converted into a frozen depth ZFREZ, which is used to update the internal energy of the snow pack, HTCS. If there is not a pre-existing snow pack, the snow albedo is set to the limiting low value of 0.50. The temperature and density of the snow pack are recalculated as weighted averages over the original values and the frozen amount that has been added. ZFREZ is added to the snow depth ZSNOW. The snow heat capacity is recalculated using the new value of the snow density. Finally, the diagnostic amounts of water transferred to the snow pack, WTRS, and from the ice, WTRG, are updated using ZFREZ.</p>
<p>In the 150 loop the heat fluxes between the ice layers are calculated for the optional multiple-layer configuration, in which the standard third layer, normally with a thickness of 3.75 m, can be subdivided into smaller layers and extended to a greater depth if desired. (The heat fluxes at the ice surface, and between the first and second and the second and third layers, were already calculated in the CLASST subroutines.) The remaining fluxes are calculated by using a simple linearization of the soil temperature profile. The expression for the ground heat flux at a depth z, G(z), which depends on the thermal conductivity <img class="formulaInl" alt="$\lambda(z)$" src="form_813.png"/> and the temperature gradient, is written as:</p>
<p><img class="formulaInl" alt="$G(z) = \lambda(z) dT(z)/dz$" src="form_814.png"/></p>
<p>The linearized form is thus:</p>
<p><img class="formulaInl" alt="$G_j = 2 \lambda_i (T_{j-1} – T_j) / (\Delta z_{j-1} + \Delta z_j)$" src="form_815.png"/></p>
<p>where <img class="formulaInl" alt="$G_j$" src="form_816.png"/> is the heat flux at the top of layer j, <img class="formulaInl" alt="$T_j$" src="form_817.png"/> and <img class="formulaInl" alt="$\Delta z_j$" src="form_818.png"/> refer to the temperature and thickness of the layer, and <img class="formulaInl" alt="$\lambda_i$" src="form_819.png"/> is the thermal conductivity of ice.</p>
<p>In the 200 loop a value is assigned to the temperature at the bottom of the ice profile, TBOT, and the temperatures for the first three ice layers are stepped ahead. If the standard three-layer configuration is being used, TBOT is obtained by making use of the assumption (see documentation for subroutine TNPREP) that the variation of temperature T with depth z within each soil layer can be modelled using a quadratic equation:</p>
<p><img class="formulaInl" alt="$T(z) = 1/2 a z^2 + b z +c$" src="form_820.png"/></p>
<p>It can be shown that the temperature at the bottom of a given soil layer, <img class="formulaInl" alt="$T(\Delta z)$" src="form_821.png"/>, is related to the temperature at the top of the layer T(0) and the heat fluxes at the top and bottom of the layer, G(0) and <img class="formulaInl" alt="$G(\Delta z)$" src="form_822.png"/>, as follows:</p>
<p><img class="formulaInl" alt="$T(\Delta z) = T(0) - (\Delta z/ 2 \lambda_i)[G(0) + G(\Delta z)]$" src="form_823.png"/></p>
<p>Making use of the continuity requirement that the heat flux and temperature at the bottom of a given layer must be equal to the heat flux and temperature at the top of the layer beneath it, an expression for the temperature at the bottom of the third ice layer can be obtained as a function of the temperature at the surface and the fluxes between the ice layers:</p>
<p><img class="formulaInl" alt="$T(\Delta z_3) = T(0) – {G(\Delta z_2) [\Delta z_3 + \Delta z_2] + G(\Delta z_1) [\Delta z_2 + \Delta z_1] + G(0) \Delta z_{21}} / 2 \lambda_i$" src="form_824.png"/></p>
<p>The surface temperature T(0) is obtained by integrating the equation for T(z) to obtain an expression for the average layer temperature <img class="formulaInl" alt="$T_{av}(\Delta z)$" src="form_825.png"/>, and then inverting this to solve for T(0):</p>
<p><img class="formulaInl" alt="$T(0) = T_{av}(\Delta z_1) + (\Delta z_1/ 3\lambda_i) [G(0) + 1/2 G(\Delta z_1)]$" src="form_826.png"/></p>
<p>The third layer temperature is then updated using the geothermal flux GGEO. If the optional multiple- layer configuration is used, TBOT is simply set to the temperature of the lowest layer. In either the standard or the multiple-layer case, the first three layer temperatures are updated using the heat fluxes at the surface, between the first and second layers and between the second and third layers, which were determined in the CLASST subroutines. Finally, the latter fluxes are assigned to the appropriate levels in the diagnostic GFLUX vector.</p>
<p>In the 250 loop, the GFLUX values determined in the 150 loop are used to update the temperatures in the third and lower ice layers for the multiple-layer configuration. The calculations are bracketed by a determination of the change of internal energy <img class="formulaInl" alt="$I_j$" src="form_827.png"/> of the ice layers as a result of the heat fluxes, obtained as the difference in <img class="formulaInl" alt="$I_j$" src="form_827.png"/> between the beginning and end of the calculations:</p>
<p><img class="formulaInl" alt="$\Delta I_j = X_i \Delta[C_i \Delta z_j T_{av}(\Delta z_j)]/ \Delta t$" src="form_828.png"/></p>
<p>where <img class="formulaInl" alt="$C_i$" src="form_829.png"/> is the heat capacity of ice, <img class="formulaInl" alt="$Delta t$" src="form_830.png"/> is the length of the time step, and <img class="formulaInl" alt="$X_i$" src="form_39.png"/> is the fractional coverage of the subarea under consideration relative to the modelled area.</p>
<p>In the 300 loop, checks are carried out to determine whether any of the ice layer temperatures has overshot 0 C as a result of the calculations in the previous loop. If so, the excess energy is assigned to a temporary variable QADD and is also added to the total heat available for melting of the ice, QMELT. QADD is subtracted from the internal energy of the layer in questions and is added to the internal energy of the first layer, since melting is assumed to proceed from the top downwards. The temperature of the layer is reset to 0 C. Finally, the first half of a calculation of the change of internal energy of each ice layer is performed, to be completed at the end of the subroutine.</p>
<p>In the next three loops, the ice layers are adjusted downward to account for the removal of mass at the surface by melting or sublimation. First, the temperature TMOVE of the ice into which the layer is moving is set to the temperature of the layer below it. TMOVE for the bottom layer is set to TBOT. A depth of ice ZMELT is calculated as the amount of ice for which QMELT is sufficient to both raise its temperature to 0 C (if necessary) and melt it. The temperature of the overall runoff and the overland flow are updated as averages of the original temperature and the meltwater temperature (assumed to be at the freezing point), weighted according to their respective amounts, and the overall runoff and overland flow are incremented by ZMELT (with ZMELT converted to an equivalent water depth). The energy used for the melting of ice is calculated from ZMELT and added to HMFG for the first layer, and the amount of energy used to raise the layer temperature to 0 C is added to HTC for the first layer. The total depth of downward adjustment of the ice layers, ZMOVE, is obtained as the sum of ZMELT and the sublimation depth, calculated from EVAP. This amount is added to the diagnostic variable WTRG. Finally, the new temperature of each ice layer is calculated over the layer thickness DELZ as the average of the original temperature weighted by DELZ-ZMOVE and TMOVE weighted by ZMOVE.</p>
<p>In the next loops, the ice layers are adjusted upward to account for addition of mass at the surface by conversion of snow to ice. Snow is converted to ice if the depth of the snow pack exceeds 10 m, or if the density exceeds <img class="formulaInl" alt="$900 kg m^{-3}$" src="form_831.png"/> (approaching that of ice). In the first case the excess over and above 10 m is converted; in the second, the whole snow pack is converted. These calculations are performed in the 500 loop, bracketed by a calculation of the change in internal energy of the snow pack, HTCS. In both cases the first level of the ice level movement matrix WMOVE is set to the amount of snow that is converted, expressed as a depth of ice, and the first level of the temperature matrix TMOVE is set to the snow temperature. The amount of converted snow is added to the diagnostic variables WTRS and WTRG. The depth, density and heat capacity of the snow are recalculated. If the entire snow pack is being converted and the water content WSNOW was non-zero, WSNOW is subtracted from WTRS and added to WTRG, and is also added to the total runoff and the overland flow. The runoff and overland flow temperatures are updated accordingly. The snow temperature and water content are reset to zero. The amount of ice that is lost to the bottom of the profile is added to the total runoff, and the runoff temperature is updated accordingly.</p>
<p>In the remaining parts of the code, the actual adjustment of ice layer positions is performed. First the levels of the available depth matrix ZRMDR are set to the ice layer thicknesses; the matrix ZMAT is initialized to zero; and each level J of WMOVE and TMOVE from 2 to the bottom of the ice profile is set to the value of DELZ and TBAR respectively of the J-1 ice level. The ZMAT matrix represents the depth of each ice layer J that is occupied by ice from level K in the layer movement matrix WMOVE after the layer adjustments are complete. In the 700 loop, starting at the top of the ice profile, an attempt is made to assign each layer of WMOVE in turn to the K,J level of ZMAT. If the calculated value of ZMAT is greater than the available depth ZRMDR of the layer, ZMAT is set to ZRMDR, WMOVE is decremented by ZRMDR, and ZRMDR is set to zero. Otherwise the calculated value of ZMAT is accepted, ZRMDR is decremented by ZMAT, and WMOVE is set to zero.</p>
<p>Finally, the 900 loop is performed over each ice layer J to determine the new layer temperature. The temperature adjustment variable TADD is initialized to zero, and then incremented by the temperature TMOVE of each level K weighted by the corresponding K,J level of ZMAT, and finally by the original layer temperature weighted by the corresponding level of ZRMDR. The layer temperature is reset to TADD normalized by DELZ, and the updating of HTC, begun at the end of the 300 loop, is completed.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="ICEBAL_8f.html">ICEBAL.f</a></li>
    <li class="footer">Generated on Tue Apr 9 2019 08:59:52 for CLASSIC by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
