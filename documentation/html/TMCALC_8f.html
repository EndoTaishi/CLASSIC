<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>CLASSIC: src/TMCALC.f File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CLASSIC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('TMCALC_8f.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">TMCALC.f File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Calculates overland flow; steps ahead pond and soil layer temperatures, and checks for freezing of the ponded water and freezing or thawing of liquid or frozen water in the soil layers. Adjusts ponded water temperature, soil layer temperatures and water stores accordingly.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a5ad5bd585e1ef7d89e9862d0bacd3c51"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="TMCALC_8f.html#a5ad5bd585e1ef7d89e9862d0bacd3c51">tmcalc</a> (TBAR, THLIQ, THICE, HCP, TPOND, ZPOND, TSNOW, ZSNOW, ALBSNO, RHOSNO, HCPSNO, TBASE, OVRFLW, TOVRFL, RUNOFF, TRUNOF, HMFG, HTC, HTCS, WTRS, WTRG, FI, TBARW, GZERO, G12, G23, GGEO, TA, WSNOW, TCTOP, TCBOT, GFLUX, ZPLIM, THPOR, THLMIN, HCPS, DELZW, DELZZ, DELZ, ISAND, IWF, IG, ILG, IL1, IL2, JL, N)</td></tr>
<tr class="separator:a5ad5bd585e1ef7d89e9862d0bacd3c51"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Calculates overland flow; steps ahead pond and soil layer temperatures, and checks for freezing of the ponded water and freezing or thawing of liquid or frozen water in the soil layers. Adjusts ponded water temperature, soil layer temperatures and water stores accordingly. </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a class="anchor" id="a5ad5bd585e1ef7d89e9862d0bacd3c51"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine tmcalc </td>
          <td>(</td>
          <td class="paramtype">real, dimension  (ilg,ig)&#160;</td>
          <td class="paramname"><em>TBAR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>THLIQ</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>THICE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg,ig)&#160;</td>
          <td class="paramname"><em>HCP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TPOND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ZPOND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TSNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ZSNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>ALBSNO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RHOSNO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>HCPSNO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>TBASE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>OVRFLW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TOVRFL</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>RUNOFF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg)&#160;</td>
          <td class="paramname"><em>TRUNOF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg,ig)&#160;</td>
          <td class="paramname"><em>HMFG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg,ig)&#160;</td>
          <td class="paramname"><em>HTC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>HTCS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>WTRS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>WTRG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>FI</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>TBARW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>GZERO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>G12</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension   (ilg)&#160;</td>
          <td class="paramname"><em>G23</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg)&#160;</td>
          <td class="paramname"><em>GGEO</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension    (ilg)&#160;</td>
          <td class="paramname"><em>TA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>WSNOW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>TCTOP</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>TCBOT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>GFLUX</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg)&#160;</td>
          <td class="paramname"><em>ZPLIM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>THPOR</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(ilg,ig)&#160;</td>
          <td class="paramname"><em>THLMIN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ilg,ig)&#160;</td>
          <td class="paramname"><em>HCPS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>DELZW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>DELZZ</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension  (ig)&#160;</td>
          <td class="paramname"><em>DELZ</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension (ilg,ig)&#160;</td>
          <td class="paramname"><em>ISAND</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IWF</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>ILG</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IL1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>IL2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>JL</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>N</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tbar</td><td>Temperature of soil layer <img class="formulaInl" alt="$[C] (T_g)$" src="form_1161.png"/></td></tr>
    <tr><td class="paramname">thliq</td><td>Volumetric liquid water content of soil layer <img class="formulaInl" alt="$(\theta_l) [m^3 m^{-3}]$" src="form_1164.png"/></td></tr>
    <tr><td class="paramname">thice</td><td>Volumetric frozen water content of soil layer <img class="formulaInl" alt="$(\theta_i) [m^3 m^{-3}]$" src="form_1165.png"/></td></tr>
    <tr><td class="paramname">hcp</td><td>Heat capacity of soil layer <img class="formulaInl" alt="$[J m^{-3} K^{-1}] (C_g)$" src="form_1166.png"/></td></tr>
    <tr><td class="paramname">hmfg</td><td>Energy associated with freezing or thawing of water in soil layer <img class="formulaInl" alt="$[W m^{-2}]$" src="form_246.png"/></td></tr>
    <tr><td class="paramname">htc</td><td>Internal energy change of soil layer due to conduction and/or change in mass <img class="formulaInl" alt="$[W m^{-2}] (I_g)$" src="form_217.png"/></td></tr>
    <tr><td class="paramname">tpond</td><td>Temperature of ponded water <img class="formulaInl" alt="$[C] (T_p)$" src="form_1160.png"/></td></tr>
    <tr><td class="paramname">zpond</td><td>Depth of ponded water <img class="formulaInl" alt="$[m] (z_p)$" src="form_406.png"/></td></tr>
    <tr><td class="paramname">tsnow</td><td>Temperature of the snow pack <img class="formulaInl" alt="$[C] (T_s)$" src="form_1103.png"/></td></tr>
    <tr><td class="paramname">zsnow</td><td>Depth of snow pack <img class="formulaInl" alt="$[m] (z_g)$" src="form_218.png"/></td></tr>
    <tr><td class="paramname">albsno</td><td>Albedo of snow [ ]</td></tr>
    <tr><td class="paramname">rhosno</td><td>Density of snow pack <img class="formulaInl" alt="$(\rho_s) [kg m^{-3}]$" src="form_1167.png"/></td></tr>
    <tr><td class="paramname">hcpsno</td><td>Heat capacity of snow pack <img class="formulaInl" alt="$[J m^{-3} K^{-1}] (C_s)$" src="form_223.png"/></td></tr>
    <tr><td class="paramname">tbase</td><td>Temperature of bedrock in third soil layer, if only three layers are being modelled [K]</td></tr>
    <tr><td class="paramname">ovrflw</td><td>Overland flow from top of soil column [m]</td></tr>
    <tr><td class="paramname">tovrfl</td><td>Temperature of overland flow from top of soil column [K]</td></tr>
    <tr><td class="paramname">runoff</td><td>Total runoff from soil column [m]</td></tr>
    <tr><td class="paramname">trunof</td><td>Temperature of total runoff from soil column [K]</td></tr>
    <tr><td class="paramname">htcs</td><td>Internal energy change of snow pack due to conduction and/or change in mass <img class="formulaInl" alt="$[W m^{-2}] (I_s)$" src="form_220.png"/></td></tr>
    <tr><td class="paramname">wtrs</td><td>Water transferred into or out of the snow pack <img class="formulaInl" alt="$[kg m^{-2} s^{-1}]$" src="form_128.png"/></td></tr>
    <tr><td class="paramname">wtrg</td><td>Water transferred into or out of the soil <img class="formulaInl" alt="$[kg m^{-2} s^{-1}]$" src="form_128.png"/></td></tr>
    <tr><td class="paramname">fi</td><td>Fractional coverage of subarea in question on modelled area <img class="formulaInl" alt="$[ ] (X_i)$" src="form_129.png"/></td></tr>
    <tr><td class="paramname">tbarw</td><td>Temperature of water in soil layer [C]</td></tr>
    <tr><td class="paramname">gzero</td><td>Heat flow into soil surface <img class="formulaInl" alt="$[W m^{-2}]$" src="form_246.png"/></td></tr>
    <tr><td class="paramname">g12</td><td>Heat flow between first and second soil layers <img class="formulaInl" alt="$[W m^{-2}]$" src="form_246.png"/></td></tr>
    <tr><td class="paramname">g23</td><td>Heat flow between second and third soil layers <img class="formulaInl" alt="$[W m^{-2}]$" src="form_246.png"/></td></tr>
    <tr><td class="paramname">ggeo</td><td>Geothermal heat flux at bottom of soil profile <img class="formulaInl" alt="$[W m^{-2}]$" src="form_246.png"/></td></tr>
    <tr><td class="paramname">ta</td><td>Air temperature [K]</td></tr>
    <tr><td class="paramname">wsnow</td><td>Liquid water content of snow pack <img class="formulaInl" alt="$[kg m^{-2}] (w_s)$" src="form_1105.png"/></td></tr>
    <tr><td class="paramname">tctop</td><td>Thermal conductivity of soil at top of soil layer <img class="formulaInl" alt="$[W m^{-1} K^{-1}]$" src="form_279.png"/></td></tr>
    <tr><td class="paramname">tcbot</td><td>Thermal conductivity of soil at bottom of soil layer <img class="formulaInl" alt="$[W m^{-1} K^{-1}]$" src="form_279.png"/></td></tr>
    <tr><td class="paramname">zplim</td><td>Limiting depth of ponded water [m]</td></tr>
    <tr><td class="paramname">thpor</td><td>Pore volume in soil layer <img class="formulaInl" alt="$(\theta_p) [m^3 m^{-3}]$" src="form_1168.png"/></td></tr>
    <tr><td class="paramname">thlmin</td><td>Residual soil liquid water content remaining after freezing or evaporation <img class="formulaInl" alt="$(\theta_r) [m^3 m^{-3}]$" src="form_1169.png"/></td></tr>
    <tr><td class="paramname">hcps</td><td>Heat capacity of soil material <img class="formulaInl" alt="$[J m^{-3} K^{-1}] (C_m)$" src="form_1170.png"/></td></tr>
    <tr><td class="paramname">delzw</td><td>Permeable thickness of soil layer <img class="formulaInl" alt="$(\Delta z_{g,w}) [m]$" src="form_1171.png"/></td></tr>
    <tr><td class="paramname">delzz</td><td>Soil layer thicknesses to bottom of permeable depth for standard three-layer configuration, or to bottom of thermal depth for multiple layers <img class="formulaInl" alt="$(\Delta z_{g,z}) [m]$" src="form_1172.png"/></td></tr>
    <tr><td class="paramname">delz</td><td>Overall thickness of soil layer [m]</td></tr>
    <tr><td class="paramname">isand</td><td>Sand content flag</td></tr>
    <tr><td class="paramname">gflux</td><td>Heat flow between soil layers <img class="formulaInl" alt="$[W m^{-2}]$" src="form_246.png"/> </td></tr>
  </table>
  </dd>
</dl>
<p>If a full-scale hydrological modelling application is not being run, that is, if only vertical fluxes of energy and moisture are being modelled, the flag IWF is pre-set to zero. In this case, overland flow of water is treated using a simple approach: if the ponded depth of water on the soil surface ZPOND exceeds a limiting value ZPLIM (which varies by land surface type), the excess is assigned to overland flow. These calculations are carried out in loop 100, for all modelled areas except ice sheets (which are handled in subroutine ICEBAL). The overall runoff from the modelled area in question, RUNOFF, is incremented by the excess ponded water, and the overland flow for the whole grid cell OVRFLW is incremented by the product of the excess ponded water and the fractional area of the grid cell. The temperature of the overall runoff from the modelled area TRUNOF, and the temperature of the overland flow for the grid cell TOVRFL, are calculated as weighted averages over their previous values and the ponded water temperature TPOND. Finally, ZPOND is set to ZPLIM.</p>
<p>In loop 200, the calculation of the change in internal energy HTC within the soil layers due to movement of soil water (addressed in the preceding subroutines GRINFL and GRDRAN) is completed. (The initial step was performed at the end of subroutine TWCALC.) The volumetric heat capacity of the soil layers HCP is recalculated as a weighted average over the volumetric contents of liquid water, frozen water and soil particles. The temperature TBAR of each soil layer is recalculated as a weighted average of the liquid water temperature TBARW resulting from soil water movement, and the previous soil layer temperature. As noted in the documentation for subroutine TWCALC., TBARW and HCP apply only over the permeable depth of the soil layer, DELZW, whereas TBAR applies over the whole depth, DELZZ, and is associated with HCPSND, the volumetric heat capacity assigned to rock, in the interval DELZZ- DELZW. (For the default three-layer version of CLASS, DELZZ=DELZW in the third soil layer; see the documentation of loop 550 below.)</p>
<p>In loop 300 the calculation of the change of internal energy within the first soil layer due to changes in the surface ponded water is completed (for diagnostic purposes, the first level of HTC includes the internal energy of both the ponded water and the first soil layer). (The initial step of this calculation was performed at the end of subroutine TFREEZ.) The flow of heat between the bottom of the ponded water and the top of the first soil layer, GP1, is calculated by assuming a linear variation with depth of the heat flux between the top of the pond, GZERO, and between the first and second soil layers, G12. Since the heat flux G(z) varies directly with the temperature gradient dT(z)/dz, it can be seen that this approach is consistent with the assumption made in the CLASST subroutines that T(z) is a quadratic function of depth (and therefore that its first derivative is a linear function of depth). The temperature of the ponded water is stepped ahead using GZERO and GP1, and GZERO is reset to GP1 for use in the later soil temperature calculations.</p>
<p>In the 400 loop, a check is performed to ascertain whether the ponded water temperature has fallen below 0 C as a result of the above temperature change. If so, calculations are carried out analogous to those done in TFREEZ. A recalculation of the available energy in the snow pack, HTCS, is initiated. The available energy sink HADD is calculated from TPOND and ZPOND, and TPOND is set to 0 C. The amount of energy required to freeze the whole depth of ponded water is calculated as HCONV. An update of the first level value of HTC, reflecting the freezing of ponded water, is initiated. If HADD &lt; HCONV, the available energy sink is sufficient to freeze only part of the ponded water. This depth ZFREZ is calculated from HADD, and subtracted from ZPOND. ZFREZ is then converted from a depth of water to a depth of ice, and is reassigned as part of the snow pack. The snow temperature, density, heat capacity and depth are recalculated as weighted averages of the pre-existing snow properties and those of the frozen water. If there was no snow on the ground to begin with, the snow albedo is initialized to its minimum background value of 0.50.</p>
<p>If HADD &gt; HCONV, the available energy sink is sufficient to freeze the whole depth of ponded water and then to decrease the frozen water temperature to below 0 C. ZFREZ is evaluated as ZPOND converted to a depth of ice, and the remaining energy sink HADD-HCONV is used to calculated a test temperature TTEST of the newly formed ice. In order to avoid unphysical overshoots of the frozen water temperature, a limiting temperature TLIM is determined as the minimum of the snow temperature and the first level soil temperature if there is pre-existing snow, and as the minimum of the air temperature and the first level soil temperature if not. If TTEST &lt; TLIM, the excess energy sink required to decrease the frozen water temperature from TLIM to TTEST is calculated and added to GZERO, and the new frozen water temperature is assigned as TLIM; otherwise it is assigned as TTEST. The energy sink used to cool the frozen water from 0 C to TLIM or TTEST is decremented from the first level of HTC, and the snow temperature is recalculated as the weighted average of the pre-existing snow temperature and the frozen water temperature. If there was no pre-existing snow, the snow albedo is initialized to the background value of 0.50. The density, heat capacity and depth of the snow are recalculated as above. Finally, the recalculations of the internal energy diagnostic variables HTC and HTCS are completed; and ZFREZ is used to update the diagnostic variable HMFG describing the energy associated with phase changes of water in soil layers, and the diagnostic variables WTRS and WTRG describing transfers of water into or out of the snow and soil respectively.</p>
<p>In the 500, 550 and 600 loops, the heat fluxes between soil layers and the updated temperatures for the soil layers are calculated according to the discretization approach that has been selected for the model run. It is assumed that the first two layer thicknesses are always set to 0.10 and 0.25 m respectively, but two possible options exist for the treatment of deeper layers. In the operational, "three-layer" configuration, a single third soil layer is modelled of thickness 3.75 m, with a user-specified permeable thickness DELZW. TBAR of the third layer is taken to apply to this permeable thickness, whereas a separate bedrock temperature, TBASE, is carried for the impermeable thickness, represented by DELZ-DELZW. This strategy is adopted so that temperature variations caused by melting and freezing of water are confined to the permeable thickness. In the "multi-layer" configuration, there can be any number of deeper layers, of thicknesses specified by the user (with the proviso that the thicknesses not be small enough to lead to numerical instability in the forward explicit time-stepping scheme). In this configuration it is deemed unnecessary to carry a separate calculation of TBASE.</p>
<p>In the CLASST subroutines, the heat fluxes at the top of the first soil layer, and between the first and second and the second and third soil layers, were determined. In loop 500, the fluxes between the remaining soil layers are calculated for the multi-layer configuration, and assigned to the heat flux vector GFLUX. Since the temperature variation is increasingly damped with depth, a simple linearization of the temperature profile is used. The expression for the ground heat flux at depth z, G(z), which depends on the thermal conductivity <img class="formulaInl" alt="$\lambda (z)$" src="form_1173.png"/> and the temperature gradient, is given as: <img class="formulaInl" alt="$G(z) = \lambda (z) dT(z)/dz$" src="form_1174.png"/> The linearized form is written as: <img class="formulaInl" alt="$G_j = (\lambda_{j-1} + \lambda_j ) (T_{j-1} - T_j ) / (\Delta z_{j-1} - \Delta z_j )$" src="form_1175.png"/> where G j is the heat flux at the top of layer j, and <img class="formulaInl" alt="$\lambda_j$" src="form_1176.png"/> , <img class="formulaInl" alt="$T_j$" src="form_816.png"/> and <img class="formulaInl" alt="$\Delta z_j$" src="form_817.png"/> refer to the thermal conductivity, temperature and heat capacity of the layer.</p>
<p>In the 550 loop, the first and second soil layer temperatures are stepped ahead using GZERO, G12 and G23. (Recall that the calculated heat capacity HCP applies to the permeable thickness DELZW, and the heat capacity of rock HCPSND applies to the rest of the layer thickness, DELZZ-DELZW.) If the three- layer configuration is being used, then a check is carried out to ascertain whether the permeable thickness DELZZ of the third layer is greater than zero. If so, and if DELZZ is not effectively equal to DELZ, the heat flow G3B at the interface between the permeable thickness and the underlying bedrock is calculated using the linearized heat flow equation given above; TBAR is updated using the difference between G23 and G3B, and TBASE is updated using the difference between G3B and GGEO, the geothermal heat flux at the bottom of the soil profile. If DELZZ is equal to DELZ, the whole layer is permeable and TBAR is updated using the difference between G23 and GGEO. If DELZZ is zero, the whole layer is impermeable, and TBASE is updated using the difference between G23 and GGEO. HTC for the third layer is updated with the GGEO value. Finally, if the multi-layer configuration is being used, TBAR of the third layer is updated using G23, the flux at the top of the layer. For diagnostic purposes, the first three levels of the GFLUX vector are assigned as GZERO, G12 and G23 respectively.</p>
<p>In the 600 loop, the remaining soil layer temperature calculations are done for layers 3 and deeper, for the multi-layer configuration. At the beginning and end of the loop an updated calculation of HTC for the layer in question is initiated and completed respectively. For the third layer, TBAR is updated using the heat flux at the bottom of the layer; for the last layer, TBAR is updated using the difference between GFLUX at the top of the layer and GGEO at the bottom. For the intermediate layers, TBAR is calculated using the difference between the GFLUX values at the top and bottom of the layer.</p>
<p>In the 700 loop, checks are carried out to determine whether, as a result of the forward stepping of the temperature, TBAR has fallen below 0 C while liquid water still exists in the layer, or risen above 0 C while frozen water still exists in the layer. If either occurs, adjustments to the water content are performed analogous to those done in subroutine TWCALC. Again, at the beginning and end of the loop an updated calculation of HTC for each layer in turn is initiated and completed respectively.</p>
<p>If the soil layer temperature is less than 0 C and the volumetric liquid water content THLIQ of the layer is greater than the residual water content THLMIN, the water content THFREZ that can be frozen by the available energy sink is calculated from TBAR and the weighted average of HCP and HCPSND. If THFREZ <img class="formulaInl" alt="$\leq$" src="form_228.png"/> THLIQ - THLMIN, all of the available energy sink is used to freeze part of the liquid water content in the permeable part of the soil layer. The amount of energy involved is subtracted from HTC and added to HMFG. THFREZ is subtracted from THLIQ, converted to an ice volume and added to THICE. HCP is recalculated, and the layer temperature is set to 0 C. Otherwise, all of the liquid water content of the layer above THLMIN is converted to frozen water, and HMFG and HTC are recalculated to reflect this. HCP is recomputed, and the remaining energy sink HADD is applied to decreasing the temperature of the soil layer.</p>
<p>If the soil layer temperature is greater than 0 C and the volumetric ice content THICE of the layer is greater than zero, the ice content THMELT that can be melted by the available energy is calculated from TBAR and the weighted average of HCP and HCPSND. If THMELT <img class="formulaInl" alt="$\leq$" src="form_228.png"/> THICE, all of the available energy is used to melt part of the frozen water content of the permeable part of the layer. The amount of energy involved is subtracted from HTC and added to HMFG. THMELT is subtracted from THICE, converted to a liquid water volume and added to THLIQ; HCP is recalculated and the layer temperature is set to 0 C. Otherwise, all of the frozen water content of the layer is converted to liquid water, and HMFG and HTC are recalculated to reflect this. HCP is recomputed, and the remaining energy HADD is applied to increasing the temperature of the soil layer.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="TMCALC_8f.html">TMCALC.f</a></li>
    <li class="footer">Generated on Thu Oct 26 2017 11:36:04 for CLASSIC by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
