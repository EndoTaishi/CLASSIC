\hypertarget{CANVAP_8f}{}\section{src/\+C\+A\+N\+V\+A\+P.f File Reference}
\label{CANVAP_8f}\index{src/\+C\+A\+N\+V\+A\+P.\+f@{src/\+C\+A\+N\+V\+A\+P.\+f}}


Purpose\+: Update liquid and frozen water stores on canopy and in soil in response to calculated sublimation, evaporation and transpiration rates.  


\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \hyperlink{CANVAP_8f_a3041cf9c21766306cba0e7bc1b00161f}{canvap} (E\+V\+A\+P, S\+U\+B\+L, R\+A\+I\+C\+A\+N, S\+N\+O\+C\+A\+N, T\+C\+A\+N, T\+H\+L\+I\+Q, T\+B\+A\+R, Z\+S\+N\+O\+W, W\+L\+O\+S\+T, C\+H\+C\+A\+P, Q\+F\+C\+F, Q\+F\+C\+L, Q\+F\+N, Q\+F\+C, H\+T\+C\+C, H\+T\+C\+S, H\+T\+C, F\+I, C\+M\+A\+S\+S, T\+S\+N\+O\+W, H\+C\+P\+S\+N\+O, R\+H\+O\+S\+N\+O, F\+R\+O\+O\+T, T\+H\+P\+O\+R, T\+H\+L\+M\+I\+N, D\+E\+L\+Z\+W, E\+V\+L\+O\+S\+T, R\+L\+O\+S\+T, I\+R\+O\+O\+T, I\+G, I\+L\+G, I\+L1, I\+L2, J\+L, N)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Purpose\+: Update liquid and frozen water stores on canopy and in soil in response to calculated sublimation, evaporation and transpiration rates. 



\subsection{Function/\+Subroutine Documentation}
\hypertarget{CANVAP_8f_a3041cf9c21766306cba0e7bc1b00161f}{}\index{C\+A\+N\+V\+A\+P.\+f@{C\+A\+N\+V\+A\+P.\+f}!canvap@{canvap}}
\index{canvap@{canvap}!C\+A\+N\+V\+A\+P.\+f@{C\+A\+N\+V\+A\+P.\+f}}
\subsubsection[{canvap}]{\setlength{\rightskip}{0pt plus 5cm}subroutine canvap (
\begin{DoxyParamCaption}
\item[{real, dimension  (ilg)}]{E\+V\+A\+P, }
\item[{real, dimension  (ilg)}]{S\+U\+B\+L, }
\item[{real, dimension(ilg)}]{R\+A\+I\+C\+A\+N, }
\item[{real, dimension(ilg)}]{S\+N\+O\+C\+A\+N, }
\item[{real, dimension  (ilg)}]{T\+C\+A\+N, }
\item[{real, dimension (ilg,ig)}]{T\+H\+L\+I\+Q, }
\item[{real, dimension  (ilg,ig)}]{T\+B\+A\+R, }
\item[{real, dimension (ilg)}]{Z\+S\+N\+O\+W, }
\item[{real, dimension (ilg)}]{W\+L\+O\+S\+T, }
\item[{real, dimension (ilg)}]{C\+H\+C\+A\+P, }
\item[{real, dimension  (ilg)}]{Q\+F\+C\+F, }
\item[{real, dimension  (ilg)}]{Q\+F\+C\+L, }
\item[{real, dimension   (ilg)}]{Q\+F\+N, }
\item[{real, dimension   (ilg,ig)}]{Q\+F\+C, }
\item[{real, dimension  (ilg)}]{H\+T\+C\+C, }
\item[{real, dimension  (ilg)}]{H\+T\+C\+S, }
\item[{real, dimension   (ilg,ig)}]{H\+T\+C, }
\item[{real, dimension    (ilg)}]{F\+I, }
\item[{real, dimension (ilg)}]{C\+M\+A\+S\+S, }
\item[{real, dimension (ilg)}]{T\+S\+N\+O\+W, }
\item[{real, dimension(ilg)}]{H\+C\+P\+S\+N\+O, }
\item[{real, dimension(ilg)}]{R\+H\+O\+S\+N\+O, }
\item[{real, dimension (ilg,ig)}]{F\+R\+O\+O\+T, }
\item[{real, dimension(ilg,ig)}]{T\+H\+P\+O\+R, }
\item[{real, dimension(ilg,ig)}]{T\+H\+L\+M\+I\+N, }
\item[{real, dimension (ilg,ig)}]{D\+E\+L\+Z\+W, }
\item[{real, dimension(ilg)}]{E\+V\+L\+O\+S\+T, }
\item[{real, dimension (ilg)}]{R\+L\+O\+S\+T, }
\item[{integer, dimension (ilg)}]{I\+R\+O\+O\+T, }
\item[{integer}]{I\+G, }
\item[{integer}]{I\+L\+G, }
\item[{integer}]{I\+L1, }
\item[{integer}]{I\+L2, }
\item[{integer}]{J\+L, }
\item[{integer}]{N}
\end{DoxyParamCaption}
)}\label{CANVAP_8f_a3041cf9c21766306cba0e7bc1b00161f}

\begin{DoxyParams}{Parameters}
{\em thliq} & Volumetric liquid water content of soil\\
\hline
{\em tbar} & Temperature of soil layer $[K] (T_g)$\\
\hline
{\em qfc} & Transpired water removed from soil layer $[kg m^{-2} s^{-1}]$\\
\hline
{\em htc} & Internal energy change of soil layer due to conduction and/or change in mass $[W m^{-2}] (I_g)$\\
\hline
{\em evap} & Evapotranspiration rate from vegetation canopy $[m s^{-1}]$\\
\hline
{\em subl} & Calculated sublimation rate from vegetation canopy $[m s^{-1}]$\\
\hline
{\em raican} & Intercepted liquid water stored on the canopy $[kg m^{-2}]$\\
\hline
{\em snocan} & Intercepted frozen water stored on the canopy $[kg m^{-2}]$\\
\hline
{\em tcan} & Temperature of vegetation canopy $[K] (T_c)$\\
\hline
{\em zsnow} & Depth of snow pack $[m] (z_g)$\\
\hline
{\em wlost} & Residual amount of water that cannot be supplied by surface stores $[kg m^{-2}]$\\
\hline
{\em chcap} & Heat capacity of vegetation canopy $[J m^{-2} K^{-1}] (C_c)$\\
\hline
{\em qfcf} & Sublimation from frozen water in canopy interception store $[kg m^{-2} s^{-1}]$\\
\hline
{\em qfcl} & Evaporation from liquid water in canopy interception store $[kg m^{-2} s^{-1} ]$\\
\hline
{\em qfn} & Sublimation from snow pack $[kg m^{-2} s^{-1}]$\\
\hline
{\em htcc} & Internal energy change of canopy due to changes in temperature and/or mass $[W m^{-2}] (I_c)$\\
\hline
{\em htcs} & Internal energy change of snow pack due to conduction and/or change in mass $[W m^{-2}] (I_s)$\\
\hline
{\em froot} & Fractional contribution of soil layer to transpiration \mbox{[} \mbox{]}\\
\hline
{\em thpor} & Pore volume in soil layer $[m^3 m^{-3}]$\\
\hline
{\em thlmin} & Residual soil liquid water content remaining after freezing or evaporation $[m^3 m^{-3}]$\\
\hline
{\em delzw} & Permeable depth of soil layer $[m] (\Delta z_{g,w})$\\
\hline
{\em fi} & Fractional coverage of subarea in question on modelled area $[ ] (X_i)$\\
\hline
{\em cmass} & Mass of vegetation canopy $[kg m^{-2}]$\\
\hline
{\em tsnow} & Temperature of the snow pack \mbox{[}C\mbox{]}\\
\hline
{\em hcpsno} & Heat capacity of snow pack $[J m^{-3} K^{-1}] (C_s)$\\
\hline
{\em rhosno} & Density of snow pack $[kg m^{-3}]$ \\
\hline
\end{DoxyParams}
The calculated fluxes of liquid and frozen water from the canopy to the overlying air, obtained as outputs of W\+P\+R\+E\+P, are applied to the liquid and frozen intercepted water stores on the vegetation canopy, and to the liquid and frozen moisture stores at the surface and in the soil. Since there may not be sufficient water in one or more of these stores to sustain the calculated rate over the whole time step, a hierarchy of operations is followed as described below. The change of internal energy H\+T\+C in the canopy, snow and soil layers as a result of these processes is calculated as the difference in H\+T\+C between the beginning and end of the subroutine\+: \[ \Delta I_c = X_i \Delta (C_c T_c )/ \Delta t \] \[ \Delta I_s = X_i \Delta (C_s T_s z_s )/ \Delta t \] where the C terms represent volumetric heat capacities and the T terms temperatures of the canopy and snow pack, $\Delta t$ is the length of the time step, $z_s$ the snow depth, and $X_i$ the fractional coverage of the subarea under consideration relative to the modelled area. For the soil layers, since only the liquid water content is affected by these calculations, the change in internal energy of each layer is calculated from the change in liquid water content $\theta_l$ as\+: \[ \Delta I_g = X_i C_w \Delta z_{g,w} \Delta (T_g \theta_l )/ \Delta t \]

Sublimation is addressed first. The predicted mass of sublimated water S\+L\+O\+S\+T is calculated and compared to the frozen water in the canopy interception store, S\+N\+O\+C\+A\+N. If S\+L\+O\+S\+T $\leq$ S\+N\+O\+C\+A\+N, all of the sublimated water is subtracted from S\+N\+O\+C\+A\+N. If not, the excess sublimation is calculated as S\+L\+O\+S\+T-\/\+S\+N\+O\+C\+A\+N, Q\+F\+C\+F is corrected for the canopy sublimation difference, and S\+N\+O\+C\+A\+N is set to zero. Next, the new value of S\+L\+O\+S\+T is compared to the snowpack mass, calculated as Z\+S\+N\+O\+W$\ast$\+R\+H\+O\+S\+N\+O. If S\+L\+O\+S\+T $\leq$ Z\+S\+N\+O\+W$\ast$\+R\+H\+O\+S\+N\+O, all of the remaining sublimated water is taken from the snow pack, and Q\+F\+N is modified to reflect this loss. Otherwise, the excess sublimation is calculated as S\+L\+O\+S\+T -\/ Z\+S\+N\+O\+W$\ast$\+R\+H\+O\+S\+N\+O, Q\+F\+N is adjusted accordingly, and Z\+S\+N\+O\+W is set to zero. There now remain no further frozen moisture stores from which sublimated water can be taken (frozen water in the soil is assumed to be immobile), so the remaining energy that had been assigned to sublimation is assigned to canopy evaporation instead, and Q\+F\+C\+L is duly recalculated. This means, however, that a small imbalance will arise in the water budget owing to the difference between the latent heats of sublimation and evaporation. This imbalance is assigned to the housekeeping variable W\+L\+O\+S\+T.

Now canopy evaporation is addressed. It is assumed that all intercepted liquid water evaporates before transpiration begins, since there is a canopy stomatal resistance associated with transpiration and there is none associated with evaporation. The predicted mass of evaporated water R\+L\+O\+S\+T is calculated and compared to the liquid water in the canopy interception store, R\+A\+I\+C\+A\+N. If R\+L\+O\+S\+T $\leq$ R\+A\+I\+C\+A\+N, all of the evaporated water is subtracted from R\+A\+I\+C\+A\+N. If not, the excess evaporation is calculated as R\+L\+O\+S\+T -\/ R\+A\+I\+C\+A\+N, and Q\+F\+C\+L is corrected for the canopy evaporation difference. This excess evaporation is now treated as transpiration. An initial check is done by referring to the diagnostic flag I\+R\+O\+O\+T, which was set to 1 at the beginning of the subroutine if there was water available for transpiration in any of the soil layers. If I\+R\+O\+O\+T is zero, no transpiration can occur and the excess evaporation is stored in the temporary variable E\+V\+L\+O\+S\+T. 